app.py:index: Request: Index page loaded.
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'hi', AI-detected intent: general_faq
2025-07-09 12:23:13,547 - repositories.py:get_db - ERROR - Database Connection:get_db: Database connection error: ('08001', '[08001] [Microsoft][ODBC Driver 17 for SQL Server]Named Pipes Provider: Could not open a connection to SQL Server [1326].  (1326) (SQLDriverConnect); [08001] [Microsoft][ODBC Driver 17 for SQL Server]Login timeout expired (0); [08001] [Microsoft][ODBC Driver 17 for SQL Server]A network-related or instance-specific error has occurred while establishing a connection to SQL Server. Server is not found or not accessible. Check if instance name is correct and if SQL Server is configured to allow remote connections. For more information see SQL Server Books Online. (1326)')
2025-07-09 12:23:13,547 - repositories.py:search_faqs - ERROR - FaqRepository:search_faqs: No database connection available.
app.py:chat: Request: Bot response: Oops! It seems I'm having a little trouble dialing up my knowledge base right now. Please try again in a moment!
app.py:chat: Request: User query: 'where is my order', AI-detected intent: order
app.py:chat: Request: Bot response: Looks like our order scroll is temporarily misplaced. Can you check back in a little while?
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'hey', AI-detected intent: general_faq
2025-07-09 12:27:22,378 - repositories.py:get_db - ERROR - Database Connection:get_db: Database connection error: ('08001', '[08001] [Microsoft][ODBC Driver 17 for SQL Server]Named Pipes Provider: Could not open a connection to SQL Server [1326].  (1326) (SQLDriverConnect); [08001] [Microsoft][ODBC Driver 17 for SQL Server]Login timeout expired (0); [08001] [Microsoft][ODBC Driver 17 for SQL Server]A network-related or instance-specific error has occurred while establishing a connection to SQL Server. Server is not found or not accessible. Check if instance name is correct and if SQL Server is configured to allow remote connections. For more information see SQL Server Books Online. (1326)')
2025-07-09 12:27:22,378 - repositories.py:search_faqs - ERROR - FaqRepository:search_faqs: No database connection available.
app.py:chat: Request: Bot response: Oops! It seems I'm having a little trouble dialing up my knowledge base right now. Please try again in a moment!
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'hey', AI-detected intent: general_faq
2025-07-09 16:57:59,998 - repositories.py:get_db - ERROR - Database Connection:get_db: Database connection error: ('08001', '[08001] [Microsoft][ODBC Driver 17 for SQL Server]Named Pipes Provider: Could not open a connection to SQL Server [64].  (64) (SQLDriverConnect); [08001] [Microsoft][ODBC Driver 17 for SQL Server]Login timeout expired (0); [08001] [Microsoft][ODBC Driver 17 for SQL Server]A network-related or instance-specific error has occurred while establishing a connection to SQL Server. Server is not found or not accessible. Check if instance name is correct and if SQL Server is configured to allow remote connections. For more information see SQL Server Books Online. (64)')
2025-07-09 16:57:59,999 - repositories.py:search_faqs - ERROR - FaqRepository:search_faqs: No database connection available.
app.py:chat: Request: Bot response: Oops! It seems I'm having a little trouble dialing up my knowledge base right now. Please try again in a moment!
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'hey', AI-detected intent: general_faq
2025-07-09 17:56:54,396 - repositories.py:get_db - ERROR - Database Connection:get_db: Database connection error: ('08001', '[08001] [Microsoft][ODBC Driver 17 for SQL Server]Named Pipes Provider: Could not open a connection to SQL Server [64].  (64) (SQLDriverConnect); [08001] [Microsoft][ODBC Driver 17 for SQL Server]Login timeout expired (0); [08001] [Microsoft][ODBC Driver 17 for SQL Server]A network-related or instance-specific error has occurred while establishing a connection to SQL Server. Server is not found or not accessible. Check if instance name is correct and if SQL Server is configured to allow remote connections. For more information see SQL Server Books Online. (64)')
2025-07-09 17:56:54,396 - repositories.py:search_faqs - ERROR - FaqRepository:search_faqs: No database connection available.
app.py:chat: Request: Bot response: Oops! It seems I'm having a little trouble dialing up my knowledge base right now. Please try again in a moment!
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'hey', AI-detected intent: general_faq
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'hey', AI-detected intent: general_faq
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'hey', AI-detected intent: general_faq
2025-07-09 18:17:23,063 - repositories.py:get_db - ERROR - Database Connection:get_db: Database connection error: ('08001', '[08001] [Microsoft][ODBC Driver 17 for SQL Server]Named Pipes Provider: Could not open a connection to SQL Server [64].  (64) (SQLDriverConnect); [08001] [Microsoft][ODBC Driver 17 for SQL Server]Login timeout expired (0); [08001] [Microsoft][ODBC Driver 17 for SQL Server]A network-related or instance-specific error has occurred while establishing a connection to SQL Server. Server is not found or not accessible. Check if instance name is correct and if SQL Server is configured to allow remote connections. For more information see SQL Server Books Online. (64)')
2025-07-09 18:17:23,067 - repositories.py:search_faqs - ERROR - FaqRepository:search_faqs: No database connection available.
app.py:chat: Request: Bot response: Hello! Welcome to Bookswagon customer service. How can I assist you today? Please let me know if you have any questions about our services, your order, or anything else related to Bookswagon. If you're inquiring about an order, please have your order number (starting with 'BW') ready.
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'hey', AI-detected intent: general_faq
2025-07-09 18:19:48,887 - repositories.py:get_db - ERROR - Database Connection:get_db: Database connection error: ('08001', '[08001] [Microsoft][ODBC Driver 17 for SQL Server]Named Pipes Provider: Could not open a connection to SQL Server [64].  (64) (SQLDriverConnect); [08001] [Microsoft][ODBC Driver 17 for SQL Server]Login timeout expired (0); [08001] [Microsoft][ODBC Driver 17 for SQL Server]A network-related or instance-specific error has occurred while establishing a connection to SQL Server. Server is not found or not accessible. Check if instance name is correct and if SQL Server is configured to allow remote connections. For more information see SQL Server Books Online. (64)')
2025-07-09 18:19:48,887 - repositories.py:search_faqs - ERROR - FaqRepository:search_faqs: No database connection available.
app.py:chat: Request: Bot response: Hello! Welcome to Bookswagon customer service. How can I assist you today? Let me know if you have any questions about our services, policies, or need help with an order (please provide your order number starting with 'BW' if it's order-related).
app.py:chat: Request: User query: 'suggest me harry potter books', AI-detected intent: recommend_books
app.py:chat: Request: Bot response: Oops! Our book shelf is a bit jammed right now. Try your recommendation request again in a moment!
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'hey', AI-detected intent: general_faq
2025-07-09 18:21:46,854 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-09 18:21:46,854 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'hey' with keywords: ('hey',)
2025-07-09 18:21:47,003 - repositories.py:search_faqs - ERROR - FaqRepository:search_faqs: Error searching FAQs for query 'hey': ('42S02', "[42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Invalid object name 'Table_FAQ'. (208) (SQLExecDirectW); [42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)")
app.py:chat: Request: Bot response: Hello! I'm Vidya from Bookswagon's customer service. How can I assist you today? Let me know if you have any questions about our services, your order, or anything else related to Bookswagon.  

Is there something specific you'd like help with?
app.py:chat: Request: User query: 'suggest me mystery novels', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'suggest me mystery novels', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n\n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: suggest me mystery novels"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (Category_Name LIKE '%Mystery%' OR Product_Title LIKE '%mystery%') AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2561
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'suggest me mystery novels'. Current cache size: 1
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 8.1337 seconds.
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'hey suggest me some mystery novels', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'hey suggest me some mystery novels', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n\n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: hey suggest me some mystery novels"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (Category_Name LIKE '%Mystery%' OR Product_Title LIKE '%mystery%') AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2563
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'hey suggest me some mystery novels'. Current cache size: 1
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 8.0832 seconds.
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'where is my order', AI-detected intent: order
controllers.py:process_chat_message: Request: general query: Using AI for general response/asking for order number.
2025-07-09 19:03:34,630 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'where is my order' with keywords: ('is', 'my', 'order', 'where')
2025-07-09 19:03:34,662 - repositories.py:search_faqs - ERROR - FaqRepository:search_faqs: Error searching FAQs for query 'where is my order': ('42S02', "[42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Invalid object name 'Table_FAQ'. (208) (SQLExecDirectW); [42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)")
controllers.py:process_chat_message: ChatController:process_chat_message: Bot response: Could you please provide your order number so I can check the status for you? Order numbers typically start with 'BW'. Once you share that, I'll be able to assist you with tracking your order.
app.py:chat: Request: Bot response: Could you please provide your order number so I can check the status for you? Order numbers typically start with 'BW'. Once you share that, I'll be able to assist you with tracking your order.
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'hey', AI-detected intent: general_faq
2025-07-10 11:03:49,976 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-10 11:03:49,992 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'hey' with keywords: ('hey',)
2025-07-10 11:03:50,041 - repositories.py:search_faqs - ERROR - FaqRepository:search_faqs: Error searching FAQs for query 'hey': ('42S02', "[42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Invalid object name 'Table_FAQ'. (208) (SQLExecDirectW); [42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)")
app.py:chat: Request: Bot response: Hello! Welcome to Bookswagon customer service. How can I assist you today? Please let me know if you have any questions about our services, orders, or policies. If you're inquiring about a specific order, kindly share your order number (typically starting with 'BW') so I can help you better.
app.py:chat: Request: User query: 'reccomend some horror books', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'reccomend some horror books', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n\n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: reccomend some horror books"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (Category_Name LIKE '%Horror%' OR Product_Title LIKE '%horror%') AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2562
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'reccomend some horror books'. Current cache size: 1
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 6.8501 seconds.
app.py:chat: Request: User query: 'Suggest some horror books', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'Suggest some horror books', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n\n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: Suggest some horror books"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (Category_Name LIKE '%Horror%' OR Product_Title LIKE '%horror%') AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2559
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'Suggest some horror books'. Current cache size: 2
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 6.7231 seconds.
app.py:chat: Request: User query: 'Suggest some horror books', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'Suggest some horror books', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n\n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: Suggest some horror books"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (Category_Name LIKE '%Horror%' OR Product_Title LIKE '%horror%') AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2559
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'Suggest some horror books'. Current cache size: 1
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 7.2460 seconds.
app.py:chat: Request: User query: 'Suggest some horror books', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Cache hit for user query: 'Suggest some horror books'.
app.py:chat: Request: User query: 'Suggest some horror books', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'Suggest some horror books', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n\n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: Suggest some horror books"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (Category_Name LIKE '%Horror%' OR Product_Title LIKE '%horror%') AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2559
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'Suggest some horror books'. Current cache size: 1
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 7.7942 seconds.
app.py:chat: Request: User query: 'Suggest some horror books', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Cache hit for user query: 'Suggest some horror books'.
app.py:chat: Request: User query: 'Suggest some horror books', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Cache hit for user query: 'Suggest some horror books'.
app.py:chat: Request: User query: 'where is my order', AI-detected intent: order
app.py:chat: Request: Bot response: LOGIN_REQUIRED: Please log in to view your order details.
app.py:chat: Request: User query: 'where is my order', AI-detected intent: order
app.py:chat: Request: Bot response: LOGIN_REQUIRED: Please log in to view your order details.
app.py:chat: Request: User query: 'suggest sone horror books', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'suggest sone horror books', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n\n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: suggest sone horror books"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (Category_Name LIKE '%Horror%' OR Product_Title LIKE '%horror%') AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2560
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'suggest sone horror books'. Current cache size: 2
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 7.1247 seconds.
app.py:chat: Request: User query: 'suggest sone horror books', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Cache hit for user query: 'suggest sone horror books'.
app.py:chat: Request: User query: 'where is my order', AI-detected intent: order
controllers.py:process_chat_message: Request: general query: Using AI for general response/asking for order number.
2025-07-10 11:21:48,593 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'where is my order' with keywords: ('is', 'my', 'order', 'where')
2025-07-10 11:21:48,597 - repositories.py:search_faqs - ERROR - FaqRepository:search_faqs: Error searching FAQs for query 'where is my order': ('42S02', "[42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Invalid object name 'Table_FAQ'. (208) (SQLExecDirectW); [42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)")
controllers.py:process_chat_message: ChatController:process_chat_message: Bot response: Could you please provide your order number so I can assist you? Order numbers typically start with 'BW'. Once you share the order number, I can check the status and provide tracking details if available. 

Is there anything else I can help you with?
app.py:chat: Request: Bot response: Could you please provide your order number so I can assist you? Order numbers typically start with 'BW'. Once you share the order number, I can check the status and provide tracking details if available. 

Is there anything else I can help you with?
app.py:chat: Request: User query: 'where is my order BW25070831241045', AI-detected intent: order
2025-07-10 12:30:47,175 - repositories.py:fetch_order_by_id - INFO - OrderRepository:fetch_order_by_id: Executing query for order ID: BW25070831241045 and User ID: 151112
2025-07-10 12:30:47,200 - repositories.py:fetch_order_by_id - ERROR - OrderRepository:fetch_order_by_id: Error fetching order data for ID BW25070831241045: ('42S02', "[42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Invalid object name 'View_GetOrderDetailListUpdatedNew_Chat'. (208) (SQLExecDirectW); [42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)")
controllers.py:process_chat_message: Request: general query: Invalid order ID or access denied for order BW25070831241045 and user 151112
app.py:chat: Request: Bot response: I couldn't find any order with ID BW25070831241045 associated with your account. Please check the order number and try again.
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'where is my order BW23092108171821', AI-detected intent: order
2025-07-10 14:03:59,852 - repositories.py:fetch_order_by_id - INFO - OrderRepository:fetch_order_by_id: Executing query for order ID: BW23092108171821 and User ID: 151112
2025-07-10 14:03:59,857 - repositories.py:fetch_order_by_id - ERROR - OrderRepository:fetch_order_by_id: Error fetching order data for ID BW23092108171821: ('42S02', "[42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Invalid object name 'View_GetOrderDetailListUpdatedNew_Chat'. (208) (SQLExecDirectW); [42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)")
controllers.py:process_chat_message: Request: general query: Invalid order ID or access denied for order BW23092108171821 and user 151112
app.py:chat: Request: Bot response: I couldn't find any order with ID BW23092108171821 associated with your account. Please check the order number and try again.
app.py:chat: Request: User query: 'where is my order BW23092108171821', AI-detected intent: order
2025-07-10 14:41:23,308 - repositories.py:fetch_order_by_id - INFO - OrderRepository:fetch_order_by_id: Executing query for order ID: BW23092108171821 and User ID: 151112
2025-07-10 14:41:32,241 - repositories.py:fetch_order_by_id - INFO - OrderRepository:fetch_order_by_id: Successfully fetched order: BW23092108171821 with 1 books.
controllers.py:process_chat_message: Request: general query: Found and using order context for: BW23092108171821 for user 151112
controllers.py:process_chat_message: Request: general query: Using AI for order summary/general query within found order context.
2025-07-10 14:41:32,243 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'where is my order BW23092108171821' with keywords: ('bw23092108171821', 'is', 'my', 'order', 'where')
2025-07-10 14:41:32,387 - repositories.py:search_faqs - ERROR - FaqRepository:search_faqs: Error searching FAQs for query 'where is my order BW23092108171821': ('42S02', "[42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Invalid object name 'Table_FAQ'. (208) (SQLExecDirectW); [42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)")
controllers.py:process_chat_message: ChatController:process_chat_message: Bot response: I can see that your order BW23092108171821 was placed on 21/09/2023 and its current status shows as "Cancelled". Since the order has been cancelled, there will be no delivery for this order. 

The total amount for this order was INR 0, which indicates the payment was either refunded or not charged in the first place. 

I understand this might not be the update you were expecting. If you need any further clarification about the cancellation or wish to place a new order, I'd be happy to assist. 

Would you like help with anything else regarding Bookswagon services?
app.py:chat: Request: Bot response: I can see that your order BW23092108171821 was placed on 21/09/2023 and its current status shows as "Cancelled". Since the order has been cancelled, there will be no delivery for this order. 

The total amount for this order was INR 0, which indicates the payment was either refunded or not charged in the first place. 

I understand this might not be the update you were expecting. If you need any further clarification about the cancellation or wish to place a new order, I'd be happy to assist. 

Would you like help with anything else regarding Bookswagon services?
app.py:index: Request: Index page loaded.
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'comic books', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'comic books', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n\n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: comic books"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (Category_Name LIKE '%Comic%' OR Product_Title LIKE '%comic%') AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2557
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'comic books'. Current cache size: 1
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 6.1765 seconds.
app.py:chat: Request: User query: 'where is my order', AI-detected intent: order
app.py:chat: Request: Bot response: LOGIN_REQUIRED: Please log in to view your order details.
app.py:chat: Request: User query: 'comic books', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Cache hit for user query: 'comic books'.
app.py:chat: Request: User query: 'where is my order', AI-detected intent: order
controllers.py:process_chat_message: Request: chat history on: Using AI for general response/asking for order number.
2025-07-11 17:40:01,129 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'where is my order' with keywords: ('is', 'my', 'order', 'where')
2025-07-11 17:40:01,238 - repositories.py:search_faqs - ERROR - FaqRepository:search_faqs: Error searching FAQs for query 'where is my order': ('42S02', "[42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Invalid object name 'Table_FAQ'. (208) (SQLExecDirectW); [42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)")
controllers.py:process_chat_message: ChatController:process_chat_message: Bot response: Could you please provide your order number so I can check the status for you? Order numbers typically start with 'BW'. Once you share the number, I'll be able to assist you with your order details.  

Is there anything else I can help you with?
app.py:chat: Request: Bot response: Could you please provide your order number so I can check the status for you? Order numbers typically start with 'BW'. Once you share the number, I'll be able to assist you with your order details.  

Is there anything else I can help you with?
app.py:chat: Request: User query: 'where is my order', AI-detected intent: order
controllers.py:process_chat_message: Request: general query: Using AI for general response/asking for order number.
controllers.py:process_chat_message: ChatController:process_chat_message: Bot response: Could you please provide your order number so I can assist you? Order numbers typically start with 'BW'. Once you share the order number, I can check the status and provide you with the relevant details. 

Is there anything else I can help you with?
app.py:chat: Request: Bot response: Could you please provide your order number so I can assist you? Order numbers typically start with 'BW'. Once you share the order number, I can check the status and provide you with the relevant details. 

Is there anything else I can help you with?
app.py:chat: Request: User query: 'here is my order number BW25042910981229', AI-detected intent: order
2025-07-11 17:41:42,071 - repositories.py:fetch_order_by_id - INFO - OrderRepository:fetch_order_by_id: Executing query for order ID: BW25042910981229 and User ID: 151112
2025-07-11 17:41:44,884 - repositories.py:fetch_order_by_id - INFO - OrderRepository:fetch_order_by_id: Successfully fetched order: BW25042910981229 with 1 books.
controllers.py:process_chat_message: Request: chat history on: Found and using order context for: BW25042910981229 for user 151112
controllers.py:process_chat_message: Request: chat history on: Using AI for order summary/general query within found order context.
2025-07-11 17:41:44,884 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'here is my order number BW25042910981229' with keywords: ('bw25042910981229', 'here', 'is', 'my', 'number', 'order')
2025-07-11 17:41:44,931 - repositories.py:search_faqs - ERROR - FaqRepository:search_faqs: Error searching FAQs for query 'here is my order number BW25042910981229': ('42S02', "[42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Invalid object name 'Table_FAQ'. (208) (SQLExecDirectW); [42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)")
controllers.py:process_chat_message: ChatController:process_chat_message: Bot response: Thank you for providing your order number. I can see that your order BW25042910981229, containing Questions And Answers- The Canterville Ghost PB, has been shipped.  

Tracking Details:  
- Tracking Number: testingbipin  
- Expected Delivery: Between May 8, 2025, and May 10, 2025  

To track your order, please visit the Bookswagon website and enter your tracking number in the tracking section.  

If you have any further questions or need assistance, feel free to ask.  

Is there anything else I can help you with?
app.py:chat: Request: Bot response: Thank you for providing your order number. I can see that your order BW25042910981229, containing Questions And Answers- The Canterville Ghost PB, has been shipped.  

Tracking Details:  
- Tracking Number: testingbipin  
- Expected Delivery: Between May 8, 2025, and May 10, 2025  

To track your order, please visit the Bookswagon website and enter your tracking number in the tracking section.  

If you have any further questions or need assistance, feel free to ask.  

Is there anything else I can help you with?
app.py:chat: Request: User query: 'here is my another order BW25070831241045', AI-detected intent: order
2025-07-11 17:44:10,884 - repositories.py:fetch_order_by_id - INFO - OrderRepository:fetch_order_by_id: Executing query for order ID: BW25070831241045 and User ID: 151112
2025-07-11 17:44:10,884 - repositories.py:fetch_order_by_id - INFO - OrderRepository:fetch_order_by_id: No order found for ID: BW25070831241045 and User ID: 151112
controllers.py:process_chat_message: Request: chat history on: Invalid order ID or access denied for order BW25070831241045 and user 151112
app.py:chat: Request: Bot response: I couldn't find any order with ID BW25070831241045 associated with your account. Please check the order number and try again.
app.py:chat: Request: User query: 'what is my order status BW25042910981229', AI-detected intent: order
2025-07-11 17:53:07,153 - repositories.py:fetch_order_by_id - INFO - OrderRepository:fetch_order_by_id: Executing query for order ID: BW25042910981229 and User ID: 162268
2025-07-11 17:53:07,184 - repositories.py:fetch_order_by_id - INFO - OrderRepository:fetch_order_by_id: No order found for ID: BW25042910981229 and User ID: 162268
controllers.py:process_chat_message: Request: general query: Invalid order ID or access denied for order BW25042910981229 and user 162268
app.py:chat: Request: Bot response: I couldn't find any order with ID BW25042910981229 associated with your account. Please check the order number and try again.
app.py:chat: Request: User query: 'fiction books', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'fiction books', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n\n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: fiction books"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2546
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'fiction books'. Current cache size: 2
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 6.5313 seconds.
app.py:chat: Request: User query: 'what is my website name and url', AI-detected intent: general_faq
2025-07-11 17:55:47,343 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-11 17:55:47,343 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'what is my website name and url' with keywords: ('and', 'is', 'my', 'name', 'url', 'website', 'what')
2025-07-11 17:55:47,374 - repositories.py:search_faqs - ERROR - FaqRepository:search_faqs: Error searching FAQs for query 'what is my website name and url': ('42S02', "[42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Invalid object name 'Table_FAQ'. (208) (SQLExecDirectW); [42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)")
app.py:chat: Request: Bot response: Your website name is Bookswagon and the URL is www.bookswagon.com  

Is there anything else I can help you with?
app.py:chat: Request: User query: 'sujest contactus page', AI-detected intent: general_faq
2025-07-11 17:56:42,497 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-11 17:56:42,497 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'sujest contactus page' with keywords: ('contactus', 'page', 'sujest')
2025-07-11 17:56:42,513 - repositories.py:search_faqs - ERROR - FaqRepository:search_faqs: Error searching FAQs for query 'sujest contactus page': ('42S02', "[42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Invalid object name 'Table_FAQ'. (208) (SQLExecDirectW); [42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)")
app.py:chat: Request: Bot response: Here's the contact information for Bookswagon:  

Customer Care Email: support@bookswagon.com  

For urgent assistance, you can reach out to our customer care team via email.  

If you need to visit the Contact Us page directly, you can find it on our website at:  
[www.bookswagon.com/contactus](https://www.bookswagon.com/contactus)  

Let me know if you need help with anything else!
app.py:chat: Request: User query: 'whats my website name and url', AI-detected intent: general_faq
2025-07-11 18:01:41,551 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-11 18:01:41,551 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'whats my website name and url' with keywords: ('and', 'my', 'name', 'url', 'website', 'whats')
2025-07-11 18:01:41,553 - repositories.py:search_faqs - ERROR - FaqRepository:search_faqs: Error searching FAQs for query 'whats my website name and url': ('42S02', "[42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Invalid object name 'Table_FAQ'. (208) (SQLExecDirectW); [42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)")
app.py:chat: Request: Bot response: I'm here to assist with Bookswagon-related customer service queries. Your website name is Bookswagon, but I don't have access to specific website URLs in my current system. 

Is there anything else I can help you with regarding Bookswagon services?
app.py:chat: Request: User query: 'what is my website name and url', AI-detected intent: general_faq
2025-07-11 18:03:04,323 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-11 18:03:04,324 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'what is my website name and url' with keywords: ('and', 'is', 'my', 'name', 'url', 'website', 'what')
2025-07-11 18:03:04,326 - repositories.py:search_faqs - ERROR - FaqRepository:search_faqs: Error searching FAQs for query 'what is my website name and url': ('42S02', "[42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Invalid object name 'Table_FAQ'. (208) (SQLExecDirectW); [42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)")
app.py:chat: Request: Bot response: Your website name is Bookswagon. The website URL is www.bookswagon.com

Is there anything else I can help you with?
app.py:chat: Request: User query: 'whats my website name and url', AI-detected intent: general_faq
app.py:chat: Request: Bot response: I'm here to assist with Bookswagon-related customer service queries. Your website name is Bookswagon, but I don't have access to specific website URLs in my current system. You can visit the Bookswagon website through your preferred search engine or by typing "Bookswagon" directly in your browser's address bar. 

Is there anything else I can help you with regarding Bookswagon services?
app.py:chat: Request: User query: 'whats my website name and url', AI-detected intent: general_faq
app.py:chat: Request: Bot response: I'm here to assist with Bookswagon-related customer service queries. Your website name is Bookswagon, but I don't have access to specific URLs in our database. You can visit our website by searching for "Bookswagon" in your preferred search engine. 

Is there anything else I can help you with regarding Bookswagon services?
app.py:chat: Request: User query: 'what is my website name and url', AI-detected intent: general_faq
app.py:chat: Request: Bot response: Your website name is Bookswagon. However, I don't have access to specific URLs in our system. You can visit our website by searching for "Bookswagon" in any search engine or typing it directly in your browser's address bar.  

Let me know if you need help with anything else related to Bookswagon services.
app.py:chat: Request: User query: 'what is my website name and url', AI-detected intent: general_faq
app.py:chat: Request: Bot response: Your website name is Bookswagon. The URL is www.bookswagon.com

Is there anything else I can help you with?
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'whats my website name and url', AI-detected intent: general_faq
2025-07-11 18:08:02,660 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-11 18:08:02,660 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'whats my website name and url' with keywords: ('and', 'my', 'name', 'url', 'website', 'whats')
2025-07-11 18:08:02,661 - repositories.py:search_faqs - ERROR - FaqRepository:search_faqs: Error searching FAQs for query 'whats my website name and url': ('42S02', "[42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Invalid object name 'Table_FAQ'. (208) (SQLExecDirectW); [42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)")
app.py:chat: Request: Bot response: I'm here to assist with Bookswagon-related customer service queries. Your website name is Bookswagon, and the URL is www.bookswagon.com Is there anything else I can help you with regarding Bookswagon services?
app.py:chat: Request: User query: 'what is my website name and url', AI-detected intent: general_faq
2025-07-11 18:08:52,077 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-11 18:08:52,078 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'what is my website name and url' with keywords: ('and', 'is', 'my', 'name', 'url', 'website', 'what')
2025-07-11 18:08:52,082 - repositories.py:search_faqs - ERROR - FaqRepository:search_faqs: Error searching FAQs for query 'what is my website name and url': ('42S02', "[42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Invalid object name 'Table_FAQ'. (208) (SQLExecDirectW); [42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)")
app.py:chat: Request: User query: 'what is my website name and url', AI-detected intent: general_faq
app.py:chat: Request: Bot response: Your website name is Bookswagon. The website URL is www.bookswagon.com 

Is there anything else I can help you with?
app.py:chat: Request: Bot response: Your website name is Bookswagon. The URL for Bookswagon is www.bookswagon.com 

Is there anything else I can help you with?
app.py:chat: Request: User query: 'what is my website name and url', AI-detected intent: general_faq
2025-07-11 18:10:40,217 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-11 18:10:40,219 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'what is my website name and url' with keywords: ('and', 'is', 'my', 'name', 'url', 'website', 'what')
2025-07-11 18:10:40,221 - repositories.py:search_faqs - ERROR - FaqRepository:search_faqs: Error searching FAQs for query 'what is my website name and url': ('42S02', "[42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Invalid object name 'Table_FAQ'. (208) (SQLExecDirectW); [42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)")
app.py:chat: Request: Bot response: Your website name is Bookswagon. The URL for Bookswagon is www.bookswagon.com

Is there anything else I can help you with?
app.py:chat: Request: User query: 'what is my website name and url', AI-detected intent: general_faq
2025-07-11 18:11:36,114 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-11 18:11:36,114 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'what is my website name and url' with keywords: ('and', 'is', 'my', 'name', 'url', 'website', 'what')
2025-07-11 18:11:36,117 - repositories.py:search_faqs - ERROR - FaqRepository:search_faqs: Error searching FAQs for query 'what is my website name and url': ('42S02', "[42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Invalid object name 'Table_FAQ'. (208) (SQLExecDirectW); [42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)")
app.py:chat: Request: Bot response: Your website name is Bookswagon. The URL for the Bookswagon website is www.bookswagon.com 

Is there anything else I can help you with?

app.py:chat: Request: User query: 'what is my website name and url', AI-detected intent: general_faq
2025-07-11 18:12:50,332 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-11 18:12:50,334 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'what is my website name and url' with keywords: ('and', 'is', 'my', 'name', 'url', 'website', 'what')
2025-07-11 18:12:50,337 - repositories.py:search_faqs - ERROR - FaqRepository:search_faqs: Error searching FAQs for query 'what is my website name and url': ('42S02', "[42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Invalid object name 'Table_FAQ'. (208) (SQLExecDirectW); [42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)")
app.py:chat: Request: Bot response: Your website name is Bookswagon. The URL is www.bookswagon.com

Is there anything else I can help you with?
app.py:chat: Request: User query: 'what is my website name and url', AI-detected intent: general_faq
app.py:chat: Request: Bot response: Your website name is Bookswagon. The URL for Bookswagon is www.bookswagon.com 

Is there anything else I can assist you with?
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'what is my website name and url', AI-detected intent: general_faq
app.py:chat: Request: Bot response: Your website name is Bookswagon. The URL is www.bookswagon.com 

Is there anything else I can help you with?
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'what is my website name and url', AI-detected intent: general_faq
2025-07-11 18:18:42,973 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-11 18:18:42,974 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'what is my website name and url' with keywords: ('and', 'is', 'my', 'name', 'url', 'website', 'what')
2025-07-11 18:18:42,976 - repositories.py:search_faqs - ERROR - FaqRepository:search_faqs: Error searching FAQs for query 'what is my website name and url': ('42S02', "[42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Invalid object name 'Table_FAQ'. (208) (SQLExecDirectW); [42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)")
app.py:chat: Request: Bot response: Your website name is Bookswagon. The URL for Bookswagon is www.bookswagon.com 

Is there anything else I can help you with?
app.py:chat: Request: User query: 'what is my website name and url', AI-detected intent: general_faq
2025-07-11 18:21:17,575 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-11 18:21:17,576 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'what is my website name and url' with keywords: ('and', 'is', 'my', 'name', 'url', 'website', 'what')
2025-07-11 18:21:17,579 - repositories.py:search_faqs - ERROR - FaqRepository:search_faqs: Error searching FAQs for query 'what is my website name and url': ('42S02', "[42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Invalid object name 'Table_FAQ'. (208) (SQLExecDirectW); [42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)")
app.py:chat: Request: Bot response: Your website name is Bookswagon, and the URL is www.bookswagon.com  

Let me know if you need assistance with anything else.
app.py:chat: Request: User query: 'what is my website name and url', AI-detected intent: general_faq
2025-07-11 18:23:28,107 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-11 18:23:28,108 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'what is my website name and url' with keywords: ('and', 'is', 'my', 'name', 'url', 'website', 'what')
2025-07-11 18:23:28,109 - repositories.py:search_faqs - ERROR - FaqRepository:search_faqs: Error searching FAQs for query 'what is my website name and url': ('42S02', "[42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Invalid object name 'Table_FAQ'. (208) (SQLExecDirectW); [42S02] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)")
app.py:chat: Request: Bot response: Your website name is Bookswagon. The URL for the Bookswagon website is www.bookswagon.com. 

Is there anything else I can help you with?
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'hey whats up', AI-detected intent: general_faq
2025-07-12 11:14:28,523 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-12 11:14:28,523 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'hey whats up' with keywords: ('hey', 'up', 'whats')
2025-07-12 11:14:28,587 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 92 matching FAQs for query: 'hey whats up' (keywords: ('hey', 'up', 'whats'))
app.py:chat: Request: Bot response: Hello! I'm Vidya from Bookswagon's customer service. How can I assist you today? Let me know if you have any questions about our services, orders, or policies. 

Is there anything specific you'd like help with?
app.py:chat: Request: User query: 'whats the website name and url', AI-detected intent: general_faq
2025-07-12 11:14:53,997 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-12 11:14:54,000 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'whats the website name and url' with keywords: ('and', 'name', 'the', 'url', 'website', 'whats')
2025-07-12 11:14:54,064 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 845 matching FAQs for query: 'whats the website name and url' (keywords: ('and', 'name', 'the', 'url', 'website', 'whats'))
app.py:chat: Request: Bot response: The website name is Bookswagon and the URL is bookswagon.com. 

Is there anything else I can assist you with?
app.py:chat: Request: User query: 'can you reccomend me some gerinimo stilton books', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'can you reccomend me some gerinimo stilton books', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n\n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: can you reccomend me some gerinimo stilton books"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (AuthorName1 LIKE '%Geronimo Stilton%' OR Product_Title LIKE '%Geronimo Stilton%') AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2576
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'can you reccomend me some gerinimo stilton books'. Current cache size: 1
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 6.6157 seconds.
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'hey how are ys', AI-detected intent: general_faq
2025-07-12 11:23:26,896 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-12 11:23:26,897 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'hey how are ys' with keywords: ('are', 'hey', 'how', 'ys')
2025-07-12 11:23:26,947 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 792 matching FAQs for query: 'hey how are ys' (keywords: ('are', 'hey', 'how', 'ys'))
app.py:chat: Request: Bot response: Hello! I'm Vidya, your Bookswagon assistant. I'm here to help you with any questions about our services, orders, or policies. How may I assist you today?
app.py:chat: Request: User query: 'whats my account name', AI-detected intent: general_faq
2025-07-12 11:23:50,409 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-12 11:23:50,409 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'whats my account name' with keywords: ('account', 'my', 'name', 'whats')
2025-07-12 11:23:50,490 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 154 matching FAQs for query: 'whats my account name' (keywords: ('account', 'my', 'name', 'whats'))
app.py:chat: Request: Bot response: To find your account name on Bookswagon, you can log in to your account on the website. Once logged in, your account name should be visible in the "My Account" section under personal information. 

If you need further assistance or cannot locate it, you may contact customer care for help. Would you like me to guide you on how to reach customer care?
app.py:chat: Request: User query: 'cant you tell that?  im already logged in btw', AI-detected intent: general_faq
2025-07-12 11:24:24,711 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-12 11:24:24,712 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'cant you tell that?  im already logged in btw' with keywords: ('already', 'btw', 'cant', 'im', 'in', 'logged', 'tell', 'that?', 'you')
2025-07-12 11:24:24,819 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 871 matching FAQs for query: 'cant you tell that?  im already logged in btw' (keywords: ('already', 'btw', 'cant', 'im', 'in', 'logged', 'tell', 'that?', 'you'))
app.py:chat: Request: Bot response: I notice you're asking for assistance while already logged in. Could you please clarify your specific question or concern so I can help you better? If it's about an order, please provide your order number (typically starting with 'BW') for me to assist you effectively. 

Let me know how I can help, and I'll do my best to provide the information you need.
app.py:chat: Request: User query: 'i wanna know my user id', AI-detected intent: general_faq
2025-07-12 11:25:06,174 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-12 11:25:06,175 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'i wanna know my user id' with keywords: ('i', 'id', 'know', 'my', 'user', 'wanna')
2025-07-12 11:25:06,371 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 1085 matching FAQs for query: 'i wanna know my user id' (keywords: ('i', 'id', 'know', 'my', 'user', 'wanna'))
app.py:chat: Request: Bot response: To assist you with your user ID, I'll need to look up your account details. Could you please provide the email address or phone number associated with your Bookswagon account? This will help me locate your user ID.

Alternatively, you can find your user ID by logging into your Bookswagon account and checking the account details section. 

Let me know if you need any further assistance.
app.py:chat: Request: User query: '8076827331', AI-detected intent: unknown
2025-07-12 11:25:48,404 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-12 11:25:48,405 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: '8076827331' with keywords: ('8076827331',)
2025-07-12 11:25:48,432 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 0 matching FAQs for query: '8076827331' (keywords: ('8076827331',))
app.py:chat: Request: Bot response: I'm here to assist with Bookswagon customer service inquiries. Could you please clarify your question or let me know how I can help you today? If you're inquiring about an order, please provide your order number (typically starting with 'BW') so I can assist you better. 

Is there anything else I can help you with?
app.py:chat: Request: User query: 'okay where is my order then', AI-detected intent: order
app.py:chat: Request: Bot response: LOGIN_REQUIRED: Please log in to view your order details.
app.py:chat: Request: User query: 'i am logged in', AI-detected intent: general_faq
2025-07-12 11:27:48,988 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-12 11:27:48,988 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'i am logged in' with keywords: ('am', 'i', 'in', 'logged')
2025-07-12 11:27:49,044 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 1084 matching FAQs for query: 'i am logged in' (keywords: ('am', 'i', 'in', 'logged'))
app.py:chat: Request: Bot response: Thank you for letting me know you're logged in. How may I assist you with your Bookswagon account today? Please let me know if you have any questions about your orders, wishlist, or account settings. 

If you need help with a specific order, please provide your order number (typically starting with 'BW') so I can assist you further. 

Is there anything else I can help you with?
app.py:chat: Request: User query: 'yes i want to know where my order is', AI-detected intent: order
app.py:chat: Request: Bot response: LOGIN_REQUIRED: Please log in to view your order details.
app.py:chat: Request: User query: 'whats the website url', AI-detected intent: general_faq
2025-07-12 11:28:35,781 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-12 11:28:35,782 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'whats the website url' with keywords: ('the', 'url', 'website', 'whats')
2025-07-12 11:28:35,898 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 761 matching FAQs for query: 'whats the website url' (keywords: ('the', 'url', 'website', 'whats'))
app.py:chat: Request: Bot response: The official website URL for Bookswagon is: https://www.bookswagon.com. 

Let me know if there's anything else I can assist you with.
app.py:chat: Request: User query: 'aur batao kya haal hai', AI-detected intent: unknown
2025-07-12 11:29:35,969 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-12 11:29:35,970 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'aur batao kya haal hai' with keywords: ('aur', 'batao', 'haal', 'hai', 'kya')
2025-07-12 11:29:36,087 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 11 matching FAQs for query: 'aur batao kya haal hai' (keywords: ('aur', 'batao', 'haal', 'hai', 'kya'))
app.py:chat: Request: User query: 'mujhe kitaabe chayiye', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'mujhe kitaabe chayiye', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n\n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: mujhe kitaabe chayiye"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Availability = 'Available' ORDER BY Ranking ASC;, Tokens Used: 2540
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'mujhe kitaabe chayiye'. Current cache size: 1
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 5.3268 seconds.
app.py:chat: Request: User query: 'show me some indian authors', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'show me some indian authors', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n\n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: show me some indian authors"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Indian%' AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2550
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'show me some indian authors'. Current cache size: 2
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 5.4735 seconds.
app.py:chat: Request: User query: 'what about chetan bhagat', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'what about chetan bhagat', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n\n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: what about chetan bhagat"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Chetan Bhagat%' AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2555
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'what about chetan bhagat'. Current cache size: 3
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 5.3648 seconds.
app.py:chat: Request: User query: 'what is my website url', AI-detected intent: general_faq
2025-07-12 11:45:54,888 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-12 11:45:54,889 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'what is my website url' with keywords: ('is', 'my', 'url', 'website', 'what')
2025-07-12 11:45:54,947 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 607 matching FAQs for query: 'what is my website url' (keywords: ('is', 'my', 'url', 'website', 'what'))
app.py:chat: Request: Bot response: The official website URL for Bookswagon is bookswagon.com. 

Is there anything else I can assist you with?
app.py:chat: Request: User query: 'whats your website url', AI-detected intent: general_faq
2025-07-12 11:57:24,397 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-12 11:57:24,398 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'whats your website url' with keywords: ('url', 'website', 'whats', 'your')
2025-07-12 11:57:24,483 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 234 matching FAQs for query: 'whats your website url' (keywords: ('url', 'website', 'whats', 'your'))
app.py:chat: Request: Bot response: The official website URL for Bookswagon is bookswagon.com. 

Let me know if you need any assistance navigating the website or have any other questions.
app.py:chat: Request: User query: 'whats my website url', AI-detected intent: general_faq
2025-07-12 11:59:02,891 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-12 11:59:02,892 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'whats my website url' with keywords: ('my', 'url', 'website', 'whats')
2025-07-12 11:59:02,958 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 216 matching FAQs for query: 'whats my website url' (keywords: ('my', 'url', 'website', 'whats'))
app.py:chat: Request: Bot response: The official website URL for Bookswagon is: bookswagon.com. 

Let me know if you need any assistance with our services.
app.py:chat: Request: User query: 'find fiction books', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'find fiction books', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n\n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: find fiction books"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2547
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'find fiction books'. Current cache size: 1
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 6.1434 seconds.
app.py:chat: Request: User query: 'where is  my order', AI-detected intent: order
app.py:chat: Request: Bot response: LOGIN_REQUIRED: Please log in to view your order details.
app.py:chat: Request: User query: 'websit url', AI-detected intent: general_faq
2025-07-12 12:53:02,670 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-12 12:53:02,671 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'websit url' with keywords: ('url', 'websit')
2025-07-12 12:53:02,729 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 105 matching FAQs for query: 'websit url' (keywords: ('url', 'websit'))
app.py:chat: Request: Bot response: You can check your order status by visiting the official Bookswagon website at: www.bookswagon.com  

To view your order:  
1. Go to the website  
2. Log in to your account  
3. Navigate to "My Account" or "Order History"  

If you need further assistance with a specific order, please provide your order number (starting with 'BW') so I can help you better.  

Let me know if you have any other questions!
app.py:chat: Request: User query: 'what is my webiste url', AI-detected intent: general_faq
2025-07-12 12:53:49,486 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-12 12:53:49,487 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'what is my webiste url' with keywords: ('is', 'my', 'url', 'webiste', 'what')
2025-07-12 12:53:49,547 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 581 matching FAQs for query: 'what is my webiste url' (keywords: ('is', 'my', 'url', 'webiste', 'what'))
app.py:chat: Request: Bot response: The official Bookswagon website URL is:  

www.bookswagon.com  

You can visit this website to:  
- Check your order status (after logging in)  
- Browse books  
- Contact customer support  

If you're asking about tracking a specific order, please provide your order number (starting with 'BW') so I can assist further. Let me know how else I can help!
app.py:chat: Request: User query: 'what is my website url', AI-detected intent: general_faq
2025-07-12 12:57:35,931 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-12 12:57:35,932 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'what is my website url' with keywords: ('is', 'my', 'url', 'website', 'what')
2025-07-12 12:57:36,002 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 607 matching FAQs for query: 'what is my website url' (keywords: ('is', 'my', 'url', 'website', 'what'))
app.py:chat: Request: Bot response: The official website URL for Bookswagon is bookswagon.com. 

Is there anything else I can assist you with?
app.py:chat: Request: User query: 'again', AI-detected intent: general_faq
2025-07-12 12:59:03,047 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-12 12:59:03,048 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'again' with keywords: ('again',)
2025-07-12 12:59:03,080 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 9 matching FAQs for query: 'again' (keywords: ('again',))
app.py:chat: Request: Bot response: The official website URL for Bookswagon is bookswagon.com.  

Let me know if you need help with anything else.
app.py:chat: Request: User query: 'what is my website url', AI-detected intent: general_faq
app.py:chat: Request: Bot response: The official website URL for Bookswagon is bookswagon.com. 

Let me know if you need any assistance with navigating the website or if there's anything else I can help you with.
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'hey', AI-detected intent: general_faq
2025-07-12 13:24:47,841 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-12 13:24:47,841 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'hey' with keywords: ('hey',)
2025-07-12 13:24:47,881 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 14 matching FAQs for query: 'hey' (keywords: ('hey',))
app.py:chat: Request: Bot response: Hello! Welcome to Bookswagon customer service. How may I assist you today? Please let me know if you have any questions about our services, orders, or policies. If you're inquiring about an order, kindly share your order number (typically starting with 'BW') so I can help you better.
app.py:chat: Request: User query: 'what are you', AI-detected intent: general_faq
2025-07-12 13:25:24,386 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-12 13:25:24,386 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'what are you' with keywords: ('are', 'what', 'you')
2025-07-12 13:25:24,446 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 868 matching FAQs for query: 'what are you' (keywords: ('are', 'what', 'you'))
app.py:chat: Request: Bot response: I am Vidya, your friendly and helpful customer service AI assistant for Bookswagon. My role is to assist you with inquiries about Bookswagon's services, policies, and general information. 

How may I assist you today?
app.py:chat: Request: User query: 'i wanna know where my book is', AI-detected intent: order
app.py:chat: Request: Bot response: LOGIN_REQUIRED: Please log in to view your order details.
app.py:chat: Request: User query: 'can you tell me how far is my package has reached', AI-detected intent: order
app.py:chat: Request: Bot response: LOGIN_REQUIRED: Please log in to view your order details.
app.py:chat: Request: User query: 'can you order a book for me?', AI-detected intent: order
app.py:chat: Request: Bot response: LOGIN_REQUIRED: Please log in to view your order details.
app.py:chat: Request: User query: 'where is my order', AI-detected intent: order
app.py:chat: Request: Bot response: LOGIN_REQUIRED: Please log in to view your order details.
app.py:chat: Request: User query: 'where is my order', AI-detected intent: order
app.py:chat: Request: Bot response: LOGIN_REQUIRED: Please log in to view your order details.
app.py:chat: Request: User query: 'where is my order', AI-detected intent: order
controllers.py:process_chat_message: Request: general query: Using AI for general response/asking for order number.
2025-07-12 13:29:50,262 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'where is my order' with keywords: ('is', 'my', 'order', 'where')
2025-07-12 13:29:50,372 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 523 matching FAQs for query: 'where is my order' (keywords: ('is', 'my', 'order', 'where'))
controllers.py:process_chat_message: ChatController:process_chat_message: Bot response: Could you please provide your order number so I can assist you? Order numbers typically start with 'BW'. Once you share the order number, I can check the status for you. 

If you don't have the order number, you can find it in your order confirmation email or by logging into your Bookswagon account and checking under 'My Orders'. 

Let me know how you'd like to proceed.
app.py:chat: Request: Bot response: Could you please provide your order number so I can assist you? Order numbers typically start with 'BW'. Once you share the order number, I can check the status for you. 

If you don't have the order number, you can find it in your order confirmation email or by logging into your Bookswagon account and checking under 'My Orders'. 

Let me know how you'd like to proceed.
app.py:chat: Request: User query: 'what is my website url', AI-detected intent: general_faq
app.py:chat: Request: Bot response: The official website URL for Bookswagon is bookswagon.com.  

Let me know if you need any further assistance.
app.py:chat: Request: User query: 'what is my website url', AI-detected intent: general_faq
app.py:chat: Request: Bot response: The official website URL for Bookswagon is bookswagon.com. 

Let me know if you need any assistance with our services or have any other questions.
app.py:chat: Request: User query: 'fiction books', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'fiction books', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n\n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: fiction books"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2546
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'fiction books'. Current cache size: 2
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 5.7058 seconds.
app.py:chat: Request: User query: 'what is my website url', AI-detected intent: general_faq
app.py:chat: Request: User query: 'hi', AI-detected intent: general_faq
2025-07-14 13:06:45,535 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-14 13:06:45,536 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'hi' with keywords: ('hi',)
2025-07-14 13:06:45,580 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 219 matching FAQs for query: 'hi' (keywords: ('hi',))
app.py:chat: Request: Bot response: Hello! Welcome to Bookswagon. How can I assist you today?
app.py:chat: Request: Bot response: The official website URL for Bookswagon is bookswagon.com. 

Let me know if you need any assistance with navigating the website or any other queries.
app.py:chat: Request: User query: 'hi', AI-detected intent: general_faq
app.py:chat: Request: Bot response: Hello! How can I assist you with your Bookswagon-related query today? Let me know if you have any questions about orders, shipping, returns, or our book catalog.
app.py:chat: Request: User query: 'what is my order status', AI-detected intent: order
app.py:chat: Request: Bot response: LOGIN_REQUIRED: Please log in to view your order details.
app.py:chat: Request: User query: 'Hey Vidya', AI-detected intent: general_faq
2025-07-14 15:11:51,877 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-14 15:11:51,877 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'Hey Vidya' with keywords: ('hey', 'vidya')
2025-07-14 15:11:51,955 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 14 matching FAQs for query: 'Hey Vidya' (keywords: ('hey', 'vidya'))
app.py:chat: Request: Bot response: Hello! How can I assist you with your Bookswagon-related query today? Let me know if you have any questions about our services, policies, or need help with an order (please provide your order number starting with 'BW' if it's order-related).
app.py:chat: Request: User query: 'HOw are you?', AI-detected intent: general_faq
2025-07-14 15:12:19,419 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-14 15:12:19,434 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'HOw are you?' with keywords: ('are', 'how', 'you?')
2025-07-14 15:12:19,481 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 773 matching FAQs for query: 'HOw are you?' (keywords: ('are', 'how', 'you?'))
app.py:chat: Request: Bot response: Thank you for asking! I'm here and ready to assist you with any Bookswagon-related questions you may have. How can I help you today? Let me know if you need information about our services, policies, or orders.
app.py:chat: Request: User query: 'can you suggest me top trending book under 299?', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'can you suggest me top trending book under 299?', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n\n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: can you suggest me top trending book under 299?"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_DiscountedPrice <= 299 AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2555
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'can you suggest me top trending book under 299?'. Current cache size: 1
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 6.4330 seconds.
app.py:chat: Request: User query: 'in self help category?', AI-detected intent: general_faq
2025-07-14 15:14:25,475 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-14 15:14:25,475 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'in self help category?' with keywords: ('category?', 'help', 'in', 'self')
2025-07-14 15:14:25,553 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 718 matching FAQs for query: 'in self help category?' (keywords: ('category?', 'help', 'in', 'self'))
app.py:chat: Request: User query: 'ANy idea best books publisher by Double9?', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'ANy idea best books publisher by Double9?', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n\n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: ANy idea best books publisher by Double9?"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE PublisherName LIKE '%Double 9%' AND Language = 'English' AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2561
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'ANy idea best books publisher by Double9?'. Current cache size: 2
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 6.1850 seconds.
app.py:chat: Request: User query: 'Is first aid usmle great book for medical? 2025 edition launched?', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'Is first aid usmle great book for medical? 2025 edition launched?', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n\n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: Is first aid usmle great book for medical? 2025 edition launched?"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (Product_Title LIKE '%first aid usmle%' OR Product_Title LIKE '%USMLE%') AND (Product_Title LIKE '%2025%' OR Product_Title LIKE '%2025 edition%') AND Category_Name LIKE '%Medical%' AND Availability = 'Available' ORDER BY Ranking ASC;, Tokens Used: 2605
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'Is first aid usmle great book for medical? 2025 edition launched?'. Current cache size: 3
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 8.3106 seconds.
app.py:chat: Request: User query: 'is harrison principles new edition launched?', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'is harrison principles new edition launched?', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n\n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: is harrison principles new edition launched?"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%Harrison Principles%' AND Product_Title LIKE '%new edition%' AND Availability = 'Available' ORDER BY Ranking ASC;, Tokens Used: 2562
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'is harrison principles new edition launched?'. Current cache size: 4
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 6.4595 seconds.
app.py:chat: Request: Bot response: 

We looked high and low but couldnt find any matching books. Try tweaking your request?
app.py:chat: Request: User query: 'harrison principles of internal medicine', AI-detected intent: general_faq
2025-07-14 15:19:19,676 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-14 15:19:19,676 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'harrison principles of internal medicine' with keywords: ('harrison', 'internal', 'medicine', 'of', 'principles')
2025-07-14 15:19:19,786 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 382 matching FAQs for query: 'harrison principles of internal medicine' (keywords: ('harrison', 'internal', 'medicine', 'of', 'principles'))
app.py:chat: Request: User query: 'this is my order id BW25071452271519', AI-detected intent: order
app.py:chat: Request: Bot response: LOGIN_REQUIRED: Please log in to view your order details.
app.py:chat: Request: User query: 'my email id is srecommerce@gmail.com', AI-detected intent: order
app.py:chat: Request: Bot response: LOGIN_REQUIRED: Please log in to view your order details.
app.py:chat: Request: User query: 'help me finding harry potter series', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'help me finding harry potter series', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n\n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: help me finding harry potter series"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%Harry Potter%' AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2553
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'help me finding harry potter series'. Current cache size: 1
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 8.2787 seconds.
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'is harrison principles new edition launched?', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'is harrison principles new edition launched?', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n\n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: is harrison principles new edition launched?"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%Harrison Principles%' AND Availability = 'Available' ORDER BY Date_Created DESC;, Tokens Used: 2554
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'is harrison principles new edition launched?'. Current cache size: 2
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 7.4873 seconds.
app.py:chat: Request: Bot response: 

We looked high and low but couldnt find any matching books. Try tweaking your request?
app.py:chat: Request: User query: 'reccomened  me new harrison principles new edition', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'reccomened  me new harrison principles new edition', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n\n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: reccomened  me new harrison principles new edition"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%harrison principles%' AND Availability != 'Out Of Stock' ORDER BY Date_Created DESC;, Tokens Used: 2560
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'reccomened  me new harrison principles new edition'. Current cache size: 3
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 6.4855 seconds.
app.py:chat: Request: Bot response: 

We looked high and low but couldnt find any matching books. Try tweaking your request?
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'hi', AI-detected intent: general_faq
2025-07-16 10:18:19,450 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-16 10:18:19,451 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'hi' with keywords: ('hi',)
2025-07-16 10:18:19,480 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 219 matching FAQs for query: 'hi' (keywords: ('hi',))
app.py:chat: Request: Bot response: Hello! Welcome to Bookswagon customer service. How can I assist you today?
app.py:chat: Request: User query: 'wnt to red some buks', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'wnt to red some buks', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n\n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: wnt to red some buks"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Availability = 'Available' ORDER BY Ranking ASC;, Tokens Used: 2540
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'wnt to red some buks'. Current cache size: 1
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 4.8745 seconds.
app.py:chat: Request: User query: 'give horror', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'give horror', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n\n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: give horror"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (Category_Name LIKE '%Horror%' OR Product_Title LIKE '%horror%') AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2557
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'give horror'. Current cache size: 2
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 5.3044 seconds.
app.py:chat: Request: User query: 'hewlo', AI-detected intent: unknown
2025-07-16 11:13:46,674 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-16 11:13:46,675 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'hewlo' with keywords: ('hewlo',)
2025-07-16 11:13:46,715 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 0 matching FAQs for query: 'hewlo' (keywords: ('hewlo',))
app.py:chat: Request: Bot response: Hello! Welcome to Bookswagon customer service. How can I assist you today? Please let me know if you have any questions about our services, orders, or policies. If you're inquiring about an order, kindly provide your order number (typically starting with 'BW') so I can help you better.
app.py:chat: Request: User query: 'what up', AI-detected intent: unknown
2025-07-16 11:14:39,595 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-16 11:14:39,596 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'what up' with keywords: ('up', 'what')
2025-07-16 11:14:39,641 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 278 matching FAQs for query: 'what up' (keywords: ('up', 'what'))
app.py:chat: Request: Bot response: Hello! I'm Vidya from Bookswagon. How can I assist you today? Let me know if you have any questions about our services, orders, or policies. If you're inquiring about an order, please share your order number (typically starting with 'BW') so I can help you better. 

Is there anything specific you'd like to know?
app.py:chat: Request: User query: 'i want to read diary of a wimpy kid', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'i want to read diary of a wimpy kid', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n\n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: i want to read diary of a wimpy kid"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%diary of a wimpy kid%' AND Availability = 'Available' ORDER BY Ranking ASC;, Tokens Used: 2560
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'i want to read diary of a wimpy kid'. Current cache size: 3
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 7.5021 seconds.
app.py:chat: Request: User query: 'wanna buy wimpy kid do it yourself', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'wanna buy wimpy kid do it yourself', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n\n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: wanna buy wimpy kid do it yourself"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%wimpy kid%' AND Product_Title LIKE '%do it yourself%' AND Availability = 'Available' ORDER BY Ranking ASC;, Tokens Used: 2565
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'wanna buy wimpy kid do it yourself'. Current cache size: 4
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 6.7253 seconds.
app.py:chat: Request: Bot response: 

We looked high and low but couldnt find any matching books. Try tweaking your request?
app.py:chat: Request: User query: 'helos again how is you doing', AI-detected intent: general_faq
2025-07-16 11:32:00,926 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-16 11:32:00,926 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'helos again how is you doing' with keywords: ('again', 'doing', 'helos', 'how', 'is', 'you')
2025-07-16 11:32:01,034 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 772 matching FAQs for query: 'helos again how is you doing' (keywords: ('again', 'doing', 'helos', 'how', 'is', 'you'))
app.py:chat: Request: Bot response: Hello! I'm here to assist you with any questions you have about Bookswagon. How can I help you today?
app.py:chat: Request: User query: 'i want to read the laughing skull', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'i want to read the laughing skull', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n\n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: i want to read the laughing skull"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%laughing skull%' AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2554
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'i want to read the laughing skull'. Current cache size: 5
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 6.4746 seconds.
app.py:chat: Request: User query: 'also can you sjow me the jakarta cat', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'also can you sjow me the jakarta cat', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n\n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: also can you sjow me the jakarta cat"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (Product_Title LIKE '%jakarta%' OR Product_Title LIKE '%cat%') AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2565
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'also can you sjow me the jakarta cat'. Current cache size: 6
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 7.6615 seconds.
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'harrison principles please', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'harrison principles please', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: harrison principles please"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%Harrison%principles%' AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2646
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'harrison principles please'. Current cache size: 1
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 7.1946 seconds.
app.py:chat: Request: User query: 'laughing skull please', AI-detected intent: unknown
2025-07-16 14:15:07,602 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-16 14:15:07,602 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'laughing skull please' with keywords: ('laughing', 'please', 'skull')
2025-07-16 14:15:07,662 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 3 matching FAQs for query: 'laughing skull please' (keywords: ('laughing', 'please', 'skull'))
app.py:chat: Request: Bot response: I'm here to assist with Bookswagon-related customer service queries. Could you clarify how I can help you with our services today? Let me know if you have any questions about orders, returns, or other Bookswagon policies.
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'laughing skull book please', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'laughing skull book please', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: laughing skull book please"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%laughing%skull%' AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2647
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'laughing skull book please'. Current cache size: 2
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 6.2385 seconds.
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'hey how are ya', AI-detected intent: general_faq
2025-07-21 13:17:39,877 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-21 13:17:39,878 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'hey how are ya' with keywords: ('are', 'hey', 'how', 'ya')
2025-07-21 13:17:39,939 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 778 matching FAQs for query: 'hey how are ya' (keywords: ('are', 'hey', 'how', 'ya'))
app.py:chat: Request: Bot response: I'm here to assist you with any questions you may have about Bookswagon's services, policies, or your orders. How can I help you today?  

If you have an order-related query, please share your order number (typically starting with 'BW') so I can assist you better.  

Let me know how I can help!
app.py:chat: Request: User query: 'can you share me the link of harrison principles of internal medicine', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'can you share me the link of harrison principles of internal medicine', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: can you share me the link of harrison principles of internal medicine"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%Harrison%principles%internal%medicine%' AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2659
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'can you share me the link of harrison principles of internal medicine'. Current cache size: 1
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 6.7495 seconds.
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'i want to read harry potter', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'i want to read harry potter', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Perform spell correction on book titles and author names before creating the query.** If a user asks for \"Harrisan princples\", you should recognize this is likely a typo for \"Harrison principles\" and generate the query using the corrected terms (e.g., `WHERE Product_Title LIKE '%Harrison%principles%'`).\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: i want to read harry potter"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%Harry%Potter%' AND Availability = 'Available' ORDER BY Ranking ASC;, Tokens Used: 2717
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'i want to read harry potter'. Current cache size: 1
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 8.2102 seconds.
app.py:chat: Request: User query: 'i want to read harri potter', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'i want to read harri potter', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Perform spell correction on book titles and author names before creating the query.** If a user asks for \"Harrisan princples\", you should recognize this is likely a typo for \"Harrison principles\" and generate the query using the corrected terms (e.g., `WHERE Product_Title LIKE '%Harrison%principles%'`).\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: i want to read harri potter"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%Harry%Potter%' AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2719
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'i want to read harri potter'. Current cache size: 2
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 6.2118 seconds.
app.py:chat: Request: User query: 'wanna read harri pattar', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'wanna read harri pattar', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Perform spell correction on book titles and author names before creating the query.** If a user asks for \"Harrisan princples\", you should recognize this is likely a typo for \"Harrison principles\" and generate the query using the corrected terms (e.g., `WHERE Product_Title LIKE '%Harrison%principles%'`).\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: wanna read harri pattar"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (Product_Title LIKE '%Harry%Potter%' OR AuthorName1 LIKE '%Harry%Potter%') AND Availability = 'Available' ORDER BY Ranking ASC;, Tokens Used: 2728
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'wanna read harri pattar'. Current cache size: 3
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 7.8550 seconds.
app.py:chat: Request: User query: 'wanna read harrison principlr', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'wanna read harrison principlr', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Perform spell correction on book titles and author names before creating the query.** If a user asks for \"Harrisan princples\", you should recognize this is likely a typo for \"Harrison principles\" and generate the query using the corrected terms (e.g., `WHERE Product_Title LIKE '%Harrison%principles%'`).\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: wanna read harrison principlr"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%Harrison%principles%' AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2719
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'wanna read harrison principlr'. Current cache size: 4
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 10.4595 seconds.
app.py:chat: Request: User query: 'perfect you work amazingly', AI-detected intent: general_faq
2025-07-22 18:49:11,851 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-22 18:49:11,852 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'perfect you work amazingly' with keywords: ('amazingly', 'perfect', 'work', 'you')
2025-07-22 18:49:11,940 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 489 matching FAQs for query: 'perfect you work amazingly' (keywords: ('amazingly', 'perfect', 'work', 'you'))
app.py:chat: Request: Bot response: Thank you for your kind words! I'm here to assist you with any questions you may have about Bookswagon's services, policies, or your orders. Please let me know how I can help you today. 

If you have an order-related query, kindly share your order number (typically starting with 'BW') so I can assist you better. 

Is there anything specific you'd like to know?
app.py:chat: Request: User query: 'how are you?', AI-detected intent: general_faq
2025-07-22 18:49:38,467 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-22 18:49:38,467 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'how are you?' with keywords: ('are', 'how', 'you?')
2025-07-22 18:49:38,535 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 773 matching FAQs for query: 'how are you?' (keywords: ('are', 'how', 'you?'))
app.py:chat: Request: Bot response: I'm here to assist you with any questions you have about Bookswagon's services, policies, or orders. How can I help you today?
app.py:chat: Request: User query: 'can we talk more>', AI-detected intent: general_faq
2025-07-22 18:50:07,935 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-22 18:50:07,936 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'can we talk more>' with keywords: ('can', 'more>', 'talk', 'we')
2025-07-22 18:50:07,991 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 534 matching FAQs for query: 'can we talk more>' (keywords: ('can', 'more>', 'talk', 'we'))
app.py:chat: Request: Bot response: I'm here to assist you with any questions you have about Bookswagon's services, policies, or your orders. If you have a specific query, feel free to ask, and I'll do my best to help. 

If you're asking about an order, please provide your order number (typically starting with 'BW') so I can assist you better. Otherwise, let me know how I can help with Bookswagon-related questions. 

Is there anything specific you'd like to know?
app.py:chat: Request: User query: 'i want to know how were yu made?', AI-detected intent: unknown
2025-07-22 18:50:40,222 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-22 18:50:40,223 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'i want to know how were yu made?' with keywords: ('how', 'i', 'know', 'made?', 'to', 'want', 'were', 'yu')
2025-07-22 18:50:40,290 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 1090 matching FAQs for query: 'i want to know how were yu made?' (keywords: ('how', 'i', 'know', 'made?', 'to', 'want', 'were', 'yu'))
app.py:chat: Request: Bot response: I'm Vidya, Bookswagon's AI assistant, created to help answer your questions about our services, policies, and orders. My purpose is to provide accurate information based on Bookswagon's FAQ database to assist you efficiently. 

Is there anything specific about Bookswagon's services that I can help you with today?
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'hey how are ya', AI-detected intent: general_faq
2025-07-23 11:42:33,448 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-23 11:42:33,449 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'hey how are ya' with keywords: ('are', 'hey', 'how', 'ya')
2025-07-23 11:42:33,499 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 778 matching FAQs for query: 'hey how are ya' (keywords: ('are', 'hey', 'how', 'ya'))
app.py:chat: Request: Bot response: I'm here to assist you with any questions you may have about Bookswagon's services, policies, or your orders. How can I help you today?  

If you have an order-related query, please provide your order number (typically starting with 'BW') so I can assist you better.  

Let me know how I can help!
app.py:chat: Request: User query: 'what you doing?', AI-detected intent: unknown
2025-07-23 11:43:05,770 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-23 11:43:05,770 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'what you doing?' with keywords: ('doing?', 'what', 'you')
2025-07-23 11:43:05,822 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 627 matching FAQs for query: 'what you doing?' (keywords: ('doing?', 'what', 'you'))
app.py:chat: Request: Bot response: I'm here to assist you with any questions you have about Bookswagon's services, policies, or orders. If you need help with anything related to Bookswagon, feel free to ask. 

Could you let me know how I can assist you today?
app.py:chat: Request: User query: 'how are you', AI-detected intent: general_faq
2025-07-23 11:43:30,118 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-23 11:43:30,119 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'how are you' with keywords: ('are', 'how', 'you')
2025-07-23 11:43:30,172 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 919 matching FAQs for query: 'how are you' (keywords: ('are', 'how', 'you'))
app.py:chat: Request: Bot response: I'm here to assist you with any questions you may have about Bookswagon's services, policies, or orders. How can I help you today?
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'how are you?', AI-detected intent: general_faq
2025-07-23 11:48:21,829 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-23 11:48:21,830 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'how are you?' with keywords: ('are', 'how', 'you?')
2025-07-23 11:48:21,876 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 773 matching FAQs for query: 'how are you?' (keywords: ('are', 'how', 'you?'))
app.py:chat: Request: Bot response: I'm doing great, thanks for asking! I'm always happy to help you with anything related to Bookswagon. Do you have any questions about our books or services today?
app.py:chat: Request: User query: 'what you up to?', AI-detected intent: unknown
2025-07-23 11:48:59,391 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-23 11:48:59,392 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'what you up to?' with keywords: ('to?', 'up', 'what', 'you')
2025-07-23 11:48:59,453 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 654 matching FAQs for query: 'what you up to?' (keywords: ('to?', 'up', 'what', 'you'))
app.py:chat: Request: Bot response: I'm doing great, thanks for asking! I'm always here, ready to assist you with anything related to Bookswagon. What can I help you with today?
app.py:chat: Request: User query: 'what you doing?', AI-detected intent: unknown
2025-07-23 11:49:34,772 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-23 11:49:34,772 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'what you doing?' with keywords: ('doing?', 'what', 'you')
2025-07-23 11:49:34,823 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 627 matching FAQs for query: 'what you doing?' (keywords: ('doing?', 'what', 'you'))
app.py:chat: Request: Bot response: I'm doing great, thanks for asking! I'm here to assist you with any questions you have about Bookswagon's services, policies, or orders. What can I help you with today?
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'hey how are y', AI-detected intent: general_faq
2025-07-23 11:55:11,886 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-23 11:55:11,887 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'hey how are y' with keywords: ('are', 'hey', 'how', 'y')
2025-07-23 11:55:11,947 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 1067 matching FAQs for query: 'hey how are y' (keywords: ('are', 'hey', 'how', 'y'))
app.py:chat: Request: Bot response: I'm doing great, thank you! Currently immersed in the wonderful world of books and ready to assist you with your Bookswagon needs. What can I help you with today?
app.py:chat: Request: User query: 'what are you up to', AI-detected intent: unknown
2025-07-23 11:55:47,643 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-23 11:55:47,646 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'what are you up to' with keywords: ('are', 'to', 'up', 'what', 'you')
2025-07-23 11:55:47,705 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 954 matching FAQs for query: 'what are you up to' (keywords: ('are', 'to', 'up', 'what', 'you'))
app.py:chat: Request: Bot response: Just keeping our digital library in perfect order, making sure every book is ready to find its next reader! How can I assist you with your bookish needs today?
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'hey i want to read harry potter', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'hey i want to read harry potter', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Perform spell correction on book titles and author names before creating the query.** If a user asks for \"Harrisan princples\", you should recognize this is likely a typo for \"Harrison principles\" and generate the query using the corrected terms (e.g., `WHERE Product_Title LIKE '%Harrison%principles%'`).\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: hey i want to read harry potter"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%Harry%Potter%' AND Availability = 'Available' ORDER BY Ranking ASC;, Tokens Used: 2718
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'hey i want to read harry potter'. Current cache size: 1
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 6.1640 seconds.
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Sending book filtering query to DeepSeek. User Query: 'hey i want to read harry potter', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "The user asked: \"hey i want to read harry potter\"\n\nBelow is a list of books retrieved from a database. Each book is prefixed with its 1-based number.\nChoose only the book numbers that truly match what the user is looking for based on their original query.\nPrioritize books that seem most relevant based on the title, author, and category.\nConsider semantic relevance and user intent.\n\nBook list (Book Number. Title: ..., Author: ..., Category: ..., Price: ...):\n1. Title: Harry Potter Box Set: The Complete Collection (Children\u00e2\u20ac\u2122s Paperback), Author: J.K.Rowling, Category: Fantasy & magical realism (children\u2019s/ya), Price: \u20b9N/A\n2. Title: Harry Potter and the Philosopher's Stone, Author: J. K. Rowling, Category: Fantasy, Price: \u20b9N/A\n3. Title: Harry Potter 1\u20133 Box Set: A Magical Adventure Begins, Author: J. K. Rowling, Category: Modern & contemporary fiction, Price: \u20b9N/A\n4. Title: Samsara: Enter The Valley Of The Gods (\"India'S Answer To Harry Potter\"), Author: NA, Category: General, Price: \u20b9N/A\n5. Title: Harry Potter Box Set: The Complete Collection (Children\u2019s Hardback), Author: J.K.Rowling, Category: Fantasy & magical realism (children\u2019s/ya), Price: \u20b9N/A\n6. Title: Harry Potter and the Deathly Hallows, Author: J. K. Rowling, Category: Modern & contemporary fiction, Price: \u20b9N/A\n7. Title: Harry Potter and the Chamber of Secrets, Author: J. K. Rowling, Category: Fantasy, Price: \u20b9N/A\n8. Title: Harry Potter Boxed Set: The Complete Collection (Adult Paperback), Author: Au, Category: Fantasy, Price: \u20b9N/A\n9. Title: Harry Potter and the Prisoner of Azkaban, Author: J. K. Rowling, Category: Fantasy, Price: \u20b9N/A\n10. Title: Harry Potter and the Philosopher\u2019s Stone: MinaLima Edition, Author: J. K. Rowling, Category: Modern & contemporary fiction, Price: \u20b9N/A\n11. Title: Harry Potter Owl Post Box Set (Children\u2019s Hardback - The Complete Collection), Author: J.K. Rowling, Category: Modern & contemporary fiction, Price: \u20b9N/A\n12. Title: Harry Potter and the Goblet of Fire, Author: J. K. Rowling, Category: General fiction (children\u2019s/ya), Price: \u20b9N/A\n13. Title: HARRY POTTER AND THE ORDER OF THE PHOENIX - 5, Author: J. K. Rowling, Category: Fantasy, Price: \u20b9N/A\n14. Title: Harry Potter and the Prisoner of Azkaban: MinaLima Edition, Author: J.K. Rowling, Category: Adventure stories (children\u2019s/ya), Price: \u20b9N/A\n15. Title: The Harry Potter Wizarding Almanac, Author: Levi Pinfold, Category: Modern & contemporary fiction, Price: \u20b9N/A\n\n**Strict Output Format:**\nReturn ONLY the book numbers (e.g., 1, 2, 5) of the most relevant books in a JSON array format like:\n[1, 2, 5]\nIf no books are relevant, return an empty array: []\nDo not include any other text, markdown, or comments."}], "temperature": 0.3, "stream": false, "max_tokens": 100}
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Received raw response from DeepSeek for filtering. Response: [1, 2, 3, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14]
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Filtered Indices (0-based): [0, 1, 2, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13]
app.py:chat: Request: User query: 'can i suggest horror titles to 10 year olds?', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'can i suggest horror titles to 10 year olds?', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Perform spell correction on book titles and author names before creating the query.** If a user asks for \"Harrisan princples\", you should recognize this is likely a typo for \"Harrison principles\" and generate the query using the corrected terms (e.g., `WHERE Product_Title LIKE '%Harrison%principles%'`).\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: can i suggest horror titles to 10 year olds?"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (Category_Name LIKE '%Horror%' OR Product_Title LIKE '%horror%') AND Availability = 'Available' ORDER BY Ranking ASC;, Tokens Used: 2728
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'can i suggest horror titles to 10 year olds?'. Current cache size: 2
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 7.0418 seconds.
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Sending book filtering query to DeepSeek. User Query: 'can i suggest horror titles to 10 year olds?', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "The user asked: \"can i suggest horror titles to 10 year olds?\"\n\nBelow is a list of books retrieved from a database. Each book is prefixed with its 1-based number.\nChoose only the book numbers that truly match what the user is looking for based on their original query.\nPrioritize books that seem most relevant based on the title, author, and category.\nConsider semantic relevance and user intent.\n\nBook list (Book Number. Title: ..., Author: ..., Category: ..., Price: ...):\n1. Title: Ghosts of the Silent Hills, Author: ANITA KRISHAN, Category: Horror & ghost stories, chillers (children\u2019s/ya), Price: \u20b9N/A\n2. Title: Wind on Haunted Hill, Author:  Ruskin Bond, Category: Horror & ghost stories, chillers (children\u2019s/ya), Price: \u20b9N/A\n3. Title: Horror Omnibus, Author: HP Lovecraft, Category: Horror & ghost stories, Price: \u20b9N/A\n4. Title: The Shining, Author: Stephen King, Category: Horror & ghost stories, Price: \u20b9N/A\n5. Title: Ghost of Silent Hills, Author: ANITA KRISHAN, Category: Horror & ghost stories, Price: \u20b9N/A\n6. Title: Tales of Horror, Author: Nikesh Murali, Category: Horror & ghost stories, Price: \u20b9N/A\n7. Title: Ghosts in the Dark Silence, Author: ANITA KRISHAN, Category: Horror & ghost stories, Price: \u20b9N/A\n8. Title: The Secret Seven, Author: Blyton, Enid, Category: Horror & ghost stories, chillers (children\u2019s/ya), Price: \u20b9N/A\n9. Title: It, Author: Stephen King, Category: Horror & ghost stories, Price: \u20b9N/A\n10. Title: 50 Worlds Greatest Horror Stories, Author: various, Category: General, Price: \u20b9N/A\n11. Title: Marghat / &#2350;&#2352;&#2328;&#2335;, Author: Ashik Yadav, Category: Horror & ghost stories, chillers (children\u2019s/ya), Price: \u20b9N/A\n12. Title: Chainsaw Man, Vol. 13, Author: Tatsuki Fujimoto, Category: Horror & ghost stories, Price: \u20b9N/A\n13. Title: The Haunting of Hill House, Author: Shirley Jackson, Category: Horror & ghost stories, Price: \u20b9N/A\n14. Title: Ruskin Bond Horror Omnibus, Author: , Category: Horror & ghost stories, Price: \u20b9N/A\n15. Title: That Night, Author: Nidhi Upadhyay, Category: Horror & ghost stories, Price: \u20b9N/A\n\n**Strict Output Format:**\nReturn ONLY the book numbers (e.g., 1, 2, 5) of the most relevant books in a JSON array format like:\n[1, 2, 5]\nIf no books are relevant, return an empty array: []\nDo not include any other text, markdown, or comments."}], "temperature": 0.3, "stream": false, "max_tokens": 100}
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Received raw response from DeepSeek for filtering. Response: [1, 2, 8, 11]
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Filtered Indices (0-based): [0, 1, 7, 10]
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'is harry potter good for 10 yeat olds>', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'is harry potter good for 10 yeat olds>', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Perform spell correction on book titles and author names before creating the query.** If a user asks for \"Harrisan princples\", you should recognize this is likely a typo for \"Harrison principles\" and generate the query using the corrected terms (e.g., `WHERE Product_Title LIKE '%Harrison%principles%'`).\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: is harry potter good for 10 yeat olds>"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%Harry%Potter%' AND Category_Name LIKE '%Children%' OR Category_Name LIKE '%Young Adult%' AND Availability = 'Available' ORDER BY Ranking ASC;, Tokens Used: 2739
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'is harry potter good for 10 yeat olds>'. Current cache size: 1
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 7.4651 seconds.
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Sending book filtering query to DeepSeek. User Query: 'is harry potter good for 10 yeat olds>', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "The user asked: \"is harry potter good for 10 yeat olds>\"\n\nBelow is a list of books retrieved from a database. Each book is prefixed with its 1-based number.\nChoose only the book numbers that truly match what the user is looking for based on their original query.\nPrioritize books that seem most relevant based on the title, author, and category.\nConsider semantic relevance and user intent.\n\nBook list (Book Number. Title: ..., Author: ..., Category: ..., Price: ...):\n1. Title: Harry Potter Box Set: The Complete Collection (Children\u00e2\u20ac\u2122s Paperback), Author: J.K.Rowling, Category: Fantasy & magical realism (children\u2019s/ya), Price: \u20b9N/A\n2. Title: Harry Potter and the Chamber of Secrets (Harry Potter, Book 2) (Minalima Edition), Author: J K ROWLING, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A\n3. Title: 1800+ Reward Stickers - Ideal for Teachers and Parents, Author: Wonder House Books, Category: Children\u2019s & young adult fiction & true stories, Price: \u20b9N/A\n4. Title: Harry Potter Box Set: The Complete Collection (Children\u2019s Hardback), Author: J.K.Rowling, Category: Fantasy & magical realism (children\u2019s/ya), Price: \u20b9N/A\n5. Title: Harry Potter Hardcover Boxed Set: Books 1-7 (Trunk), Author: J K ROWLING, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A\n6. Title: Harry Potter: The Illustrated Collection (Books 1-3 Boxed Set), Author: Jim Kay, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A\n7. Title: Harry Potter and the Goblet of Fire, Author: J. K. Rowling, Category: General fiction (children\u2019s/ya), Price: \u20b9N/A\n8. Title: My First Animal Sticker Book, Author: Wonder House Books, Category: Children\u2019s & young adult fiction & true stories, Price: \u20b9N/A\n9. Title: Harry Potter Paperback Boxed Set: Books 1-7, Author: J K ROWLING, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A\n10. Title: Communist Manifesto, Author:  Karl Marx, Category: Children\u2019s & young adult general non-fiction, Price: \u20b9N/A\n11. Title: My First Experiences Sticker Book, Author: Wonder House Books, Category: Children\u2019s & young adult fiction & true stories, Price: \u20b9N/A\n12. Title: Harry Potter Hardcover Boxed Set: Books 1-7, Author: Inc Scholastic, Category: Fantasy & magical realism (children\u2019s/ya), Price: \u20b9N/A\n13. Title: Hold On to Your Dreams, Author:  Ruskin Bond, Category: Children\u2019s & young adult general non-fiction, Price: \u20b9N/A\n14. Title: 100 Words, Author: NA, Category: Children\u2019s & young adult fiction & true stories, Price: \u20b9N/A\n15. Title: I Believe in Unicorn Copy Coloring Book: Fun Activity Books for Children, Author: Wonder House Books, Category: Children\u2019s & young adult fiction & true stories, Price: \u20b9N/A\n\n**Strict Output Format:**\nReturn ONLY the book numbers (e.g., 1, 2, 5) of the most relevant books in a JSON array format like:\n[1, 2, 5]\nIf no books are relevant, return an empty array: []\nDo not include any other text, markdown, or comments."}], "temperature": 0.3, "stream": false, "max_tokens": 100}
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Received raw response from DeepSeek for filtering. Response: [1, 2, 4, 5, 6, 7, 9, 12]
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Filtered Indices (0-based): [0, 1, 3, 4, 5, 6, 8, 11]
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'is goosebumps great for 10 year olds or is it too spooky?', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'is goosebumps great for 10 year olds or is it too spooky?', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Perform spell correction on book titles and author names before creating the query.** If a user asks for \"Harrisan princples\", you should recognize this is likely a typo for \"Harrison principles\" and generate the query using the corrected terms (e.g., `WHERE Product_Title LIKE '%Harrison%principles%'`).\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: is goosebumps great for 10 year olds or is it too spooky?"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%goosebumps%' AND Category_Name LIKE '%Children%' AND Availability = 'Available' ORDER BY Ranking ASC;, Tokens Used: 2734
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'is goosebumps great for 10 year olds or is it too spooky?'. Current cache size: 1
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 7.3141 seconds.
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Sending book filtering query to DeepSeek. User Query: 'is goosebumps great for 10 year olds or is it too spooky?', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "The user asked: \"is goosebumps great for 10 year olds or is it too spooky?\"\n\nBelow is a list of books retrieved from a database. Each book is prefixed with its 1-based number.\nChoose only the book numbers that truly match what the user is looking for based on their original query.\nPrioritize books that seem most relevant based on the title, author, and category.\nConsider semantic relevance and user intent.\n\nBook list (Book Number. Title: ..., Author: ..., Category: ..., Price: ...):\n1. Title: Claws! (Goosebumps Hall of Horrors #1), 1, Author: R.L. Stine, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A\n2. Title: Ghost Beach (Goosebumps - 22), Author: R.L. Stine, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A\n3. Title: Chicken Chicken (Goosebumps - 53) R.L. Stine, Author: R.L. Stine, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A\n4. Title: Why I Quit Zombie School (Goosebumps Hall of Horrors #4), Author: R.L. Stine, Category: Horror & ghost stories, chillers (children\u2019s/ya), Price: \u20b9N/A\n5. Title: The Ghost Next Door (Goosebumps) [Paperback] R.L. Stine, Author: NA, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A\n6. Title: Five Masks of Dr. Screem: Special Edition (Goosebumps Hall of Horrors #3), Author: R.L. Stine, Category: Horror & ghost stories, chillers (children\u2019s/ya), Price: \u20b9N/A\n7. Title: Goosebumps 56: the Curse of Camp Cold Lake, Author: R.L. Stine, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A\n8. Title: Scream of the Haunted Mask (Goosebumps Horrorland #4), Author: R.L. Stine, Category: Horror & ghost stories, chillers (children\u2019s/ya), Price: \u20b9N/A\n9. Title: Streets of Panic Park (Goosebumps Horrorland #12), Author: R.L. Stine, Category: Sporting stories (children\u2019s/ya), Price: \u20b9N/A\n10. Title: Goosebumps Slappyworld #16: Slappy In Dreamland, Author: R L Stine, Category: Children & Teens, Price: \u20b9N/A\n11. Title: Son of Slappy (Goosebumps Most Wanted #2), Author: R.L. Stine, Category: Horror & ghost stories, chillers (children\u2019s/ya), Price: \u20b9N/A\n12. Title: It Came From Beneath The Sink! (Goosebumps - 30) [Paperback] R.L. Stine, Author: NA, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A\n13. Title: Welcome to Camp Slither (Goosebumps Horrorland #9), Author: R.L. Stine, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A\n14. Title: Little Shop of Hamsters: 14 (Give Yourself Goosebumps - 14) [Mass Market Paperback] R.L. Stine, Author: R.L. Stine, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A\n15. Title: My Friends Call Me Monster: 7 (Goosebumps Horrorland) [Mass Market Paperback] R.L. Stine, Author: R.L. Stine, Category: Sporting stories (children\u2019s/ya), Price: \u20b9N/A\n\n**Strict Output Format:**\nReturn ONLY the book numbers (e.g., 1, 2, 5) of the most relevant books in a JSON array format like:\n[1, 2, 5]\nIf no books are relevant, return an empty array: []\nDo not include any other text, markdown, or comments."}], "temperature": 0.3, "stream": false, "max_tokens": 100}
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Received raw response from DeepSeek for filtering. Response: [1, 2, 3, 4, 5, 6, 7, 8, 10, 11, 12, 13, 14]
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Filtered Indices (0-based): [0, 1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13]
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'hey is hc verma a good book to read?', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'hey is hc verma a good book to read?', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Perform spell correction on book titles and author names before creating the query.** If a user asks for \"Harrisan princples\", you should recognize this is likely a typo for \"Harrison principles\" and generate the query using the corrected terms (e.g., `WHERE Product_Title LIKE '%Harrison%principles%'`).\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n- **Handle author initials with precision.** If a user searches for an author with initials typed without dots (e.g., \"HC Verma\", \"JRR Tolkien\"), you MUST reformat them by inserting a dot `.` between each initial letter in the `LIKE` clause. For example, a search for \"HC Verma\" should generate a clause like `WHERE AuthorName1 LIKE '%H.C%Verma%'`. This ensures you find authors formatted as 'H.C. Verma' or 'H.C Verma' without incorrectly matching other names. \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: hey is hc verma a good book to read?"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%H.C%Verma%' AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2839
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'hey is hc verma a good book to read?'. Current cache size: 1
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 5.5810 seconds.
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Sending book filtering query to DeepSeek. User Query: 'hey is hc verma a good book to read?', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "The user asked: \"hey is hc verma a good book to read?\"\n\nBelow is a list of books retrieved from a database. Each book is prefixed with its 1-based number.\nChoose only the book numbers that truly match what the user is looking for based on their original query.\nPrioritize books that seem most relevant based on the title, author, and category.\nConsider semantic relevance and user intent.\n\nBook list (Book Number. Title: ..., Author: ..., Category: ..., Price: ...):\n1. Title: MCQ in Veterinary Science, Author: Rajesh Kumar, R.P Diwakar|J.S Rajoriya, H.C verma|Ramakant, Category: General, Price: \u20b9N/A\n2. Title: Industrial Families in India, Author: H.C. Verma, Category: General, Price: \u20b9N/A\n3. Title: Harvesting Water and Rationlization Of Agriculture In North Medieval India, Author: H.C. Verma, Category: Uncategorized, Price: \u20b9N/A\n4. Title: Calculus: The Princess of Mathematics Volume- 1, Author: H.C. Verma, Category: General, Price: \u20b9N/A\n\n**Strict Output Format:**\nReturn ONLY the book numbers (e.g., 1, 2, 5) of the most relevant books in a JSON array format like:\n[1, 2, 5]\nIf no books are relevant, return an empty array: []\nDo not include any other text, markdown, or comments."}], "temperature": 0.3, "stream": false, "max_tokens": 100}
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Received raw response from DeepSeek for filtering. Response: []
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Filtered Indices (0-based): []
app.py:chat: Request: Bot response: 

I fetched some titles, but none seemed quite right. Try a slightly different request?
app.py:chat: Request: User query: 'is goosebumps a good read for 10 year olds?', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'is goosebumps a good read for 10 year olds?', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Perform spell correction on book titles and author names before creating the query.** If a user asks for \"Harrisan princples\", you should recognize this is likely a typo for \"Harrison principles\" and generate the query using the corrected terms (e.g., `WHERE Product_Title LIKE '%Harrison%principles%'`).\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n- **Handle author initials with precision.** If a user searches for an author with initials typed without dots (e.g., \"HC Verma\", \"JRR Tolkien\"), you MUST reformat them by inserting a dot `.` between each initial letter in the `LIKE` clause. For example, a search for \"HC Verma\" should generate a clause like `WHERE AuthorName1 LIKE '%H.C%Verma%'`. This ensures you find authors formatted as 'H.C. Verma' or 'H.C Verma' without incorrectly matching other names. \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: is goosebumps a good read for 10 year olds?"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%goosebumps%' AND Availability = 'Available' ORDER BY Ranking ASC;, Tokens Used: 2837
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'is goosebumps a good read for 10 year olds?'. Current cache size: 2
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 6.0248 seconds.
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Sending book filtering query to DeepSeek. User Query: 'is goosebumps a good read for 10 year olds?', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "The user asked: \"is goosebumps a good read for 10 year olds?\"\n\nBelow is a list of books retrieved from a database. Each book is prefixed with its 1-based number.\nChoose only the book numbers that truly match what the user is looking for based on their original query.\nPrioritize books that seem most relevant based on the title, author, and category.\nConsider semantic relevance and user intent.\n\nBook list (Book Number. Title: ..., Author: ..., Category: ..., Price: ...):\n1. Title: Goosebumps Most Wanted #04: The Haunter, Author: , Category: General, Price: \u20b9N/A\n2. Title: Claws! (Goosebumps Hall of Horrors #1), 1, Author: R.L. Stine, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A\n3. Title: GOOSEBUMPS HORRORLAND X 10 S W, Author: Au, Category: Biography: arts & entertainment, Price: \u20b9N/A\n4. Title: Goosebumps Slappy World Box of 7 Books [Product Bundle] R. L. Stine, Author: R. L. Stine, Category: General, Price: \u20b9N/A\n5. Title: Goosebumps House of Shivers #1: Scariest. Book. Ever., Author: R.L Stine, Category: General, Price: \u20b9N/A\n6. Title: Goosebumps Special Edition: Slappy, Beware!, Author: NA, Category: General, Price: \u20b9N/A\n7. Title: Goosebumps Wanted: The Haunted Mask, Author: , Category: General, Price: \u20b9N/A\n8. Title: Ghost Beach (Goosebumps - 22), Author: R.L. Stine, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A\n9. Title: Goosebumps Most Wanted Special Edition : Trick Or Trap, Author: , Category: General, Price: \u20b9N/A\n10. Title: Chicken Chicken (Goosebumps - 53) R.L. Stine, Author: R.L. Stine, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A\n11. Title: Goosebumps Most Wanted Special Edition #1: Zombie Halloween, Author: , Category: General, Price: \u20b9N/A\n12. Title: GOOSEBUMPS SLAPPYWORLD #9: REVENGE OF THE INVISIBLE BOY, Author: R. L. Stine, Category: General, Price: \u20b9N/A\n13. Title: Goosebumps Most Wanted #7 A Nightmare On Clown Street, Author: , Category: General, Price: \u20b9N/A\n14. Title: Goosebumps Slappyworld #03: I am Slappy'S Evil Twin, Author: R.L. Stine, Category: General, Price: \u20b9N/A\n15. Title: Why I Quit Zombie School (Goosebumps Hall of Horrors #4), Author: R.L. Stine, Category: Horror & ghost stories, chillers (children\u2019s/ya), Price: \u20b9N/A\n\n**Strict Output Format:**\nReturn ONLY the book numbers (e.g., 1, 2, 5) of the most relevant books in a JSON array format like:\n[1, 2, 5]\nIf no books are relevant, return an empty array: []\nDo not include any other text, markdown, or comments."}], "temperature": 0.3, "stream": false, "max_tokens": 100}
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Received raw response from DeepSeek for filtering. Response: [1, 2, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15]
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Filtered Indices (0-based): [0, 1, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14]
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'a modern sci-fi novel about space exploration please', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'a modern sci-fi novel about space exploration please', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Perform spell correction on book titles and author names before creating the query.** If a user asks for \"Harrisan princples\", you should recognize this is likely a typo for \"Harrison principles\" and generate the query using the corrected terms (e.g., `WHERE Product_Title LIKE '%Harrison%principles%'`).\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n- **Handle author initials with precision.** If a user searches for an author with initials typed without dots (e.g., \"HC Verma\", \"JRR Tolkien\"), you MUST reformat them by inserting a dot `.` between each initial letter in the `LIKE` clause. For example, a search for \"HC Verma\" should generate a clause like `WHERE AuthorName1 LIKE '%H.C%Verma%'`. This ensures you find authors formatted as 'H.C. Verma' or 'H.C Verma' without incorrectly matching other names. \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- If a specific topic is mentioned but no clear `Category_Name` match is likely, or to broaden the search, also include `Product_Title LIKE '%<topic>%'` in an `OR` condition with the `Category_Name` filter (e.g., `WHERE Category_Name LIKE '%mythology%' OR Product_Title LIKE '%mythology%'`).\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: a modern sci-fi novel about space exploration please"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (Category_Name LIKE '%Sci-Fi%' OR Category_Name LIKE '%Science Fiction%') AND Product_Title LIKE '%space%exploration%' AND Availability = 'Available' ORDER BY Ranking ASC;, Tokens Used: 2852
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'a modern sci-fi novel about space exploration please'. Current cache size: 1
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 7.1999 seconds.
app.py:chat: Request: Bot response: 

We looked high and low but couldn't find any matching books. Try tweaking your request?
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'i need sci-fi books about space exploration', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'i need sci-fi books about space exploration', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Perform spell correction on book titles and author names before creating the query.** If a user asks for \"Harrisan princples\", you should recognize this is likely a typo for \"Harrison principles\" and generate the query using the corrected terms (e.g., `WHERE Product_Title LIKE '%Harrison%principles%'`).\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n- **Handle author initials with precision.** If a user searches for an author with initials typed without dots (e.g., \"HC Verma\", \"JRR Tolkien\"), you MUST reformat them by inserting a dot `.` between each initial letter in the `LIKE` clause. For example, a search for \"HC Verma\" should generate a clause like `WHERE AuthorName1 LIKE '%H.C%Verma%'`. This ensures you find authors formatted as 'H.C. Verma' or 'H.C Verma' without incorrectly matching other names. \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- **Crucial Rule:** If a user specifies a category AND a related topic (e.g., \"science fiction books about space exploration\"), you MUST combine them with an `OR` to broaden the search. The query should look for books that are either in the category OR match the topic in the title. For example: `WHERE (Category_Name LIKE '%Science Fiction%' OR Product_Title LIKE '%space%exploration%')`. Using `AND` for this is too restrictive and will return poor results.\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: i need sci-fi books about space exploration"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (Category_Name LIKE '%Sci-Fi%' OR Category_Name LIKE '%Science Fiction%' OR Product_Title LIKE '%space%exploration%') AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2878
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'i need sci-fi books about space exploration'. Current cache size: 1
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 7.2430 seconds.
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Sending book filtering query to DeepSeek. User Query: 'i need sci-fi books about space exploration', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "The user asked: \"i need sci-fi books about space exploration\" \nBelow is a list of books retrieved from a database. Each book is prefixed with its 1-based number.\nYour task is to act as a helpful librarian and choose the book numbers that are the **most relevant** to what the user is looking for. \n**Key Filtering Rules:** \n- Prioritize books that seem most relevant based on the title, author, and category. \n- Consider semantic relevance and user intent. \n- **It is better to return a few closely related books than to return an empty list.** If there are no perfect matches, select the books that are the next best fit. \n\nBook list (Book Number. Title: ..., Author: ..., Category: ..., Price: ...): \n1. Title: Harry Potter and the Chamber of Secrets (Harry Potter, Book 2) (Minalima Edition), Author: J K ROWLING, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A\n2. Title: Harry Potter Hardcover Boxed Set: Books 1-7 (Trunk), Author: J K ROWLING, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A\n3. Title: Hawaldar Bahadur Aur Karamati Bakra, Author: Sahil, Category: Science fiction, Price: \u20b9N/A\n4. Title: Harry Potter: The Illustrated Collection (Books 1-3 Boxed Set), Author: Jim Kay, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A\n5. Title: Harry Potter Paperback Boxed Set: Books 1-7, Author: J K ROWLING, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A\n6. Title: Unravel Me, Author: Tahereh Mafi, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A\n7. Title: Lucifer was Innocent, Author: Tirth Raj Parsana, Category: Science fiction, Price: \u20b9N/A\n8. Title: Dune, Author: Frank Herbert, Category: Science fiction, Price: \u20b9N/A\n9. Title: Harry Potter Books 1-3 Boxed Set (Minalima Editions), Author: J K ROWLING, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A\n10. Title: Three-Body Problem, Author: Cixin Liu, Category: Science fiction, Price: \u20b9N/A\n11. Title: Red Rising, Author: Pierce Brown, Category: Science fiction, Price: \u20b9N/A\n12. Title: The Three-Body Problem Boxset, Author: , Category: Science fiction, Price: \u20b9N/A\n13. Title: Girl Who Drank the Moon, Author: Kelly Barnhill, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A\n14. Title: The Three-Body Problem, Author: Liu Cixin, Category: Science fiction, Price: \u20b9N/A\n15. Title: Harry Potter Wizarding Almanac: The Official Magical Companion to J.K. Rowling's Harry Potter Books, Author: Levi Pinfold, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A \n\n**Strict Output Format:** \nReturn ONLY the book numbers (e.g., 1, 2, 5) of the most relevant books in a JSON array format like: \n[1, 2, 5] \nIf absolutely no books are even remotely relevant, you can return an empty array: [] \nDo not include any other text, markdown, or comments."}], "temperature": 0.3, "stream": false, "max_tokens": 100}
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Received raw response from DeepSeek for filtering. Response: [8, 10, 11, 12, 14]
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Filtered Indices (0-based): [7, 9, 10, 11, 13]
app.py:chat: Request: User query: 'are you busy right now?', AI-detected intent: general_faq
2025-07-24 14:13:25,963 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-24 14:13:25,964 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'are you busy right now?' with keywords: ('are', 'busy', 'now?', 'right', 'you')
2025-07-24 14:13:26,034 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 847 matching FAQs for query: 'are you busy right now?' (keywords: ('are', 'busy', 'now?', 'right', 'you'))
app.py:chat: Request: Bot response: I'm always happily immersed in the world of books, ready to assist you with any Bookswagon-related queries! What can I help you with today?
app.py:chat: Request: User query: 'im feeling a bit down, can you suggest an uplifting book?', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'im feeling a bit down, can you suggest an uplifting book?', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Perform spell correction on book titles and author names before creating the query.** If a user asks for \"Harrisan princples\", you should recognize this is likely a typo for \"Harrison principles\" and generate the query using the corrected terms (e.g., `WHERE Product_Title LIKE '%Harrison%principles%'`).\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n- **Handle author initials with precision.** If a user searches for an author with initials typed without dots (e.g., \"HC Verma\", \"JRR Tolkien\"), you MUST reformat them by inserting a dot `.` between each initial letter in the `LIKE` clause. For example, a search for \"HC Verma\" should generate a clause like `WHERE AuthorName1 LIKE '%H.C%Verma%'`. This ensures you find authors formatted as 'H.C. Verma' or 'H.C Verma' without incorrectly matching other names. \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- **Crucial Rule:** If a user specifies a category AND a related topic (e.g., \"science fiction books about space exploration\"), you MUST combine them with an `OR` to broaden the search. The query should look for books that are either in the category OR match the topic in the title. For example: `WHERE (Category_Name LIKE '%Science Fiction%' OR Product_Title LIKE '%space%exploration%')`. Using `AND` for this is too restrictive and will return poor results.\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: im feeling a bit down, can you suggest an uplifting book?"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%') AND Availability = 'Available' ORDER BY Ranking ASC;, Tokens Used: 2901
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'im feeling a bit down, can you suggest an uplifting book?'. Current cache size: 2
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 7.9902 seconds.
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Sending book filtering query to DeepSeek. User Query: 'im feeling a bit down, can you suggest an uplifting book?', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "The user asked: \"im feeling a bit down, can you suggest an uplifting book?\" \nBelow is a list of books retrieved from a database. Each book is prefixed with its 1-based number.\nYour task is to act as a helpful librarian and choose the book numbers that are the **most relevant** to what the user is looking for. \n**Key Filtering Rules:** \n- Prioritize books that seem most relevant based on the title, author, and category. \n- Consider semantic relevance and user intent. \n- **It is better to return a few closely related books than to return an empty list.** If there are no perfect matches, select the books that are the next best fit. \n\nBook list (Book Number. Title: ..., Author: ..., Category: ..., Price: ...): \n1. Title: World\u2019s Greatest Books For Personal Growth & Wealth (Set of 4 Books) : Perfect Motivational Gift Set, Author: Dale Carnegie, Napoleon Hill, Dr. Joseph Murphy & George S. Clason, Category: General, Price: \u20b9N/A\n2. Title: Courage To Be Disliked, The: How to free yourself, change your life and achieve real happiness (Courage To series), Author: Ichiro Kishimi, Category: Law for the lay person, Price: \u20b9N/A\n3. Title: The Almanack Of Naval Ravikant: A Guide to Wealth and Happiness, Author: ERIC JORGENSON, Category: Business & Economics, Price: \u20b9N/A\n4. Title: A Little Book of Happiness, Author: , Category: General, Price: \u20b9N/A\n5. Title: Happiness Hacks: 100% Scientific! Curiously Effective! \u00c7\u20ac Latest book by New York Times Bestselling author, Author: Alex Palmer, Category: Parenting, Family & Health, Price: \u20b9N/A\n6. Title: Pursuit of Happiness: A Book of Studies and Strowings, Author: Daniel Garrison Brinton, Category: Psychology: emotions, Price: \u20b9N/A\n7. Title: The Happiness Advantage, Author: Shawn Achor, Category: Advice on careers & achieving success, Price: \u20b9N/A\n8. Title: The Greatest Self-Help Book (Is The One Written By You) A Journal A Daily Journal For Gratitude, Happiness, Reflection And Self-Love, Author: NA, Category: General, Price: \u20b9N/A\n9. Title: Average Sucks: Why You don\u00e2\u20ac\u2122t get what you want (And what to do about it) \u00c7\u20ac Small Motivational Tools for Big Improvements in Life, Author: Michael Bernoff, Category: Parenting, Family & Health, Price: \u20b9N/A\n10. Title: Gautam Buddh Se Seekhen Jeevan Jeene Ki Kala (Hindi Translation Of Buddha On Happiness), Author: NA, Category: General, Price: \u20b9N/A\n11. Title: Demon Slayer: Kimetsu no Yaiba\u2014The Flower of Happiness, Author: Jocelyne Allen, Category: Fantasy, Price: \u20b9N/A\n12. Title: The Art Of Living: The Classical Manual On Virtue, Happiness And Effectiveness, Author: Sharon Epictetus Lebell, Category: Theory of art, Price: \u20b9N/A\n13. Title: The Ministry of Utmost Happiness, Author: Arundhati Roy, Category: General, Price: \u20b9N/A\n14. Title: 7 Strategies for Wealth & Happiness, Author: Jim Rohn, Category: Advice on careers & achieving success, Price: \u20b9N/A\n15. Title: The Illicit Happiness Of Other People, Author: , Category: General, Price: \u20b9N/A \n\n**Strict Output Format:** \nReturn ONLY the book numbers (e.g., 1, 2, 5) of the most relevant books in a JSON array format like: \n[1, 2, 5] \nIf absolutely no books are even remotely relevant, you can return an empty array: [] \nDo not include any other text, markdown, or comments."}], "temperature": 0.3, "stream": false, "max_tokens": 100}
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Received raw response from DeepSeek for filtering. Response: [2, 3, 4, 5, 6, 7, 8, 10, 12, 14]
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Filtered Indices (0-based): [1, 2, 3, 4, 5, 6, 7, 9, 11, 13]
app.py:chat: Request: User query: 'i need a good book for a long flight', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'i need a good book for a long flight', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Perform spell correction on book titles and author names before creating the query.** If a user asks for \"Harrisan princples\", you should recognize this is likely a typo for \"Harrison principles\" and generate the query using the corrected terms (e.g., `WHERE Product_Title LIKE '%Harrison%principles%'`).\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n- **Handle author initials with precision.** If a user searches for an author with initials typed without dots (e.g., \"HC Verma\", \"JRR Tolkien\"), you MUST reformat them by inserting a dot `.` between each initial letter in the `LIKE` clause. For example, a search for \"HC Verma\" should generate a clause like `WHERE AuthorName1 LIKE '%H.C%Verma%'`. This ensures you find authors formatted as 'H.C. Verma' or 'H.C Verma' without incorrectly matching other names. \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- **Crucial Rule:** If a user specifies a category AND a related topic (e.g., \"science fiction books about space exploration\"), you MUST combine them with an `OR` to broaden the search. The query should look for books that are either in the category OR match the topic in the title. For example: `WHERE (Category_Name LIKE '%Science Fiction%' OR Product_Title LIKE '%space%exploration%')`. Using `AND` for this is too restrictive and will return poor results.\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: i need a good book for a long flight"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Fantasy%' OR Category_Name LIKE '%Adventure%') AND Availability = 'Available' ORDER BY Ranking ASC;, Tokens Used: 2894
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'i need a good book for a long flight'. Current cache size: 3
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 9.0063 seconds.
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Sending book filtering query to DeepSeek. User Query: 'i need a good book for a long flight', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "The user asked: \"i need a good book for a long flight\" \nBelow is a list of books retrieved from a database. Each book is prefixed with its 1-based number.\nYour task is to act as a helpful librarian and choose the book numbers that are the **most relevant** to what the user is looking for. \n**Key Filtering Rules:** \n- Prioritize books that seem most relevant based on the title, author, and category. \n- Consider semantic relevance and user intent. \n- **It is better to return a few closely related books than to return an empty list.** If there are no perfect matches, select the books that are the next best fit. \n\nBook list (Book Number. Title: ..., Author: ..., Category: ..., Price: ...): \n1. Title: Deewar Mein Ek Khidki Rahti Thi \u00e0\u00a5\u00a4 \u00e0\u00a4\u00a6\u00e0\u00a5\u20ac\u00e0\u00a4\u00b5\u00e0\u00a4\u00be\u00e0\u00a4\u00b0 \u00e0\u00a4\u00ae\u00e0\u00a5\u2021\u00e0\u00a4\u201a \u00e0\u00a4\u008f\u00e0\u00a4\u2022 \u00e0\u00a4\u2013\u00e0\u00a4\u00bf\u00e0\u00a4\u00a1\u00e0\u00a4\u00bc\u00e0\u00a4\u2022\u00e0\u00a5\u20ac \u00e0\u00a4\u00b0\u00e0\u00a4\u00b9\u00e0\u00a4\u00a4\u00e0\u00a5\u20ac \u00e0\u00a4\u00a5\u00e0\u00a5\u20ac [ \u00e0\u00a4\u00b8\u00e0\u00a4\u00be\u00e0\u00a4\u00b9\u00e0\u00a4\u00bf\u00e0\u00a4\u00a4\u00e0\u00a5\u008d\u00e0\u00a4\u00af \u00e0\u00a4\u2026\u00e0\u00a4\u2022\u00e0\u00a4\u00be\u00e0\u00a4\u00a6\u00e0\u00a4\u00ae\u00e0\u00a5\u20ac \u00e0\u00a4\u00aa\u00e0\u00a5\u0081\u00e0\u00a4\u00b0\u00e0\u00a4\u00b8\u00e0\u00a5\u008d\u00e0\u00a4\u2022\u00e0\u00a4\u00be\u00e0\u00a4\u00b0 \u00e0\u00a4\u00b8\u00e0\u00a5\u2021 \u00e0\u00a4\u00aa\u00e0\u00a5\u0081\u00e0\u00a4\u00b0\u00e0\u00a4\u00b8\u00e0\u00a5\u008d\u00e0\u00a4\u2022\u00e0\u00a5\u0192\u00e0\u00a4\u00a4 \u00e0\u00a4\u2030\u00e0\u00a4\u00aa\u00e0\u00a4\u00a8\u00e0\u00a5\u008d\u00e0\u00a4\u00af\u00e0\u00a4\u00be\u00e0\u00a4\u00b8 ], Author: Vinod Kumar Shukla, Category: Modern & contemporary fiction, Price: \u20b9N/A\n2. Title: The Satanic Verses, Author: Salman Rushdie, Category: Modern & contemporary fiction, Price: \u20b9N/A\n3. Title: Satanic Verses, Author: Salman Rushdie, Category: Modern & contemporary fiction, Price: \u20b9N/A\n4. Title: White Nights, Author: Ronald Meyer, Category: Classic fiction, Price: \u20b9N/A\n5. Title: Metamorphosis, Author:  Franz Kafka, Category: Classic fiction, Price: \u20b9N/A\n6. Title: The Alchemist, Author: Paulo Coelho, Category: Modern & contemporary fiction, Price: \u20b9N/A\n7. Title: Harry Potter Box Set: The Complete Collection (Children\u00e2\u20ac\u2122s Paperback), Author: J.K.Rowling, Category: Fantasy & magical realism (children\u2019s/ya), Price: \u20b9N/A\n8. Title: The Magic Of The Lost Temple**, Author: Sudha Murty, Category: Adventure stories (children\u2019s/ya), Price: \u20b9N/A\n9. Title: Moral Stories, Author: Wonder House Books, Category: Classic fiction (children\u2019s/ya), Price: \u20b9N/A\n10. Title: Harry Potter and the Philosopher's Stone, Author: J. K. Rowling, Category: Fantasy, Price: \u20b9N/A\n11. Title: The Blue Umbrella, Author:  Ruskin Bond, Category: Modern & contemporary fiction, Price: \u20b9N/A\n12. Title: Never Lie : A Totally Gripping Thriller with Mind-bending Twists, Author: McFadden, The Housemaid Freida, Category: Thriller / suspense, Price: \u20b9N/A\n13. Title: The Housemaid : An addictive psychological thriller with mind-bending twists, Author: Freida McFadden, Category: Thriller / suspense, Price: \u20b9N/A\n14. Title: Time Machine, Author:  H G Wells, Category: Classic fiction (children\u2019s/ya), Price: \u20b9N/A\n15. Title: Days at the Morisaki Bookshop : A charming and uplifting Japanese translated story on the healing power of books, Author: Eric Ozawa, Category: Modern & contemporary fiction, Price: \u20b9N/A \n\n**Strict Output Format:** \nReturn ONLY the book numbers (e.g., 1, 2, 5) of the most relevant books in a JSON array format like: \n[1, 2, 5] \nIf absolutely no books are even remotely relevant, you can return an empty array: [] \nDo not include any other text, markdown, or comments."}], "temperature": 0.3, "stream": false, "max_tokens": 100}
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Received raw response from DeepSeek for filtering. Response: [2, 3, 6, 15]
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Filtered Indices (0-based): [1, 2, 5, 14]
app.py:chat: Request: User query: 'i want thriller stories', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'i want thriller stories', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Perform spell correction on book titles and author names before creating the query.** If a user asks for \"Harrisan princples\", you should recognize this is likely a typo for \"Harrison principles\" and generate the query using the corrected terms (e.g., `WHERE Product_Title LIKE '%Harrison%principles%'`).\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n- **Handle author initials with precision.** If a user searches for an author with initials typed without dots (e.g., \"HC Verma\", \"JRR Tolkien\"), you MUST reformat them by inserting a dot `.` between each initial letter in the `LIKE` clause. For example, a search for \"HC Verma\" should generate a clause like `WHERE AuthorName1 LIKE '%H.C%Verma%'`. This ensures you find authors formatted as 'H.C. Verma' or 'H.C Verma' without incorrectly matching other names. \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- **Crucial Rule:** If a user specifies a category AND a related topic (e.g., \"science fiction books about space exploration\"), you MUST combine them with an `OR` to broaden the search. The query should look for books that are either in the category OR match the topic in the title. For example: `WHERE (Category_Name LIKE '%Science Fiction%' OR Product_Title LIKE '%space%exploration%')`. Using `AND` for this is too restrictive and will return poor results.\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: i want thriller stories"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Thriller%' AND Availability = 'Available' ORDER BY Ranking ASC;, Tokens Used: 2851
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'i want thriller stories'. Current cache size: 4
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 6.5126 seconds.
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Sending book filtering query to DeepSeek. User Query: 'i want thriller stories', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "The user asked: \"i want thriller stories\" \nBelow is a list of books retrieved from a database. Each book is prefixed with its 1-based number.\nYour task is to act as a helpful librarian and choose the book numbers that are the **most relevant** to what the user is looking for. \n**Key Filtering Rules:** \n- Prioritize books that seem most relevant based on the title, author, and category. \n- Consider semantic relevance and user intent. \n- **It is better to return a few closely related books than to return an empty list.** If there are no perfect matches, select the books that are the next best fit. \n\nBook list (Book Number. Title: ..., Author: ..., Category: ..., Price: ...): \n1. Title: Never Lie : A Totally Gripping Thriller with Mind-bending Twists, Author: McFadden, The Housemaid Freida, Category: Thriller / suspense, Price: \u20b9N/A\n2. Title: The Housemaid : An addictive psychological thriller with mind-bending twists, Author: Freida McFadden, Category: Thriller / suspense, Price: \u20b9N/A\n3. Title: That Night, Author: Nidhi Upadhyay, Category: Thriller / suspense, Price: \u20b9N/A\n4. Title: Shatter Me, Author: Tahereh Mafi, Category: Thrillers (children\u2019s/ya), Price: \u20b9N/A\n5. Title: The Inheritance Games, Author: Jennifer Lynn Barnes, Category: Thrillers (children\u2019s/ya), Price: \u20b9N/A\n6. Title: The Reappearance of Rachel Price: A sensational new young adult thriller for 2024 from the award-winning author of the bestselling A Good Girls Guide to Murder., Author: Holly Jackson, Category: Thrillers (children\u2019s/ya), Price: \u20b9N/A\n7. Title: One Of Us Is Lying, Author: Karen McManus, Category: Thrillers (children\u2019s/ya), Price: \u20b9N/A\n8. Title: I Hear You, Author: Nidhi Upadhyay, Category: Thriller / suspense, Price: \u20b9N/A\n9. Title: Dark Matter, Author: Crouch, Blake, Category: Thriller / suspense, Price: \u20b9N/A\n10. Title: Five Survive: AN INSTANT NUMBER 1 NYT BESTSELLER AND SUNDAY TIMES BESTSELLER! An explosive new crime thriller for summer from the award-winning author of A Good Girls Guide to Murder., Author: Holly Jackson, Category: Thrillers (children\u2019s/ya), Price: \u20b9N/A\n11. Title: The Mussoorie Murders, Author: Divyaroop Bhatnagar, Category: Thriller / suspense, Price: \u20b9N/A\n12. Title: The Housemaid's Secret : A totally gripping psychological thriller with a shocking twist, Author: McFadden, Freida, Category: Thriller / suspense, Price: \u20b9N/A\n13. Title: Girl Who Knew Too Much, Author: Vikrant Khanna, Category: Thriller / suspense, Price: \u20b9N/A\n14. Title: The Locked Door, Author: Freida McFadden, Category: Thriller / suspense, Price: \u20b9N/A\n15. Title: Then She Was Gone, Author: Lisa Jewell, Category: Thriller / suspense, Price: \u20b9N/A \n\n**Strict Output Format:** \nReturn ONLY the book numbers (e.g., 1, 2, 5) of the most relevant books in a JSON array format like: \n[1, 2, 5] \nIf absolutely no books are even remotely relevant, you can return an empty array: [] \nDo not include any other text, markdown, or comments."}], "temperature": 0.3, "stream": false, "max_tokens": 100}
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Received raw response from DeepSeek for filtering. Response: [1, 2, 3, 8, 9, 11, 12, 13, 14, 15]
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Filtered Indices (0-based): [0, 1, 2, 7, 8, 10, 11, 12, 13, 14]
app.py:chat: Request: User query: 'okay now give me books by hc verma', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'okay now give me books by hc verma', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Perform spell correction on book titles and author names before creating the query.** If a user asks for \"Harrisan princples\", you should recognize this is likely a typo for \"Harrison principles\" and generate the query using the corrected terms (e.g., `WHERE Product_Title LIKE '%Harrison%principles%'`).\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n- **Handle author initials with precision.** If a user searches for an author with initials typed without dots (e.g., \"HC Verma\", \"JRR Tolkien\"), you MUST reformat them by inserting a dot `.` between each initial letter in the `LIKE` clause. For example, a search for \"HC Verma\" should generate a clause like `WHERE AuthorName1 LIKE '%H.C%Verma%'`. This ensures you find authors formatted as 'H.C. Verma' or 'H.C Verma' without incorrectly matching other names. \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- **Crucial Rule:** If a user specifies a category AND a related topic (e.g., \"science fiction books about space exploration\"), you MUST combine them with an `OR` to broaden the search. The query should look for books that are either in the category OR match the topic in the title. For example: `WHERE (Category_Name LIKE '%Science Fiction%' OR Product_Title LIKE '%space%exploration%')`. Using `AND` for this is too restrictive and will return poor results.\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: okay now give me books by hc verma"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%H.C%Verma%' AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2862
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'okay now give me books by hc verma'. Current cache size: 5
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 6.7751 seconds.
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Sending book filtering query to DeepSeek. User Query: 'okay now give me books by hc verma', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "The user asked: \"okay now give me books by hc verma\" \nBelow is a list of books retrieved from a database. Each book is prefixed with its 1-based number.\nYour task is to act as a helpful librarian and choose the book numbers that are the **most relevant** to what the user is looking for. \n**Key Filtering Rules:** \n- Prioritize books that seem most relevant based on the title, author, and category. \n- Consider semantic relevance and user intent. \n- **It is better to return a few closely related books than to return an empty list.** If there are no perfect matches, select the books that are the next best fit. \n\nBook list (Book Number. Title: ..., Author: ..., Category: ..., Price: ...): \n1. Title: MCQ in Veterinary Science, Author: Rajesh Kumar, R.P Diwakar|J.S Rajoriya, H.C verma|Ramakant, Category: General, Price: \u20b9N/A\n2. Title: Industrial Families in India, Author: H.C. Verma, Category: General, Price: \u20b9N/A\n3. Title: Calculus: The Princess of Mathematics Volume- 1, Author: H.C. Verma, Category: General, Price: \u20b9N/A\n4. Title: Harvesting Water and Rationlization Of Agriculture In North Medieval India, Author: H.C. Verma, Category: Uncategorized, Price: \u20b9N/A \n\n**Strict Output Format:** \nReturn ONLY the book numbers (e.g., 1, 2, 5) of the most relevant books in a JSON array format like: \n[1, 2, 5] \nIf absolutely no books are even remotely relevant, you can return an empty array: [] \nDo not include any other text, markdown, or comments."}], "temperature": 0.3, "stream": false, "max_tokens": 100}
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Received raw response from DeepSeek for filtering. Response: [2, 3]
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Filtered Indices (0-based): [1, 2]
app.py:chat: Request: User query: 'also show me books from JRR Tolkien', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'also show me books from JRR Tolkien', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Perform spell correction on book titles and author names before creating the query.** If a user asks for \"Harrisan princples\", you should recognize this is likely a typo for \"Harrison principles\" and generate the query using the corrected terms (e.g., `WHERE Product_Title LIKE '%Harrison%principles%'`).\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n- **Handle author initials with precision.** If a user searches for an author with initials typed without dots (e.g., \"HC Verma\", \"JRR Tolkien\"), you MUST reformat them by inserting a dot `.` between each initial letter in the `LIKE` clause. For example, a search for \"HC Verma\" should generate a clause like `WHERE AuthorName1 LIKE '%H.C%Verma%'`. This ensures you find authors formatted as 'H.C. Verma' or 'H.C Verma' without incorrectly matching other names. \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- **Crucial Rule:** If a user specifies a category AND a related topic (e.g., \"science fiction books about space exploration\"), you MUST combine them with an `OR` to broaden the search. The query should look for books that are either in the category OR match the topic in the title. For example: `WHERE (Category_Name LIKE '%Science Fiction%' OR Product_Title LIKE '%space%exploration%')`. Using `AND` for this is too restrictive and will return poor results.\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: also show me books from JRR Tolkien"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%J.R.R%Tolkien%' AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2861
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'also show me books from JRR Tolkien'. Current cache size: 6
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 7.3356 seconds.
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Sending book filtering query to DeepSeek. User Query: 'also show me books from JRR Tolkien', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "The user asked: \"also show me books from JRR Tolkien\" \nBelow is a list of books retrieved from a database. Each book is prefixed with its 1-based number.\nYour task is to act as a helpful librarian and choose the book numbers that are the **most relevant** to what the user is looking for. \n**Key Filtering Rules:** \n- Prioritize books that seem most relevant based on the title, author, and category. \n- Consider semantic relevance and user intent. \n- **It is better to return a few closely related books than to return an empty list.** If there are no perfect matches, select the books that are the next best fit. \n\nBook list (Book Number. Title: ..., Author: ..., Category: ..., Price: ...): \n1. Title: The Hobbit & The Lord of the Rings Boxed Set, Author: J.R.R.Tolkien, Category: Fantasy, Price: \u20b9N/A\n2. Title: Two Towers, Author: J.R.R. Tolkien, Category: Classic fiction, Price: \u20b9N/A\n3. Title: J.R.R. Tolkien 4-Book Boxed Set: The Hobbit and The Lord of the Rings, Author: J.R.R. Tolkien, Category: General, Price: \u20b9N/A\n4. Title: The Return of the King, Author: J.R.R.Tolkien, Category: Fantasy, Price: \u20b9N/A\n5. Title: Silmarillion, Author: J.R.R. Tolkien, Category: Fantasy, Price: \u20b9N/A\n6. Title: Hobbit, Author: J.R.R. Tolkien, Category: Classic fiction, Price: \u20b9N/A\n7. Title: The Lord Of The Rings, Author: J.R.R. Tolkien, Category: General, Price: \u20b9N/A\n8. Title: Tolkien Fantasy Tales Box Set (the Tolkien Reader, the Silmarillion, Unfinished Tales, Sir Gawain and the Green Knight), Author: J.R.R. Tolkien, Category: Fantasy, Price: \u20b9N/A\n9. Title: Return of the King, Author: J.R.R. Tolkien, Category: Classic fiction, Price: \u20b9N/A\n10. Title: Fellowship of the Ring, Author: J.R.R. Tolkien, Category: Fantasy, Price: \u20b9N/A\n11. Title: Lays of Beleriand, Author: J.R.R. Tolkien, Category: Fantasy, Price: \u20b9N/A\n12. Title: Unfinished Tales, Author: J.R.R. Tolkien, Category: Fantasy, Price: \u20b9N/A\n13. Title: Fellowship of the Ring, Author: J.R.R. Tolkien, Category: Fantasy, Price: \u20b9N/A\n14. Title: Tolkien Reader, Author: J.R.R. Tolkien, Category: Fantasy, Price: \u20b9N/A\n15. Title: Tales Before Narnia, Author: J.R.R. Tolkien, Category: Fantasy, Price: \u20b9N/A \n\n**Strict Output Format:** \nReturn ONLY the book numbers (e.g., 1, 2, 5) of the most relevant books in a JSON array format like: \n[1, 2, 5] \nIf absolutely no books are even remotely relevant, you can return an empty array: [] \nDo not include any other text, markdown, or comments."}], "temperature": 0.3, "stream": false, "max_tokens": 100}
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Received raw response from DeepSeek for filtering. Response: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14]
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Filtered Indices (0-based): [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13]
app.py:chat: Request: User query: 'and give me something to read by apj abdul kalam', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'and give me something to read by apj abdul kalam', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Perform spell correction on book titles and author names before creating the query.** If a user asks for \"Harrisan princples\", you should recognize this is likely a typo for \"Harrison principles\" and generate the query using the corrected terms (e.g., `WHERE Product_Title LIKE '%Harrison%principles%'`).\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n- **Handle author initials with precision.** If a user searches for an author with initials typed without dots (e.g., \"HC Verma\", \"JRR Tolkien\"), you MUST reformat them by inserting a dot `.` between each initial letter in the `LIKE` clause. For example, a search for \"HC Verma\" should generate a clause like `WHERE AuthorName1 LIKE '%H.C%Verma%'`. This ensures you find authors formatted as 'H.C. Verma' or 'H.C Verma' without incorrectly matching other names. \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- **Crucial Rule:** If a user specifies a category AND a related topic (e.g., \"science fiction books about space exploration\"), you MUST combine them with an `OR` to broaden the search. The query should look for books that are either in the category OR match the topic in the title. For example: `WHERE (Category_Name LIKE '%Science Fiction%' OR Product_Title LIKE '%space%exploration%')`. Using `AND` for this is too restrictive and will return poor results.\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: and give me something to read by apj abdul kalam"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%A.P.J%Abdul%Kalam%' AND Availability = 'Available' ORDER BY Ranking ASC;, Tokens Used: 2867
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'and give me something to read by apj abdul kalam'. Current cache size: 7
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 6.7110 seconds.
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Sending book filtering query to DeepSeek. User Query: 'and give me something to read by apj abdul kalam', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "The user asked: \"and give me something to read by apj abdul kalam\" \nBelow is a list of books retrieved from a database. Each book is prefixed with its 1-based number.\nYour task is to act as a helpful librarian and choose the book numbers that are the **most relevant** to what the user is looking for. \n**Key Filtering Rules:** \n- Prioritize books that seem most relevant based on the title, author, and category. \n- Consider semantic relevance and user intent. \n- **It is better to return a few closely related books than to return an empty list.** If there are no perfect matches, select the books that are the next best fit. \n\nBook list (Book Number. Title: ..., Author: ..., Category: ..., Price: ...): \n1. Title: My Journey, Author: A.P.J. Abdul Kalam, Category: Biography: historical, political & military, Price: \u20b9N/A\n2. Title: IGNITED MINDS, Author: A.P.J. Abdul Kalam, Category: Biographies & Memoirs, Price: \u20b9N/A\n3. Title: Learning How to Fly, Author: A.P.J. Abdul Kalam, Category: Assertiveness, motivation & self-esteem, Price: \u20b9N/A\n4. Title: You are Born to Blossom, Author: A.P.J. Abdul Kalam, Category: General, Price: \u20b9N/A\n5. Title: Agnipankh (Marathi), Author: A.P.J. Abdul Kalam, Category: General, Price: \u20b9N/A\n6. Title: Inspiring Thoughts, Author: A.P.J. Abdul Kalam, Category: General, Price: \u20b9N/A\n7. Title: Turning Points : A Journey Through Challenges, Author: A.P.J. Abdul Kalam, Category: Personal finance, Price: \u20b9N/A\n8. Title: Meri Jeevan Yatra, Author: A.P.J. Abdul Kalam, Category: Modern & contemporary fiction, Price: \u20b9N/A\n9. Title: Forge Your Future, Author: A.P.J. Abdul Kalam, Category: Mind, body, spirit: thought & practice, Price: \u20b9N/A\n10. Title: Mera Bharat, Author: A.P.J. Abdul Kalam, Category: General, Price: \u20b9N/A\n11. Title: Aapka Bhavishya Aapke Haath Mein, Author: A.P.J. Abdul Kalam, Category: Mind, body, spirit: thought & practice, Price: \u20b9N/A\n12. Title: Reignited, Author: Abdul A.P.J. Kalam, Category: Educational: sciences, general science, Price: \u20b9N/A\n13. Title: Life Tree, Author: A.P.J. Abdul Kalam, Category: Poetry anthologies (various poets), Price: \u20b9N/A\n14. Title: My India, Author: A.P.J. Abdul Kalam, Category: Society & culture: general, Price: \u20b9N/A\n15. Title: Success Mantra of BrahMos, Author: Foreword by A.P.J. Abdul Kalam, Category: General, Price: \u20b9N/A \n\n**Strict Output Format:** \nReturn ONLY the book numbers (e.g., 1, 2, 5) of the most relevant books in a JSON array format like: \n[1, 2, 5] \nIf absolutely no books are even remotely relevant, you can return an empty array: [] \nDo not include any other text, markdown, or comments."}], "temperature": 0.3, "stream": false, "max_tokens": 100}
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Received raw response from DeepSeek for filtering. Response: [1, 2, 3, 4, 6, 7, 9, 11, 12, 14]
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Filtered Indices (0-based): [0, 1, 2, 3, 5, 6, 8, 10, 11, 13]
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'books by hc verma', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'books by hc verma', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Perform spell correction on book titles and author names before creating the query.** If a user asks for \"Harrisan princples\", you should recognize this is likely a typo for \"Harrison principles\" and generate the query using the corrected terms (e.g., `WHERE Product_Title LIKE '%Harrison%principles%'`).\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n- **Handle author initials with precision.** If a user searches for an author with initials typed without dots (e.g., \"HC Verma\", \"JRR Tolkien\"), you MUST reformat them by inserting a dot `.` between each initial letter in the `LIKE` clause. For example, a search for \"HC Verma\" should generate a clause like `WHERE AuthorName1 LIKE '%H.C%Verma%'`. This ensures you find authors formatted as 'H.C. Verma' or 'H.C Verma' without incorrectly matching other names. \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- **Crucial Rule:** If a user specifies a category AND a related topic (e.g., \"science fiction books about space exploration\"), you MUST combine them with an `OR` to broaden the search. The query should look for books that are either in the category OR match the topic in the title. For example: `WHERE (Category_Name LIKE '%Science Fiction%' OR Product_Title LIKE '%space%exploration%')`. Using `AND` for this is too restrictive and will return poor results.\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: books by hc verma"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%H.C%Verma%' AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2858
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'books by hc verma'. Current cache size: 1
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 6.7945 seconds.
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Sending book filtering query to DeepSeek. User Query: 'books by hc verma', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "The user asked: \"books by hc verma\" \nBelow is a list of books retrieved from a database. Each book is prefixed with its 1-based number.\nYour task is to act as a helpful librarian and choose the book numbers that are the **most relevant** to what the user is looking for. \n**Key Filtering Rules:** \n- Prioritize books that seem most relevant based on the title, author, and category. \n- Consider semantic relevance and user intent. \n- **It is better to return a few closely related books than to return an empty list.** If there are no perfect matches, select the books that are the next best fit. \n\nBook list (Book Number. Title: ..., Author: ..., Category: ..., Price: ...): \n1. Title: MCQ in Veterinary Science, Author: Rajesh Kumar, R.P Diwakar|J.S Rajoriya, H.C verma|Ramakant, Category: General, Price: \u20b9N/A\n2. Title: Industrial Families in India, Author: H.C. Verma, Category: General, Price: \u20b9N/A\n3. Title: Harvesting Water and Rationlization Of Agriculture In North Medieval India, Author: H.C. Verma, Category: Uncategorized, Price: \u20b9N/A\n4. Title: Calculus: The Princess of Mathematics Volume- 1, Author: H.C. Verma, Category: General, Price: \u20b9N/A \n\n**Strict Output Format:** \nReturn ONLY the book numbers (e.g., 1, 2, 5) of the most relevant books in a JSON array format like: \n[1, 2, 5] \nIf absolutely no books are even remotely relevant, you can return an empty array: [] \nDo not include any other text, markdown, or comments."}], "temperature": 0.3, "stream": false, "max_tokens": 100}
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Received raw response from DeepSeek for filtering. Response: [2, 3, 4]
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Filtered Indices (0-based): [1, 2, 3]
app.py:chat: Request: User query: 'also give books by apj abdul kalam', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'also give books by apj abdul kalam', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Perform spell correction on book titles and author names before creating the query.** If a user asks for \"Harrisan princples\", you should recognize this is likely a typo for \"Harrison principles\" and generate the query using the corrected terms (e.g., `WHERE Product_Title LIKE '%Harrison%principles%'`).\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n- **Handle author initials with precision.** If a user searches for an author with initials typed without dots (e.g., \"HC Verma\", \"JRR Tolkien\"), you MUST reformat them by inserting a dot `.` between each initial letter in the `LIKE` clause. For example, a search for \"HC Verma\" should generate a clause like `WHERE AuthorName1 LIKE '%H.C%Verma%'`. This ensures you find authors formatted as 'H.C. Verma' or 'H.C Verma' without incorrectly matching other names. \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- **Crucial Rule:** If a user specifies a category AND a related topic (e.g., \"science fiction books about space exploration\"), you MUST combine them with an `OR` to broaden the search. The query should look for books that are either in the category OR match the topic in the title. For example: `WHERE (Category_Name LIKE '%Science Fiction%' OR Product_Title LIKE '%space%exploration%')`. Using `AND` for this is too restrictive and will return poor results.\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: also give books by apj abdul kalam"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%A.P.J%Abdul%Kalam%' AND Availability = 'Available' ORDER BY Ranking ASC;, Tokens Used: 2864
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'also give books by apj abdul kalam'. Current cache size: 2
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 7.3149 seconds.
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Sending book filtering query to DeepSeek. User Query: 'also give books by apj abdul kalam', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "The user asked: \"also give books by apj abdul kalam\" \nBelow is a list of books retrieved from a database. Each book is prefixed with its 1-based number.\nYour task is to act as a helpful librarian and choose the book numbers that are the **most relevant** to what the user is looking for. \n**Key Filtering Rules:** \n- Prioritize books that seem most relevant based on the title, author, and category. \n- Consider semantic relevance and user intent. \n- **It is better to return a few closely related books than to return an empty list.** If there are no perfect matches, select the books that are the next best fit. \n\nBook list (Book Number. Title: ..., Author: ..., Category: ..., Price: ...): \n1. Title: My Journey, Author: A.P.J. Abdul Kalam, Category: Biography: historical, political & military, Price: \u20b9N/A\n2. Title: IGNITED MINDS, Author: A.P.J. Abdul Kalam, Category: Biographies & Memoirs, Price: \u20b9N/A\n3. Title: Learning How to Fly, Author: A.P.J. Abdul Kalam, Category: Assertiveness, motivation & self-esteem, Price: \u20b9N/A\n4. Title: You are Born to Blossom, Author: A.P.J. Abdul Kalam, Category: General, Price: \u20b9N/A\n5. Title: Agnipankh (Marathi), Author: A.P.J. Abdul Kalam, Category: General, Price: \u20b9N/A\n6. Title: Inspiring Thoughts, Author: A.P.J. Abdul Kalam, Category: General, Price: \u20b9N/A\n7. Title: Turning Points : A Journey Through Challenges, Author: A.P.J. Abdul Kalam, Category: Personal finance, Price: \u20b9N/A\n8. Title: Meri Jeevan Yatra, Author: A.P.J. Abdul Kalam, Category: Modern & contemporary fiction, Price: \u20b9N/A\n9. Title: Forge Your Future, Author: A.P.J. Abdul Kalam, Category: Mind, body, spirit: thought & practice, Price: \u20b9N/A\n10. Title: Mera Bharat, Author: A.P.J. Abdul Kalam, Category: General, Price: \u20b9N/A\n11. Title: Aapka Bhavishya Aapke Haath Mein, Author: A.P.J. Abdul Kalam, Category: Mind, body, spirit: thought & practice, Price: \u20b9N/A\n12. Title: Reignited, Author: Abdul A.P.J. Kalam, Category: Educational: sciences, general science, Price: \u20b9N/A\n13. Title: Life Tree, Author: A.P.J. Abdul Kalam, Category: Poetry anthologies (various poets), Price: \u20b9N/A\n14. Title: My India, Author: A.P.J. Abdul Kalam, Category: Society & culture: general, Price: \u20b9N/A\n15. Title: Success Mantra of BrahMos, Author: Foreword by A.P.J. Abdul Kalam, Category: General, Price: \u20b9N/A \n\n**Strict Output Format:** \nReturn ONLY the book numbers (e.g., 1, 2, 5) of the most relevant books in a JSON array format like: \n[1, 2, 5] \nIf absolutely no books are even remotely relevant, you can return an empty array: [] \nDo not include any other text, markdown, or comments."}], "temperature": 0.3, "stream": false, "max_tokens": 100}
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Received raw response from DeepSeek for filtering. Response: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14]
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Filtered Indices (0-based): [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13]
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'science fiction books about space travel', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'science fiction books about space travel', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Perform spell correction on book titles and author names before creating the query.** If a user asks for \"Harrisan princples\", you should recognize this is likely a typo for \"Harrison principles\" and generate the query using the corrected terms (e.g., `WHERE Product_Title LIKE '%Harrison%principles%'`).\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n- **Handle author initials with precision.** If a user searches for an author with initials typed without dots (e.g., \"HC Verma\", \"JRR Tolkien\"), you MUST reformat them by inserting a dot `.` between each initial letter in the `LIKE` clause. For example, a search for \"HC Verma\" should generate a clause like `WHERE AuthorName1 LIKE '%H.C%Verma%'`. This ensures you find authors formatted as 'H.C. Verma' or 'H.C Verma' without incorrectly matching other names. \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- **Crucial Rule:** If a user specifies a category AND a related topic (e.g., \"science fiction books about space exploration\"), you MUST combine them with an `OR` to broaden the search. The query should look for books that are either in the category OR match the topic in the title. For example: `WHERE (Category_Name LIKE '%Science Fiction%' OR Product_Title LIKE '%space%exploration%')`. Using `AND` for this is too restrictive and will return poor results.\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: science fiction books about space travel"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (Category_Name LIKE '%Science Fiction%' OR Product_Title LIKE '%space%travel%') AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2866
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'science fiction books about space travel'. Current cache size: 1
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 8.4408 seconds.
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Sending book filtering query to DeepSeek. User Query: 'science fiction books about space travel', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "The user asked: \"science fiction books about space travel\" \nBelow is a list of books retrieved from a database. Each book is prefixed with its 1-based number.\nYour task is to act as a helpful librarian and choose the book numbers that are the **most relevant** to what the user is looking for. \n**Key Filtering Rules:** \n- Prioritize books that seem most relevant based on the title, author, and category. \n- Consider semantic relevance and user intent. \n- **It is better to return a few closely related books than to return an empty list.** If there are no perfect matches, select the books that are the next best fit. \n\nBook list (Book Number. Title: ..., Author: ..., Category: ..., Price: ...): \n1. Title: Harry Potter and the Chamber of Secrets (Harry Potter, Book 2) (Minalima Edition), Author: J K ROWLING, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A\n2. Title: Harry Potter Hardcover Boxed Set: Books 1-7 (Trunk), Author: J K ROWLING, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A\n3. Title: Hawaldar Bahadur Aur Karamati Bakra, Author: Sahil, Category: Science fiction, Price: \u20b9N/A\n4. Title: Harry Potter: The Illustrated Collection (Books 1-3 Boxed Set), Author: Jim Kay, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A\n5. Title: Harry Potter Paperback Boxed Set: Books 1-7, Author: J K ROWLING, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A\n6. Title: Unravel Me, Author: Tahereh Mafi, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A\n7. Title: Lucifer was Innocent, Author: Tirth Raj Parsana, Category: Science fiction, Price: \u20b9N/A\n8. Title: Dune, Author: Frank Herbert, Category: Science fiction, Price: \u20b9N/A\n9. Title: Harry Potter Books 1-3 Boxed Set (Minalima Editions), Author: J K ROWLING, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A\n10. Title: Three-Body Problem, Author: Cixin Liu, Category: Science fiction, Price: \u20b9N/A\n11. Title: Red Rising, Author: Pierce Brown, Category: Science fiction, Price: \u20b9N/A\n12. Title: The Three-Body Problem Boxset, Author: , Category: Science fiction, Price: \u20b9N/A\n13. Title: Girl Who Drank the Moon, Author: Kelly Barnhill, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A\n14. Title: The Three-Body Problem, Author: Liu Cixin, Category: Science fiction, Price: \u20b9N/A\n15. Title: Harry Potter Wizarding Almanac: The Official Magical Companion to J.K. Rowling's Harry Potter Books, Author: Levi Pinfold, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A \n\n**Strict Output Format:** \nReturn ONLY the book numbers (e.g., 1, 2, 5) of the most relevant books in a JSON array format like: \n[1, 2, 5] \nIf absolutely no books are even remotely relevant, you can return an empty array: [] \nDo not include any other text, markdown, or comments."}], "temperature": 0.3, "stream": false, "max_tokens": 100}
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Received raw response from DeepSeek for filtering. Response: [8, 10, 11, 12, 14]
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Filtered Indices (0-based): [7, 9, 10, 11, 13]
app.py:chat: Request: User query: 'history books about ancient rone', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'history books about ancient rone', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Perform spell correction on book titles and author names before creating the query.** If a user asks for \"Harrisan princples\", you should recognize this is likely a typo for \"Harrison principles\" and generate the query using the corrected terms (e.g., `WHERE Product_Title LIKE '%Harrison%principles%'`).\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n- **Handle author initials with precision.** If a user searches for an author with initials typed without dots (e.g., \"HC Verma\", \"JRR Tolkien\"), you MUST reformat them by inserting a dot `.` between each initial letter in the `LIKE` clause. For example, a search for \"HC Verma\" should generate a clause like `WHERE AuthorName1 LIKE '%H.C%Verma%'`. This ensures you find authors formatted as 'H.C. Verma' or 'H.C Verma' without incorrectly matching other names. \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- **Crucial Rule:** If a user specifies a category AND a related topic (e.g., \"science fiction books about space exploration\"), you MUST combine them with an `OR` to broaden the search. The query should look for books that are either in the category OR match the topic in the title. For example: `WHERE (Category_Name LIKE '%Science Fiction%' OR Product_Title LIKE '%space%exploration%')`. Using `AND` for this is too restrictive and will return poor results.\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: history books about ancient rone"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (Category_Name LIKE '%History%' OR Product_Title LIKE '%ancient%Rome%') AND Availability = 'Available' ORDER BY Ranking ASC;, Tokens Used: 2864
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'history books about ancient rone'. Current cache size: 2
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 7.5107 seconds.
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Sending book filtering query to DeepSeek. User Query: 'history books about ancient rone', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "The user asked: \"history books about ancient rone\" \nBelow is a list of books retrieved from a database. Each book is prefixed with its 1-based number.\nYour task is to act as a helpful librarian and choose the book numbers that are the **most relevant** to what the user is looking for. \n**Key Filtering Rules:** \n- Prioritize books that seem most relevant based on the title, author, and category. \n- Consider semantic relevance and user intent. \n- **It is better to return a few closely related books than to return an empty list.** If there are no perfect matches, select the books that are the next best fit. \n\nBook list (Book Number. Title: ..., Author: ..., Category: ..., Price: ...): \n1. Title: Spelling Time - Activity Workbook, Author: NA, Category: Educational: history, Price: \u20b9N/A\n2. Title: Addition and Subtraction Activity Book, Author: NA, Category: Educational: history, Price: \u20b9N/A\n3. Title: Arthashastra, Author: Kautilya, Category: Asian history, Price: \u20b9N/A\n4. Title: Deportation Machine, Author: Adam Goodman, Category: History of the americas, Price: \u20b9N/A\n5. Title: Sapiens (L), Author: Yuval Noah Harari, Category: General & world history, Price: \u20b9N/A\n6. Title: Globalisation and Market Outcomes, Author: V Kurien Baby, Category: Economic history, Price: \u20b9N/A\n7. Title: Alphabet Phonics, Author: Wonder House Books, Category: History & the past: general interest (children\u2019s/ya), Price: \u20b9N/A\n8. Title: Tuesdays With Morrie, Author: Mitch Albom, Category: General & world history, Price: \u20b9N/A\n9. Title: World History: Collection of 6 Books, Author: Wonder House Books, Category: History of architecture, Price: \u20b9N/A\n10. Title: 112 Meditations for Self Realization, Author: RANJIT CHAUDHRI, Category: History, Price: \u20b9N/A\n11. Title: Why Bharat Matters, Author: S. Jaishankar, Category: Asian history, Price: \u20b9N/A\n12. Title: Balidan : Stories of India's Greatest Para Special Forces Operatives, Author: Swapnil Pandey , Category: Military history, Price: \u20b9N/A\n13. Title: India's Ancient Past | By R.S Sharma | Best Seller For UPSC Aspirants And Undergraduate Students Of History Major, Author: R.S. Sharma, Category: History, Price: \u20b9N/A\n14. Title: Fun Time Reading Comprehension: Level 1, Author: NA, Category: Educational: history, Price: \u20b9N/A\n15. Title: India's Struggle for Independence 1857-1947, Author: Au, Category: African history, Price: \u20b9N/A \n\n**Strict Output Format:** \nReturn ONLY the book numbers (e.g., 1, 2, 5) of the most relevant books in a JSON array format like: \n[1, 2, 5] \nIf absolutely no books are even remotely relevant, you can return an empty array: [] \nDo not include any other text, markdown, or comments."}], "temperature": 0.3, "stream": false, "max_tokens": 100}
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Received raw response from DeepSeek for filtering. Response: []
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Filtered Indices (0-based): []
app.py:chat: Request: Bot response: 

I fetched some titles, but none seemed quite right. Try a slightly different request?
app.py:chat: Request: User query: 'history books about ancient rome', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'history books about ancient rome', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Perform spell correction on book titles and author names before creating the query.** If a user asks for \"Harrisan princples\", you should recognize this is likely a typo for \"Harrison principles\" and generate the query using the corrected terms (e.g., `WHERE Product_Title LIKE '%Harrison%principles%'`).\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n- **Handle author initials with precision.** If a user searches for an author with initials typed without dots (e.g., \"HC Verma\", \"JRR Tolkien\"), you MUST reformat them by inserting a dot `.` between each initial letter in the `LIKE` clause. For example, a search for \"HC Verma\" should generate a clause like `WHERE AuthorName1 LIKE '%H.C%Verma%'`. This ensures you find authors formatted as 'H.C. Verma' or 'H.C Verma' without incorrectly matching other names. \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- **Crucial Rule:** If a user specifies a category AND a related topic (e.g., \"science fiction books about space exploration\"), you MUST combine them with an `OR` to broaden the search. The query should look for books that are either in the category OR match the topic in the title. For example: `WHERE (Category_Name LIKE '%Science Fiction%' OR Product_Title LIKE '%space%exploration%')`. Using `AND` for this is too restrictive and will return poor results.\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: history books about ancient rome"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (Category_Name LIKE '%History%' OR Product_Title LIKE '%ancient%Rome%') AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2866
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'history books about ancient rome'. Current cache size: 3
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 7.1133 seconds.
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Sending book filtering query to DeepSeek. User Query: 'history books about ancient rome', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "The user asked: \"history books about ancient rome\" \nBelow is a list of books retrieved from a database. Each book is prefixed with its 1-based number.\nYour task is to act as a helpful librarian and choose the book numbers that are the **most relevant** to what the user is looking for. \n**Key Filtering Rules:** \n- Prioritize books that seem most relevant based on the title, author, and category. \n- Consider semantic relevance and user intent. \n- **It is better to return a few closely related books than to return an empty list.** If there are no perfect matches, select the books that are the next best fit. \n\nBook list (Book Number. Title: ..., Author: ..., Category: ..., Price: ...): \n1. Title: Spelling Time - Activity Workbook, Author: NA, Category: Educational: history, Price: \u20b9N/A\n2. Title: Addition and Subtraction Activity Book, Author: NA, Category: Educational: history, Price: \u20b9N/A\n3. Title: Arthashastra, Author: Kautilya, Category: Asian history, Price: \u20b9N/A\n4. Title: The Silent Patient, Author: Alex Michaelides, Category: History of art: ancient & classical art,bce to c 5, Price: \u20b9N/A\n5. Title: Deportation Machine, Author: Adam Goodman, Category: History of the americas, Price: \u20b9N/A\n6. Title: Sapiens (L), Author: Yuval Noah Harari, Category: General & world history, Price: \u20b9N/A\n7. Title: Globalisation and Market Outcomes, Author: V Kurien Baby, Category: Economic history, Price: \u20b9N/A\n8. Title: Alphabet Phonics, Author: Wonder House Books, Category: History & the past: general interest (children\u2019s/ya), Price: \u20b9N/A\n9. Title: Tuesdays With Morrie, Author: Mitch Albom, Category: General & world history, Price: \u20b9N/A\n10. Title: World History: Collection of 6 Books, Author: Wonder House Books, Category: History of architecture, Price: \u20b9N/A\n11. Title: 112 Meditations for Self Realization, Author: RANJIT CHAUDHRI, Category: History, Price: \u20b9N/A\n12. Title: Why Bharat Matters, Author: S. Jaishankar, Category: Asian history, Price: \u20b9N/A\n13. Title: Balidan : Stories of India's Greatest Para Special Forces Operatives, Author: Swapnil Pandey , Category: Military history, Price: \u20b9N/A\n14. Title: Christian Dior, Author: Megan Hess, Category: History of art / art & design styles, Price: \u20b9N/A\n15. Title: India's Ancient Past | By R.S Sharma | Best Seller For UPSC Aspirants And Undergraduate Students Of History Major, Author: R.S. Sharma, Category: History, Price: \u20b9N/A \n\n**Strict Output Format:** \nReturn ONLY the book numbers (e.g., 1, 2, 5) of the most relevant books in a JSON array format like: \n[1, 2, 5] \nIf absolutely no books are even remotely relevant, you can return an empty array: [] \nDo not include any other text, markdown, or comments."}], "temperature": 0.3, "stream": false, "max_tokens": 100}
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Received raw response from DeepSeek for filtering. Response: [15]
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Filtered Indices (0-based): [14]
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'history books about ancient rome', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'history books about ancient rome', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Crucial Rule for Accuracy: You MUST correct obvious spelling errors in user queries before generating the SQL.** For example, if a user asks for 'ancient rone', you must recognize this as a typo for 'ancient rome' and generate the query using the corrected term (e.g., `WHERE Product_Title LIKE '%ancient%rome%'`). Failing to correct typos will lead to no results and a bad user experience.\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n- **Handle author initials with precision.** If a user searches for an author with initials typed without dots (e.g., \"HC Verma\", \"JRR Tolkien\"), you MUST reformat them by inserting a dot `.` between each initial letter in the `LIKE` clause. For example, a search for \"HC Verma\" should generate a clause like `WHERE AuthorName1 LIKE '%H.C%Verma%'`. This ensures you find authors formatted as 'H.C. Verma' or 'H.C Verma' without incorrectly matching other names. \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- **Crucial Rule:** If a user specifies a category AND a related topic (e.g., \"science fiction books about space exploration\"), you MUST combine them with an `OR` to broaden the search. The query should look for books that are either in the category OR match the topic in the title. For example: `WHERE (Category_Name LIKE '%Science Fiction%' OR Product_Title LIKE '%space%exploration%')`. Using `AND` for this is too restrictive and will return poor results.\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: history books about ancient rome"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (Category_Name LIKE '%History%' OR Product_Title LIKE '%ancient%rome%') AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2891
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'history books about ancient rome'. Current cache size: 1
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 7.3036 seconds.
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Sending book filtering query to DeepSeek. User Query: 'history books about ancient rome', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "The user asked: \"history books about ancient rome\" \nBelow is a list of books retrieved from a database. Each book is prefixed with its 1-based number.\nYour task is to act as a helpful librarian and choose the book numbers that are the **most relevant** to what the user is looking for. \n**Key Filtering Rules:** \n- Prioritize books that seem most relevant based on the title, author, and category. \n- Consider semantic relevance and user intent. \n- **It is better to return a few closely related books than to return an empty list.** If there are no perfect matches, select the books that are the next best fit. \n\nBook list (Book Number. Title: ..., Author: ..., Category: ..., Price: ...): \n1. Title: Spelling Time - Activity Workbook, Author: NA, Category: Educational: history, Price: \u20b9N/A\n2. Title: Addition and Subtraction Activity Book, Author: NA, Category: Educational: history, Price: \u20b9N/A\n3. Title: Arthashastra, Author: Kautilya, Category: Asian history, Price: \u20b9N/A\n4. Title: The Silent Patient, Author: Alex Michaelides, Category: History of art: ancient & classical art,bce to c 5, Price: \u20b9N/A\n5. Title: Deportation Machine, Author: Adam Goodman, Category: History of the americas, Price: \u20b9N/A\n6. Title: Sapiens (L), Author: Yuval Noah Harari, Category: General & world history, Price: \u20b9N/A\n7. Title: Globalisation and Market Outcomes, Author: V Kurien Baby, Category: Economic history, Price: \u20b9N/A\n8. Title: Alphabet Phonics, Author: Wonder House Books, Category: History & the past: general interest (children\u2019s/ya), Price: \u20b9N/A\n9. Title: Tuesdays With Morrie, Author: Mitch Albom, Category: General & world history, Price: \u20b9N/A\n10. Title: World History: Collection of 6 Books, Author: Wonder House Books, Category: History of architecture, Price: \u20b9N/A\n11. Title: 112 Meditations for Self Realization, Author: RANJIT CHAUDHRI, Category: History, Price: \u20b9N/A\n12. Title: Why Bharat Matters, Author: S. Jaishankar, Category: Asian history, Price: \u20b9N/A\n13. Title: Balidan : Stories of India's Greatest Para Special Forces Operatives, Author: Swapnil Pandey , Category: Military history, Price: \u20b9N/A\n14. Title: Christian Dior, Author: Megan Hess, Category: History of art / art & design styles, Price: \u20b9N/A\n15. Title: India's Ancient Past | By R.S Sharma | Best Seller For UPSC Aspirants And Undergraduate Students Of History Major, Author: R.S. Sharma, Category: History, Price: \u20b9N/A \n\n**Strict Output Format:** \nReturn ONLY the book numbers (e.g., 1, 2, 5) of the most relevant books in a JSON array format like: \n[1, 2, 5] \nIf absolutely no books are even remotely relevant, you can return an empty array: [] \nDo not include any other text, markdown, or comments."}], "temperature": 0.3, "stream": false, "max_tokens": 100}
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Received raw response from DeepSeek for filtering. Response: [15]
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Filtered Indices (0-based): [14]
app.py:chat: Request: User query: 'history books about ancient rome', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Cache hit for user query: 'history books about ancient rome'.
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Cache hit for user query: 'history books about ancient rome'.
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'is ikigai good for self help?', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'is ikigai good for self help?', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Crucial Rule for Accuracy: You MUST correct obvious spelling errors in user queries before generating the SQL.** For example, if a user asks for 'ancient rone', you must recognize this as a typo for 'ancient rome' and generate the query using the corrected term (e.g., `WHERE Product_Title LIKE '%ancient%rome%'`). Failing to correct typos will lead to no results and a bad user experience.\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n- **Handle author initials with precision.** If a user searches for an author with initials typed without dots (e.g., \"HC Verma\", \"JRR Tolkien\"), you MUST reformat them by inserting a dot `.` between each initial letter in the `LIKE` clause. For example, a search for \"HC Verma\" should generate a clause like `WHERE AuthorName1 LIKE '%H.C%Verma%'`. This ensures you find authors formatted as 'H.C. Verma' or 'H.C Verma' without incorrectly matching other names. \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- **Crucial Rule:** If a user specifies a category AND a related topic (e.g., \"science fiction books about space exploration\"), you MUST combine them with an `OR` to broaden the search. The query should look for books that are either in the category OR match the topic in the title. For example: `WHERE (Category_Name LIKE '%Science Fiction%' OR Product_Title LIKE '%space%exploration%')`. Using `AND` for this is too restrictive and will return poor results.\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: is ikigai good for self help?"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (Product_Title LIKE '%ikigai%' OR Category_Name LIKE '%Self-Help%') AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2895
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'is ikigai good for self help?'. Current cache size: 1
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 7.2976 seconds.
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Sending book filtering query to DeepSeek. User Query: 'is ikigai good for self help?', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "The user asked: \"is ikigai good for self help?\" \nBelow is a list of books retrieved from a database. Each book is prefixed with its 1-based number.\nYour task is to act as a helpful librarian and choose the book numbers that are the **most relevant** to what the user is looking for. \n**Key Filtering Rules:** \n- Prioritize books that seem most relevant based on the title, author, and category. \n- Consider semantic relevance and user intent. \n- **It is better to return a few closely related books than to return an empty list.** If there are no perfect matches, select the books that are the next best fit. \n\nBook list (Book Number. Title: ..., Author: ..., Category: ..., Price: ...): \n1. Title: Ikigai, Author: Francesc Miralles, Category: Oriental & indian philosophy, Price: \u20b9N/A\n2. Title: Ikigai, Author: Francesc Miralles, Category: Assertiveness, motivation & self-esteem, Price: \u20b9N/A\n3. Title: Ikigai (Hindi), Author: H\u00e9ctor Garc\u00eda, Francesc Miralles, Category: General, Price: \u20b9N/A\n4. Title: Ikigai, Author: Keira Miki, Category: Modern & contemporary fiction, Price: \u20b9N/A\n5. Title: Ikigai / \u00e0\u00a4\u2021\u00e0\u00a4\u2022\u00e0\u00a4\u00bf\u00e0\u00a4\u2014\u00e0\u00a4\u00be\u00e0\u00a4\u02c6 : The Japanese secret to a long and happy life in Marathi Book \u00e0\u00a4\u02c6\u00e0\u00a4\u2022\u00e0\u00a5\u20ac\u00e0\u00a4\u2014\u00e0\u00a4\u00be\u00e0\u00a4\u02c6 \u00e0\u00a4\u00a6\u00e0\u00a5\u20ac\u00e0\u00a4\u00b0\u00e0\u00a5\u008d\u00e0\u00a4\u02dc\u00e0\u00a4\u00be\u00e0\u00a4\u00af\u00e0\u00a5\u0081\u00e0\u00a4\u00b7\u00e0\u00a5\u20ac \u00e0\u00a4\u2020\u00e0\u00a4\u00a3\u00e0\u00a4\u00bf \u00e0\u00a4\u2020\u00e0\u00a4\u00a8\u00e0\u00a4\u201a\u00e0\u00a4\u00a6\u00e0\u00a5\u20ac \u00e0\u00a4\u0153\u00e0\u00a5\u20ac\u00e0\u00a4\u00b5\u00e0\u00a4\u00a8\u00e0\u00a4\u00be\u00e0\u00a4\u0161\u00e0\u00a5\u2021 \u00e0\u00a4\u0153\u00e0\u00a4\u00aa\u00e0\u00a4\u00be\u00e0\u00a4\u00a8\u00e0\u00a5\u20ac \u00e0\u00a4\u00b0\u00e0\u00a4\u00b9\u00e0\u00a4\u00b8\u00e0\u00a5\u008d\u00e0\u00a4\u00af, \u00e0\u00a4\u02c6\u00e0\u00a4\u2022\u00e0\u00a4\u00bf\u00e0\u00a4\u2014\u00e0\u00a4\u00be\u00e0\u00a4\u02c6 \u00e0\u00a4\u00ae\u00e0\u00a4\u00b0\u00e0, Author: Ken Mogi, Category: Parenting, Family & Health, Price: \u20b9N/A\n6. Title: Ikigai (Hindi) Art of staying Young.. while growing Old, Author: Hector Garcia, Francess Mirellas, Category: General, Price: \u20b9N/A\n7. Title: Ikigai, Author: Francesc Miralles, Category: Oriental & indian philosophy, Price: \u20b9N/A\n8. Title: The Ikigai Journey : A Practical Guide t, Author: Garcia, Hector|Francesc Miralles, Category: Parenting, Family & Health, Price: \u20b9N/A\n9. Title: Ikigai, Author: Hector Garcia, Category: Assertiveness, motivation & self-esteem, Price: \u20b9N/A\n10. Title: Ikigai (&#2311;&#2325;&#2367;&#2327;&#2366;&#2312;), Author: Keira Miki, Category: Assertiveness, motivation & self-esteem, Price: \u20b9N/A\n11. Title: Ikigai : The Japanese Art of Living in Gujarati (\u00e0\u00aa\u2021\u00e0\u00aa\u2022\u00e0\u00ab\u20ac\u00e0\u00aa\u2014\u00e0\u00aa\u00be\u00e0\u00aa\u2021), Author: Keira Miki, Category: Parenting, Family & Health, Price: \u20b9N/A\n12. Title: Ikigai, Author: Raj Goswami, Category: Modern & contemporary fiction, Price: \u20b9N/A\n13. Title: Ikigai, Author: Keira Miki, Category: Assertiveness, motivation & self-esteem, Price: \u20b9N/A\n14. Title: My Little Ikigai Journal, Author: Amanda Kudo, Category: Assertiveness, motivation & self-esteem, Price: \u20b9N/A\n15. Title: Ikigai, Author: Keira Miki, Category: Self Help & Personal Development, Price: \u20b9N/A \n\n**Strict Output Format:** \nReturn ONLY the book numbers (e.g., 1, 2, 5) of the most relevant books in a JSON array format like: \n[1, 2, 5] \nIf absolutely no books are even remotely relevant, you can return an empty array: [] \nDo not include any other text, markdown, or comments."}], "temperature": 0.3, "stream": false, "max_tokens": 100}
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Received raw response from DeepSeek for filtering. Response: [1, 2, 9, 15]
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Filtered Indices (0-based): [0, 1, 8, 14]
app.py:chat: Request: User query: 'is ikigai good for self help', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'is ikigai good for self help', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Crucial Rule for Accuracy: You MUST correct obvious spelling errors in user queries before generating the SQL.** For example, if a user asks for 'ancient rone', you must recognize this as a typo for 'ancient rome' and generate the query using the corrected term (e.g., `WHERE Product_Title LIKE '%ancient%rome%'`). Failing to correct typos will lead to no results and a bad user experience.\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n- **Handle author initials with precision.** If a user searches for an author with initials typed without dots (e.g., \"HC Verma\", \"JRR Tolkien\"), you MUST reformat them by inserting a dot `.` between each initial letter in the `LIKE` clause. For example, a search for \"HC Verma\" should generate a clause like `WHERE AuthorName1 LIKE '%H.C%Verma%'`. This ensures you find authors formatted as 'H.C. Verma' or 'H.C Verma' without incorrectly matching other names. \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- **Crucial Rule:** If a user specifies a category AND a related topic (e.g., \"science fiction books about space exploration\"), you MUST combine them with an `OR` to broaden the search. The query should look for books that are either in the category OR match the topic in the title. For example: `WHERE (Category_Name LIKE '%Science Fiction%' OR Product_Title LIKE '%space%exploration%')`. Using `AND` for this is too restrictive and will return poor results.\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: is ikigai good for self help"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (Product_Title LIKE '%ikigai%' OR Category_Name LIKE '%Self-Help%') AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2894
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'is ikigai good for self help'. Current cache size: 2
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 7.5324 seconds.
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Sending book filtering query to DeepSeek. User Query: 'is ikigai good for self help', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "The user asked: \"is ikigai good for self help\" \nBelow is a list of books retrieved from a database. Each book is prefixed with its 1-based number.\nYour task is to act as a helpful librarian and choose the book numbers that are the **most relevant** to what the user is looking for. \n**Key Filtering Rules:** \n- Prioritize books that seem most relevant based on the title, author, and category. \n- Consider semantic relevance and user intent. \n- **It is better to return a few closely related books than to return an empty list.** If there are no perfect matches, select the books that are the next best fit. \n\nBook list (Book Number. Title: ..., Author: ..., Category: ..., Price: ...): \n1. Title: Ikigai, Author: Francesc Miralles, Category: Oriental & indian philosophy, Price: \u20b9N/A\n2. Title: Ikigai, Author: Francesc Miralles, Category: Assertiveness, motivation & self-esteem, Price: \u20b9N/A\n3. Title: Ikigai (Hindi), Author: H\u00e9ctor Garc\u00eda, Francesc Miralles, Category: General, Price: \u20b9N/A\n4. Title: Ikigai, Author: Keira Miki, Category: Modern & contemporary fiction, Price: \u20b9N/A\n5. Title: Ikigai / \u00e0\u00a4\u2021\u00e0\u00a4\u2022\u00e0\u00a4\u00bf\u00e0\u00a4\u2014\u00e0\u00a4\u00be\u00e0\u00a4\u02c6 : The Japanese secret to a long and happy life in Marathi Book \u00e0\u00a4\u02c6\u00e0\u00a4\u2022\u00e0\u00a5\u20ac\u00e0\u00a4\u2014\u00e0\u00a4\u00be\u00e0\u00a4\u02c6 \u00e0\u00a4\u00a6\u00e0\u00a5\u20ac\u00e0\u00a4\u00b0\u00e0\u00a5\u008d\u00e0\u00a4\u02dc\u00e0\u00a4\u00be\u00e0\u00a4\u00af\u00e0\u00a5\u0081\u00e0\u00a4\u00b7\u00e0\u00a5\u20ac \u00e0\u00a4\u2020\u00e0\u00a4\u00a3\u00e0\u00a4\u00bf \u00e0\u00a4\u2020\u00e0\u00a4\u00a8\u00e0\u00a4\u201a\u00e0\u00a4\u00a6\u00e0\u00a5\u20ac \u00e0\u00a4\u0153\u00e0\u00a5\u20ac\u00e0\u00a4\u00b5\u00e0\u00a4\u00a8\u00e0\u00a4\u00be\u00e0\u00a4\u0161\u00e0\u00a5\u2021 \u00e0\u00a4\u0153\u00e0\u00a4\u00aa\u00e0\u00a4\u00be\u00e0\u00a4\u00a8\u00e0\u00a5\u20ac \u00e0\u00a4\u00b0\u00e0\u00a4\u00b9\u00e0\u00a4\u00b8\u00e0\u00a5\u008d\u00e0\u00a4\u00af, \u00e0\u00a4\u02c6\u00e0\u00a4\u2022\u00e0\u00a4\u00bf\u00e0\u00a4\u2014\u00e0\u00a4\u00be\u00e0\u00a4\u02c6 \u00e0\u00a4\u00ae\u00e0\u00a4\u00b0\u00e0, Author: Ken Mogi, Category: Parenting, Family & Health, Price: \u20b9N/A\n6. Title: Ikigai (Hindi) Art of staying Young.. while growing Old, Author: Hector Garcia, Francess Mirellas, Category: General, Price: \u20b9N/A\n7. Title: Ikigai, Author: Francesc Miralles, Category: Oriental & indian philosophy, Price: \u20b9N/A\n8. Title: The Ikigai Journey : A Practical Guide t, Author: Garcia, Hector|Francesc Miralles, Category: Parenting, Family & Health, Price: \u20b9N/A\n9. Title: Ikigai, Author: Hector Garcia, Category: Assertiveness, motivation & self-esteem, Price: \u20b9N/A\n10. Title: Ikigai (&#2311;&#2325;&#2367;&#2327;&#2366;&#2312;), Author: Keira Miki, Category: Assertiveness, motivation & self-esteem, Price: \u20b9N/A\n11. Title: Ikigai : The Japanese Art of Living in Gujarati (\u00e0\u00aa\u2021\u00e0\u00aa\u2022\u00e0\u00ab\u20ac\u00e0\u00aa\u2014\u00e0\u00aa\u00be\u00e0\u00aa\u2021), Author: Keira Miki, Category: Parenting, Family & Health, Price: \u20b9N/A\n12. Title: Ikigai, Author: Raj Goswami, Category: Modern & contemporary fiction, Price: \u20b9N/A\n13. Title: Ikigai, Author: Keira Miki, Category: Assertiveness, motivation & self-esteem, Price: \u20b9N/A\n14. Title: My Little Ikigai Journal, Author: Amanda Kudo, Category: Assertiveness, motivation & self-esteem, Price: \u20b9N/A\n15. Title: Ikigai, Author: Keira Miki, Category: Self Help & Personal Development, Price: \u20b9N/A \n\n**Strict Output Format:** \nReturn ONLY the book numbers (e.g., 1, 2, 5) of the most relevant books in a JSON array format like: \n[1, 2, 5] \nIf absolutely no books are even remotely relevant, you can return an empty array: [] \nDo not include any other text, markdown, or comments."}], "temperature": 0.3, "stream": false, "max_tokens": 100}
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Received raw response from DeepSeek for filtering. Response: [1, 2, 9, 15]
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Filtered Indices (0-based): [0, 1, 8, 14]
app.py:chat: Request: User query: 'is ikigai good for self help', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Cache hit for user query: 'is ikigai good for self help'.
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Cache hit for user query: 'is ikigai good for self help'.
app.py:chat: Request: User query: 'is atomic habits good for self help', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'is atomic habits good for self help', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Crucial Rule for Accuracy: You MUST correct obvious spelling errors in user queries before generating the SQL.** For example, if a user asks for 'ancient rone', you must recognize this as a typo for 'ancient rome' and generate the query using the corrected term (e.g., `WHERE Product_Title LIKE '%ancient%rome%'`). Failing to correct typos will lead to no results and a bad user experience.\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n- **Handle author initials with precision.** If a user searches for an author with initials typed without dots (e.g., \"HC Verma\", \"JRR Tolkien\"), you MUST reformat them by inserting a dot `.` between each initial letter in the `LIKE` clause. For example, a search for \"HC Verma\" should generate a clause like `WHERE AuthorName1 LIKE '%H.C%Verma%'`. This ensures you find authors formatted as 'H.C. Verma' or 'H.C Verma' without incorrectly matching other names. \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- **Crucial Rule:** If a user specifies a category AND a related topic (e.g., \"science fiction books about space exploration\"), you MUST combine them with an `OR` to broaden the search. The query should look for books that are either in the category OR match the topic in the title. For example: `WHERE (Category_Name LIKE '%Science Fiction%' OR Product_Title LIKE '%space%exploration%')`. Using `AND` for this is too restrictive and will return poor results.\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: is atomic habits good for self help"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (Category_Name LIKE '%Self-Help%' OR Product_Title LIKE '%atomic%habits%') AND Availability = 'Available' ORDER BY Ranking ASC;, Tokens Used: 2892
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'is atomic habits good for self help'. Current cache size: 3
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 7.4532 seconds.
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Sending book filtering query to DeepSeek. User Query: 'is atomic habits good for self help', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "The user asked: \"is atomic habits good for self help\" \nBelow is a list of books retrieved from a database. Each book is prefixed with its 1-based number.\nYour task is to act as a helpful librarian and choose the book numbers that are the **most relevant** to what the user is looking for. \n**Key Filtering Rules:** \n- Prioritize books that seem most relevant based on the title, author, and category. \n- Consider semantic relevance and user intent. \n- **It is better to return a few closely related books than to return an empty list.** If there are no perfect matches, select the books that are the next best fit. \n\nBook list (Book Number. Title: ..., Author: ..., Category: ..., Price: ...): \n1. Title: Atomic Habits, Author: James Clear, Category: Self Help & Personal Development, Price: \u20b9N/A\n2. Title: Atomic Habits (Punjabi), Author: James Clear, Category: General, Price: \u20b9N/A\n3. Title: Atomic Habits, Author: James Clear, Category: General, Price: \u20b9N/A\n4. Title: Atomic Habits (Kannada), Author: James Clear, Category: Parenting, Family & Health, Price: \u20b9N/A\n5. Title: Atomic Habits, Author: NA, Category: General, Price: \u20b9N/A\n6. Title: Teenagers' Guide to Success : 7 Great Ways To Empower Self-Belief, Reduce Stress And Anxiety, Build Atomic Habits, And Reap The Best Of Life., Author: Pradip N Das, Category: General, Price: \u20b9N/A\n7. Title: ATOMIC ATTENTION : Learn how to focus on the task at hand, recognizing triggers that threaten to distract you and improving your attention span by developing better focus habits., Author: Dr. Amit Das, Category: Business & Economics, Price: \u20b9N/A\n8. Title: Atomic Practices For Inner Peace : Small Habits, Significant Results, Author: Harish Shivagari, Category: General, Price: \u20b9N/A \n\n**Strict Output Format:** \nReturn ONLY the book numbers (e.g., 1, 2, 5) of the most relevant books in a JSON array format like: \n[1, 2, 5] \nIf absolutely no books are even remotely relevant, you can return an empty array: [] \nDo not include any other text, markdown, or comments."}], "temperature": 0.3, "stream": false, "max_tokens": 100}
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Received raw response from DeepSeek for filtering. Response: [1, 6, 7, 8]
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Filtered Indices (0-based): [0, 5, 6, 7]
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'hey', AI-detected intent: general_faq
2025-07-24 15:47:18,355 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-24 15:47:18,356 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'hey' with keywords: ('hey',)
2025-07-24 15:47:18,384 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 14 matching FAQs for query: 'hey' (keywords: ('hey',))
app.py:chat: Request: Bot response: Hello! I'm Vidya, your helpful assistant from Bookswagon. How can I assist you with your book-related queries today?
app.py:chat: Request: User query: 'is harry potter a good book for a 10 year old?', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'is harry potter a good book for a 10 year old?', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Crucial Rule for Accuracy: You MUST correct obvious spelling errors in user queries before generating the SQL.** For example, if a user asks for 'ancient rone', you must recognize this as a typo for 'ancient rome' and generate the query using the corrected term (e.g., `WHERE Product_Title LIKE '%ancient%rome%'`). Failing to correct typos will lead to no results and a bad user experience.\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n- **Handle author initials with precision.** If a user searches for an author with initials typed without dots (e.g., \"HC Verma\", \"JRR Tolkien\"), you MUST reformat them by inserting a dot `.` between each initial letter in the `LIKE` clause. For example, a search for \"HC Verma\" should generate a clause like `WHERE AuthorName1 LIKE '%H.C%Verma%'`. This ensures you find authors formatted as 'H.C. Verma' or 'H.C Verma' without incorrectly matching other names. \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- **Crucial Rule:** If a user specifies a category AND a related topic (e.g., \"science fiction books about space exploration\"), you MUST combine them with an `OR` to broaden the search. The query should look for books that are either in the category OR match the topic in the title. For example: `WHERE (Category_Name LIKE '%Science Fiction%' OR Product_Title LIKE '%space%exploration%')`. Using `AND` for this is too restrictive and will return poor results.\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: is harry potter a good book for a 10 year old?"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (Category_Name LIKE '%Children%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%Harry%Potter%') AND Availability = 'Available' ORDER BY Ranking ASC;, Tokens Used: 2907
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'is harry potter a good book for a 10 year old?'. Current cache size: 1
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 6.9108 seconds.
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'i want to read harry potter', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'i want to read harry potter', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Crucial Rule for Accuracy: You MUST correct obvious spelling errors in user queries before generating the SQL.** For example, if a user asks for 'ancient rone', you must recognize this as a typo for 'ancient rome' and generate the query using the corrected term (e.g., `WHERE Product_Title LIKE '%ancient%rome%'`). Failing to correct typos will lead to no results and a bad user experience.\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n- **Handle author initials with precision.** If a user searches for an author with initials typed without dots (e.g., \"HC Verma\", \"JRR Tolkien\"), you MUST reformat them by inserting a dot `.` between each initial letter in the `LIKE` clause. For example, a search for \"HC Verma\" should generate a clause like `WHERE AuthorName1 LIKE '%H.C%Verma%'`. This ensures you find authors formatted as 'H.C. Verma' or 'H.C Verma' without incorrectly matching other names. \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- **Crucial Rule:** If a user specifies a category AND a related topic (e.g., \"science fiction books about space exploration\"), you MUST combine them with an `OR` to broaden the search. The query should look for books that are either in the category OR match the topic in the title. For example: `WHERE (Category_Name LIKE '%Science Fiction%' OR Product_Title LIKE '%space%exploration%')`. Using `AND` for this is too restrictive and will return poor results.\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: i want to read harry potter"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%Harry%Potter%' AND Availability = 'Available' ORDER BY Ranking ASC;, Tokens Used: 2882
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'i want to read harry potter'. Current cache size: 1
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 6.7301 seconds.
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Sending book filtering query to DeepSeek. User Query: 'i want to read harry potter', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "The user asked: \"i want to read harry potter\" \nBelow is a list of books retrieved from a database. Each book is prefixed with its 1-based number.\nYour task is to act as a helpful librarian and choose the book numbers that are the **most relevant** to what the user is looking for. \n**Key Filtering Rules:** \n- Prioritize books that seem most relevant based on the title, author, and category. \n- Consider semantic relevance and user intent. \n- **It is better to return a few closely related books than to return an empty list.** If there are no perfect matches, select the books that are the next best fit. \n\nBook list (Book Number. Title: ..., Author: ..., Category: ..., Price: ...): \n1. Title: Harry Potter Box Set: The Complete Collection (Children\u00e2\u20ac\u2122s Paperback), Author: J.K.Rowling, Category: Fantasy & magical realism (children\u2019s/ya), Price: \u20b9N/A\n2. Title: Harry Potter and the Philosopher's Stone, Author: J. K. Rowling, Category: Fantasy, Price: \u20b9N/A\n3. Title: Harry Potter 1\u20133 Box Set: A Magical Adventure Begins, Author: J. K. Rowling, Category: Modern & contemporary fiction, Price: \u20b9N/A\n4. Title: Samsara: Enter The Valley Of The Gods (\"India'S Answer To Harry Potter\"), Author: NA, Category: General, Price: \u20b9N/A\n5. Title: Harry Potter Box Set: The Complete Collection (Children\u2019s Hardback), Author: J.K.Rowling, Category: Fantasy & magical realism (children\u2019s/ya), Price: \u20b9N/A\n6. Title: Harry Potter and the Deathly Hallows, Author: J. K. Rowling, Category: Modern & contemporary fiction, Price: \u20b9N/A\n7. Title: Harry Potter and the Chamber of Secrets, Author: J. K. Rowling, Category: Fantasy, Price: \u20b9N/A\n8. Title: Harry Potter Boxed Set: The Complete Collection (Adult Paperback), Author: Au, Category: Fantasy, Price: \u20b9N/A\n9. Title: Harry Potter and the Prisoner of Azkaban, Author: J. K. Rowling, Category: Fantasy, Price: \u20b9N/A\n10. Title: Harry Potter and the Philosopher\u2019s Stone: MinaLima Edition, Author: J. K. Rowling, Category: Modern & contemporary fiction, Price: \u20b9N/A\n11. Title: Harry Potter Owl Post Box Set (Children\u2019s Hardback - The Complete Collection), Author: J.K. Rowling, Category: Modern & contemporary fiction, Price: \u20b9N/A\n12. Title: Harry Potter and the Goblet of Fire, Author: J. K. Rowling, Category: General fiction (children\u2019s/ya), Price: \u20b9N/A\n13. Title: HARRY POTTER AND THE ORDER OF THE PHOENIX - 5, Author: J. K. Rowling, Category: Fantasy, Price: \u20b9N/A\n14. Title: Harry Potter and the Prisoner of Azkaban: MinaLima Edition, Author: J.K. Rowling, Category: Adventure stories (children\u2019s/ya), Price: \u20b9N/A\n15. Title: The Harry Potter Wizarding Almanac, Author: Levi Pinfold, Category: Modern & contemporary fiction, Price: \u20b9N/A \n\n**Strict Output Format:** \nReturn ONLY the book numbers (e.g., 1, 2, 5) of the most relevant books in a JSON array format like: \n[1, 2, 5] \nIf absolutely no books are even remotely relevant, you can return an empty array: [] \nDo not include any other text, markdown, or comments."}], "temperature": 0.3, "stream": false, "max_tokens": 100}
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Received raw response from DeepSeek for filtering. Response: [1, 2, 3, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14]
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Filtered Indices (0-based): [0, 1, 2, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13]
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'hey how are you', AI-detected intent: general_faq
2025-07-24 16:02:37,962 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-24 16:02:37,963 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'hey how are you' with keywords: ('are', 'hey', 'how', 'you')
2025-07-24 16:02:38,015 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 923 matching FAQs for query: 'hey how are you' (keywords: ('are', 'hey', 'how', 'you'))
app.py:chat: Request: Bot response: I'm just like a well-loved bookalways ready to help and full of stories! How can I assist you with your Bookswagon queries today?
app.py:chat: Request: User query: 'hey how are y', AI-detected intent: general_faq
2025-07-24 16:03:03,815 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-24 16:03:03,816 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'hey how are y' with keywords: ('are', 'hey', 'how', 'y')
2025-07-24 16:03:03,873 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 1067 matching FAQs for query: 'hey how are y' (keywords: ('are', 'hey', 'how', 'y'))
app.py:chat: Request: Bot response: I'm just a virtual page in the grand library of Bookswagon, always ready to assist with your bookish needs! Speaking of which, how may I help you with your Bookswagon queries today?
app.py:chat: Request: User query: 'how are you', AI-detected intent: general_faq
2025-07-24 16:03:47,919 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-24 16:03:47,919 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'how are you' with keywords: ('are', 'how', 'you')
2025-07-24 16:03:47,971 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 919 matching FAQs for query: 'how are you' (keywords: ('are', 'how', 'you'))
app.py:chat: Request: Bot response: Ah, I'm always doing well when surrounded by books and helping fellow book lovers like you! Speaking of which, is there anything Bookswagon-related I can assist you with today? Perhaps tracking an order or finding a specific title?
app.py:chat: Request: User query: 'how are you', AI-detected intent: general_faq
app.py:chat: Request: Bot response: Ah, I'm as lively as a freshly opened book on a quiet morning! Ready to dive into any Bookswagon query you havewhether it's about orders, deliveries, or finding that perfect read. How can I assist you today?
app.py:chat: Request: User query: 'hey what up\', AI-detected intent: general_faq
2025-07-24 16:11:46,911 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-24 16:11:46,911 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'hey what up\' with keywords: ('hey', 'up\\', 'what')
2025-07-24 16:11:47,038 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 225 matching FAQs for query: 'hey what up\' (keywords: ('hey', 'up\\', 'what'))
app.py:chat: Request: Bot response: Hello there! I'm Vidya, your friendly bookstore assistant, always surrounded by stacks of fascinating books. How can I help you with your Bookswagon queries today? Looking for a specific title or need assistance with an order? Let me know!
app.py:chat: Request: User query: 'how are you', AI-detected intent: general_faq
app.py:chat: Request: Bot response: I'm doing wonderfully, thank you for asking! My shelves are virtually stocked with knowledge, and I'm always eager to help you find the perfect book or assist with any Bookswagon-related queries. How may I assist you today?
app.py:chat: Request: User query: 'how are you', AI-detected intent: general_faq
app.py:chat: Request: Bot response: Ah, thank you for asking! I'm currently immersed in the quiet hum of a well-stocked bookstorefiguratively speaking, of course. My shelves are always full of answers, waiting to be discovered. How may I assist you with Bookswagon today?
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'want to read books by dostoievski', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'want to read books by dostoievski', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Crucial Rule for Accuracy: You MUST correct obvious spelling errors in user queries before generating the SQL.** For example, if a user asks for 'ancient rone', you must recognize this as a typo for 'ancient rome' and generate the query using the corrected term (e.g., `WHERE Product_Title LIKE '%ancient%rome%'`). Failing to correct typos will lead to no results and a bad user experience.\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n- **Handle author initials with precision.** If a user searches for an author with initials typed without dots (e.g., \"HC Verma\", \"JRR Tolkien\"), you MUST reformat them by inserting a dot `.` between each initial letter in the `LIKE` clause. For example, a search for \"HC Verma\" should generate a clause like `WHERE AuthorName1 LIKE '%H.C%Verma%'`. This ensures you find authors formatted as 'H.C. Verma' or 'H.C Verma' without incorrectly matching other names. \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- **Crucial Rule:** If a user specifies a category AND a related topic (e.g., \"science fiction books about space exploration\"), you MUST combine them with an `OR` to broaden the search. The query should look for books that are either in the category OR match the topic in the title. For example: `WHERE (Category_Name LIKE '%Science Fiction%' OR Product_Title LIKE '%space%exploration%')`. Using `AND` for this is too restrictive and will return poor results.\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: want to read books by dostoievski"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Dostoevsky%' AND Availability = 'Available' ORDER BY Ranking ASC;, Tokens Used: 2884
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'want to read books by dostoievski'. Current cache size: 1
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 5.3893 seconds.
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Sending book filtering query to DeepSeek. User Query: 'want to read books by dostoievski', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "The user asked: \"want to read books by dostoievski\" \nBelow is a list of books retrieved from a database. Each book is prefixed with its 1-based number.\nYour task is to act as a helpful librarian and choose the book numbers that are the **most relevant** to what the user is looking for. \n**Key Filtering Rules:** \n- Prioritize books that seem most relevant based on the title, author, and category. \n- Consider semantic relevance and user intent. \n- **It is better to return a few closely related books than to return an empty list.** If there are no perfect matches, select the books that are the next best fit. \n\nBook list (Book Number. Title: ..., Author: ..., Category: ..., Price: ...): \n1. Title: The Originals Crime and Punishment, Author:  Fyodor Dostoevsky, Category: Crime & mystery, Price: \u20b9N/A\n2. Title: Crime And Punishment, Author:  Fyodor Dostoevsky, Category: Crime & mystery, Price: \u20b9N/A\n3. Title: Greatest Short Stories of Dostoevsky, Author:  Fyodor Dostoevsky, Category: Literary studies: general, Price: \u20b9N/A\n4. Title: The Originals: The Brothers Karamazov, Author:  Fyodor Dostoevsky, Category: Crime & mystery, Price: \u20b9N/A\n5. Title: Best of Dostoevsky Boxed Set, Author:  Fyodor Dostoevsky, Category: Classic fiction, Price: \u20b9N/A\n6. Title: Crime and Punishment, Author:  Fyodor Dostoevsky, Category: Classic fiction, Price: \u20b9N/A\n7. Title: The Originals The Idiot, Author:  Fyodor Dostoevsky, Category: Crime & mystery, Price: \u20b9N/A\n8. Title: Crime and Punishment, Author: Fyodor M. Dostoevsky, Category: Classic fiction, Price: \u20b9N/A\n9. Title: The Devils, Author: Fyodor Dostoevsky, Category: Classic fiction, Price: \u20b9N/A\n10. Title: Crime and Punishment, Author: Dostoevsky, Category: General, Price: \u20b9N/A\n11. Title: The Brothers Karamazov, Author: Fyodor Dostoevsky, Category: Classic fiction, Price: \u20b9N/A\n12. Title: The Dream of a Ridiculous Man, Author: Fyodor Dostoevsky, Translator: Constance Garnett, Category: General, Price: \u20b9N/A\n13. Title: Poor Folk, Author: Fyodor Dostoevsky, Category: Children & Teens, Price: \u20b9N/A\n14. Title: Russian Classics - Best Short Stories in Telugu, Author: Anton Chekhov|Fyodor Dostoevsky|Aleksandr Kuprin, Category: General, Price: \u20b9N/A\n15. Title: The Dream of a Ridiculous Man [Hardcover], Author: Fyodor Dostoevsky, Translator: Constance Garnett, Category: General, Price: \u20b9N/A \n\n**Strict Output Format:** \nReturn ONLY the book numbers (e.g., 1, 2, 5) of the most relevant books in a JSON array format like: \n[1, 2, 5] \nIf absolutely no books are even remotely relevant, you can return an empty array: [] \nDo not include any other text, markdown, or comments."}], "temperature": 0.3, "stream": false, "max_tokens": 100}
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Received raw response from DeepSeek for filtering. Response: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 15]
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Filtered Indices (0-based): [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 14]
app.py:index: Request: Index page loaded.
app.py:chat: Request: User query: 'hi', AI-detected intent: general_faq
2025-07-25 17:41:55,994 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-25 17:41:55,995 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'hi' with keywords: ('hi',)
2025-07-25 17:41:56,051 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 219 matching FAQs for query: 'hi' (keywords: ('hi',))
app.py:chat: Request: Bot response: Hello! I'm Vidya, your friendly bookstore assistant. How can I assist you with your Bookswagon-related queries today? Whether it's about books, orders, or anything else, I'm here to help. Let me know what you need!
app.py:chat: Request: User query: 'i want to know my order status', AI-detected intent: order
app.py:chat: Request: Bot response: LOGIN_REQUIRED: Please log in to view your order details.
app.py:chat: Request: User query: 'want to read harry potter', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'want to read harry potter', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Crucial Rule for Accuracy: You MUST correct obvious spelling errors in user queries before generating the SQL.** For example, if a user asks for 'ancient rone', you must recognize this as a typo for 'ancient rome' and generate the query using the corrected term (e.g., `WHERE Product_Title LIKE '%ancient%rome%'`). Failing to correct typos will lead to no results and a bad user experience.\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n- **Handle author initials with precision.** If a user searches for an author with initials typed without dots (e.g., \"HC Verma\", \"JRR Tolkien\"), you MUST reformat them by inserting a dot `.` between each initial letter in the `LIKE` clause. For example, a search for \"HC Verma\" should generate a clause like `WHERE AuthorName1 LIKE '%H.C%Verma%'`. This ensures you find authors formatted as 'H.C. Verma' or 'H.C Verma' without incorrectly matching other names. \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- **Crucial Rule:** If a user specifies a category AND a related topic (e.g., \"science fiction books about space exploration\"), you MUST combine them with an `OR` to broaden the search. The query should look for books that are either in the category OR match the topic in the title. For example: `WHERE (Category_Name LIKE '%Science Fiction%' OR Product_Title LIKE '%space%exploration%')`. Using `AND` for this is too restrictive and will return poor results.\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: want to read harry potter"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%Harry%Potter%' AND Availability = 'Available' ORDER BY Ranking ASC;, Tokens Used: 2881
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'want to read harry potter'. Current cache size: 2
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 6.7182 seconds.
app.py:chat: Request: User query: 'what is my website url', AI-detected intent: general_faq
2025-07-25 18:01:25,379 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-25 18:01:25,380 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'what is my website url' with keywords: ('is', 'my', 'url', 'website', 'what')
2025-07-25 18:01:25,447 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 607 matching FAQs for query: 'what is my website url' (keywords: ('is', 'my', 'url', 'website', 'what'))
app.py:chat: Request: Bot response: The official website URL for Bookswagon is bookswagon.com. You can visit this site to browse books, place orders, or check your account details. 

Let me know if you need any further assistance.
app.py:chat: Request: User query: 'what is my order status', AI-detected intent: order
app.py:chat: Request: Bot response: LOGIN_REQUIRED: Please log in to view your order details.
app.py:chat: Request: User query: 'what is my freind order status', AI-detected intent: order
app.py:chat: Request: Bot response: LOGIN_REQUIRED: Please log in to view your order details.
app.py:chat: Request: User query: 'how is possible to see someone's order by loggin in with my credentials?', AI-detected intent: order
app.py:chat: Request: Bot response: LOGIN_REQUIRED: Please log in to view your order details.
app.py:chat: Request: Bot response: 

Still fetching your books... but I ran into a snag searching the shelf. Try again soon?
app.py:chat: Request: User query: 'hi', AI-detected intent: general_faq
app.py:chat: Request: Bot response: Hello! I'm Vidya, your friendly bookstore assistant. How can I assist you with your Bookswagon-related queries today? Whether it's about orders, shipping, or book availability, I'm here to help. Let me know what you need!
app.py:chat: Request: User query: 'hi', AI-detected intent: general_faq
app.py:chat: Request: Bot response: Hello again! I'm Vidya, your ever-helpful bookstore guide. I'd be delighted to assist you with anything related to Bookswagon - whether you're curious about our book collections, need help with an order, or have any other questions about our services. What can I help you with today?
app.py:chat: Request: User query: 'hi', AI-detected intent: general_faq
app.py:chat: Request: Bot response: Hello! I'm Vidya, your friendly bookstore assistant. How can I help you with your Bookswagon inquiries today? Whether it's about book availability, orders, or anything else, I'm here to assist. Let me know what you need!
app.py:chat: Request: User query: 'Hi', AI-detected intent: general_faq
2025-07-25 18:52:21,410 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-25 18:52:21,411 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'Hi' with keywords: ('hi',)
2025-07-25 18:52:21,444 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 219 matching FAQs for query: 'Hi' (keywords: ('hi',))
app.py:chat: Request: Bot response: Hello again! I'm Vidya, your helpful guide to all things Bookswagon. Are you looking for information about a specific book, need help with an order, or have any other questions about our services? Let me know how I can assist you today.
app.py:chat: Request: User query: 'Hi', AI-detected intent: general_faq
app.py:chat: Request: Bot response: Hello! I'm Vidya, your friendly bookstore assistant. Between helping customers and browsing new arrivals, I'm always surrounded by stories. How can I assist you with your Bookswagon inquiry today?
app.py:chat: Request: User query: 'Hi', AI-detected intent: general_faq
app.py:chat: Request: Bot response: Hello again! It's lovely to connect with a fellow book lover. Whether you're looking for information about an order, our services, or just browsing, I'm here to help. What can I assist you with today?
app.py:chat: Request: User query: 'hi', AI-detected intent: general_faq
app.py:chat: Request: Bot response: Hello! Welcome to Bookswagon. How can I assist you today? Whether it's about book availability, orders, or anything else, feel free to ask.
app.py:chat: Request: User query: 'suggest me 2 books of 2025', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'suggest me 2 books of 2025', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Crucial Rule for Accuracy: You MUST correct obvious spelling errors in user queries before generating the SQL.** For example, if a user asks for 'ancient rone', you must recognize this as a typo for 'ancient rome' and generate the query using the corrected term (e.g., `WHERE Product_Title LIKE '%ancient%rome%'`). Failing to correct typos will lead to no results and a bad user experience.\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n- **Handle author initials with precision.** If a user searches for an author with initials typed without dots (e.g., \"HC Verma\", \"JRR Tolkien\"), you MUST reformat them by inserting a dot `.` between each initial letter in the `LIKE` clause. For example, a search for \"HC Verma\" should generate a clause like `WHERE AuthorName1 LIKE '%H.C%Verma%'`. This ensures you find authors formatted as 'H.C. Verma' or 'H.C Verma' without incorrectly matching other names. \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- **Crucial Rule:** If a user specifies a category AND a related topic (e.g., \"science fiction books about space exploration\"), you MUST combine them with an `OR` to broaden the search. The query should look for books that are either in the category OR match the topic in the title. For example: `WHERE (Category_Name LIKE '%Science Fiction%' OR Product_Title LIKE '%space%exploration%')`. Using `AND` for this is too restrictive and will return poor results.\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: suggest me 2 books of 2025"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 2 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE YEAR(TRY_CONVERT(DATE, PublicationDate, 101)) = 2025 AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2892
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'suggest me 2 books of 2025'. Current cache size: 3
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 5.1426 seconds.
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Sending book filtering query to DeepSeek. User Query: 'suggest me 2 books of 2025', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "The user asked: \"suggest me 2 books of 2025\" \nBelow is a list of books retrieved from a database. Each book is prefixed with its 1-based number.\nYour task is to act as a helpful librarian and choose the book numbers that are the **most relevant** to what the user is looking for. \n**Key Filtering Rules:** \n- Prioritize books that seem most relevant based on the title, author, and category. \n- Consider semantic relevance and user intent. \n- **It is better to return a few closely related books than to return an empty list.** If there are no perfect matches, select the books that are the next best fit. \n\nBook list (Book Number. Title: ..., Author: ..., Category: ..., Price: ...): \n1. Title: Too Good to Be True : A smart, funny will-they-won\u00e2\u20ac\u2122t-they romance by mostlysane, Author: Prajakta Koli, Category: Family & relationships, Price: \u20b9N/A\n2. Title: King of Envy, Author: Ana Huang, Category: Adult & contemporary romance, Price: \u20b9N/A \n\n**Strict Output Format:** \nReturn ONLY the book numbers (e.g., 1, 2, 5) of the most relevant books in a JSON array format like: \n[1, 2, 5] \nIf absolutely no books are even remotely relevant, you can return an empty array: [] \nDo not include any other text, markdown, or comments."}], "temperature": 0.3, "stream": false, "max_tokens": 100}
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Received raw response from DeepSeek for filtering. Response: [1, 2]
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Filtered Indices (0-based): [0, 1]
app.py:chat: Request: User query: 'suggest me 2 books of 2025', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Cache hit for user query: 'suggest me 2 books of 2025'.
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Cache hit for user query: 'suggest me 2 books of 2025'.
app.py:chat: Request: User query: 'Hi', AI-detected intent: general_faq
app.py:chat: Request: Bot response: Hello! I'm Vidya, your friendly bookstore assistant. I'm always surrounded by books, and today I'm helping customers find their next great read or answer any Bookswagon-related questions. How can I assist you today?
app.py:chat: Request: User query: 'hello', AI-detected intent: general_faq
2025-07-26 11:55:40,077 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-26 11:55:40,077 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'hello' with keywords: ('hello',)
2025-07-26 11:55:40,109 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 0 matching FAQs for query: 'hello' (keywords: ('hello',))
app.py:chat: Request: Bot response: Hello! I'm Vidya, your helpful Bookswagon assistant. How can I assist you today? Whether it's about an order, our services, or any book-related query, I'm here to help. Let me know what you need!
app.py:chat: Request: User query: 'hi', AI-detected intent: general_faq
app.py:chat: Request: Bot response: Hello! Welcome to Bookswagon. How can I assist you today? Whether it's about our books, orders, or services, I'm here to help. Let me know what you're looking for.
app.py:chat: Request: User query: 'give me 4 best selling fiction books', AI-detected intent: recommend_books
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'give me 4 best selling fiction books', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Crucial Rule for Accuracy: You MUST correct obvious spelling errors in user queries before generating the SQL.** For example, if a user asks for 'ancient rone', you must recognize this as a typo for 'ancient rome' and generate the query using the corrected term (e.g., `WHERE Product_Title LIKE '%ancient%rome%'`). Failing to correct typos will lead to no results and a bad user experience.\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n- **Handle author initials with precision.** If a user searches for an author with initials typed without dots (e.g., \"HC Verma\", \"JRR Tolkien\"), you MUST reformat them by inserting a dot `.` between each initial letter in the `LIKE` clause. For example, a search for \"HC Verma\" should generate a clause like `WHERE AuthorName1 LIKE '%H.C%Verma%'`. This ensures you find authors formatted as 'H.C. Verma' or 'H.C Verma' without incorrectly matching other names. \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- **Crucial Rule:** If a user specifies a category AND a related topic (e.g., \"science fiction books about space exploration\"), you MUST combine them with an `OR` to broaden the search. The query should look for books that are either in the category OR match the topic in the title. For example: `WHERE (Category_Name LIKE '%Science Fiction%' OR Product_Title LIKE '%space%exploration%')`. Using `AND` for this is too restrictive and will return poor results.\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: give me 4 best selling fiction books"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 4 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2881
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'give me 4 best selling fiction books'. Current cache size: 4
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 5.6147 seconds.
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Sending book filtering query to DeepSeek. User Query: 'give me 4 best selling fiction books', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "The user asked: \"give me 4 best selling fiction books\" \nBelow is a list of books retrieved from a database. Each book is prefixed with its 1-based number.\nYour task is to act as a helpful librarian and choose the book numbers that are the **most relevant** to what the user is looking for. \n**Key Filtering Rules:** \n- Prioritize books that seem most relevant based on the title, author, and category. \n- Consider semantic relevance and user intent. \n- **It is better to return a few closely related books than to return an empty list.** If there are no perfect matches, select the books that are the next best fit. \n\nBook list (Book Number. Title: ..., Author: ..., Category: ..., Price: ...): \n1. Title: Deewar Mein Ek Khidki Rahti Thi \u00e0\u00a5\u00a4 \u00e0\u00a4\u00a6\u00e0\u00a5\u20ac\u00e0\u00a4\u00b5\u00e0\u00a4\u00be\u00e0\u00a4\u00b0 \u00e0\u00a4\u00ae\u00e0\u00a5\u2021\u00e0\u00a4\u201a \u00e0\u00a4\u008f\u00e0\u00a4\u2022 \u00e0\u00a4\u2013\u00e0\u00a4\u00bf\u00e0\u00a4\u00a1\u00e0\u00a4\u00bc\u00e0\u00a4\u2022\u00e0\u00a5\u20ac \u00e0\u00a4\u00b0\u00e0\u00a4\u00b9\u00e0\u00a4\u00a4\u00e0\u00a5\u20ac \u00e0\u00a4\u00a5\u00e0\u00a5\u20ac [ \u00e0\u00a4\u00b8\u00e0\u00a4\u00be\u00e0\u00a4\u00b9\u00e0\u00a4\u00bf\u00e0\u00a4\u00a4\u00e0\u00a5\u008d\u00e0\u00a4\u00af \u00e0\u00a4\u2026\u00e0\u00a4\u2022\u00e0\u00a4\u00be\u00e0\u00a4\u00a6\u00e0\u00a4\u00ae\u00e0\u00a5\u20ac \u00e0\u00a4\u00aa\u00e0\u00a5\u0081\u00e0\u00a4\u00b0\u00e0\u00a4\u00b8\u00e0\u00a5\u008d\u00e0\u00a4\u2022\u00e0\u00a4\u00be\u00e0\u00a4\u00b0 \u00e0\u00a4\u00b8\u00e0\u00a5\u2021 \u00e0\u00a4\u00aa\u00e0\u00a5\u0081\u00e0\u00a4\u00b0\u00e0\u00a4\u00b8\u00e0\u00a5\u008d\u00e0\u00a4\u2022\u00e0\u00a5\u0192\u00e0\u00a4\u00a4 \u00e0\u00a4\u2030\u00e0\u00a4\u00aa\u00e0\u00a4\u00a8\u00e0\u00a5\u008d\u00e0\u00a4\u00af\u00e0\u00a4\u00be\u00e0\u00a4\u00b8 ], Author: Vinod Kumar Shukla, Category: Modern & contemporary fiction, Price: \u20b9N/A\n2. Title: The Satanic Verses, Author: Salman Rushdie, Category: Modern & contemporary fiction, Price: \u20b9N/A\n3. Title: Satanic Verses, Author: Salman Rushdie, Category: Modern & contemporary fiction, Price: \u20b9N/A\n4. Title: White Nights, Author: Ronald Meyer, Category: Classic fiction, Price: \u20b9N/A \n\n**Strict Output Format:** \nReturn ONLY the book numbers (e.g., 1, 2, 5) of the most relevant books in a JSON array format like: \n[1, 2, 5] \nIf absolutely no books are even remotely relevant, you can return an empty array: [] \nDo not include any other text, markdown, or comments."}], "temperature": 0.3, "stream": false, "max_tokens": 100}
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Received raw response from DeepSeek for filtering. Response: [2, 3]
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Filtered Indices (0-based): [1, 2]
app.py:chat: Request: User query: 'Hi', AI-detected intent: general_faq
app.py:chat: Request: Bot response: Hello! I'm Vidya, your friendly bookstore assistant. I'm always surrounded by books, so I'm doing great. How can I assist you with your Bookswagon queries today?
app.py:chat: Request: User query: 'Hi', AI-detected intent: general_faq
app.py:chat: Request: Bot response: Hello! I'm Vidya, your friendly bookstore assistant. I'm always surrounded by booksreading, organizing, and helping fellow book lovers like you. How can I assist you with your Bookswagon inquiries today?
app.py:chat: Request: User query: 'Hi', AI-detected intent: general_faq
app.py:chat: Request: Bot response: Hello! I'm Vidya, your friendly bookstore assistant. How can I assist you with your Bookswagon inquiries today? Whether it's about book availability, orders, or anything else, I'm here to help. What's on your mind?
2025-07-26 14:15:34,866 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-26 14:15:34,867 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'hey whats up' with keywords: ('hey', 'up', 'whats')
2025-07-26 14:15:34,968 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 92 matching FAQs for query: 'hey whats up' (keywords: ('hey', 'up', 'whats'))
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Sending SQL generation query to DeepSeek. User Query: 'want to read harry potter', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "You are an expert SQL assistant for a book recommendation system.\nGenerate a SQL Server query using the table: `Table_ProductSearchNewSearch`.\n\n**Key Constraints for SQL Generation:**\n- **Crucial Rule for Accuracy: You MUST correct obvious spelling errors in user queries before generating the SQL.** For example, if a user asks for 'ancient rone', you must recognize this as a typo for 'ancient rome' and generate the query using the corrected term (e.g., `WHERE Product_Title LIKE '%ancient%rome%'`). Failing to correct typos will lead to no results and a bad user experience.\n- **Always** include `Product_Title`, `AuthorName1`, `Category_Name`, `Product_DiscountedPrice`, `Product_TitleURl`, `ISBN13` in the `SELECT` clause.\n- **Always** use `TOP 15` in the `SELECT` statement (e.g., `SELECT TOP 15 ...`).\n- **Always** use `LIKE '%value%'` for partial string matches (e.g., `WHERE Product_Title LIKE '%meditation%'`).\n- **Combine conditions with AND** for semantic relevance (e.g., \"meditation books by specific author\" -> `WHERE Product_Title LIKE '%meditation%' AND AuthorName1 LIKE '%author%'`).\n- **Only use OR** within a single concept group (e.g., `(Product_Title LIKE '%Sci-Fi%' OR Product_Title LIKE '%Science Fiction%')`).\n- If the user asks for multiple distinct criteria that are not related, combine them with AND.\n- **Exclude** explicit keywords like \"download\" or \"PDF\" from your search terms.\n- When a user asks for books similar to a specific title, suggest comparable options and exclude the mentioned book from the results.\n- When suggesting books, prioritize top-quality, trending, or best-selling titles relevant to the category. For \"bestsellers\" or \"top-selling\" queries, *do not use WHERE clauses for ranking*; instead, rely solely on `ORDER BY Ranking ASC`.\n- Smartly infer recency for queries like \"recent\" or \"last 3 years\" and emphasize current relevance over strict release dates, excluding older books unless they remain highly significant.\n- Ignore specific keywords that refer to the platform or company name (e.g., 'bookswagon') when generating search criteria for book titles or author names.\n- If the user specifies a language (e.g., \"in Hindi\", \"English books\"), use this information to filter results by the 'Language' column (e.g., WHERE Language = 'Hindi').\n- **Always filter by availability if not explicitly contradicted**: Include `AND Availability != 'Out Of Stock'` in the `WHERE` clause unless the user specifically asks for unavailable books.\n- If the user explicitly mentions a publisher (e.g., \u201cbooks by Penguin\u201d, \u201ctitles from HarperCollins\u201d,\"books from Double 9 Books\"), filter using PublisherName LIKE '%<name>%' with Language = 'English', TOP 15, and ORDER BY Ranking ASC; otherwise, ignore the publisher\n- If the user asks for new, recent, or latest books, fetch TOP 15 ordered by Date_Created DESC (latest year first), and ignore Date_Created unless freshness is clearly requested.\n- If the user asks about discounts in percentage (e.g., \u201c30% off\u201d, \u201cbooks with 50% discount\u201d), filter using Product_discount >= <percentage>, fetch from relevant table with TOP 15, and ignore Product_discount unless discount percentage is clearly mentioned.\n- If the user asks for books related to Award Winning, Box Sets, International Bestseller, or Top New Arrivals, fetch from `Table_TopBooksData` where `TopBookType` LIKE '%<type>%', use `Product_ActualPrice` for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`; ignore this logic unless one of these phrases is clearly mentioned. Do not use `Category_Name` in this specific category.\n- For timeline queries (\"recent\", \"last 3 years\", \"published on 1998\"), infer recency or specific year. Use `PublicationDate` from `Table_ProductSearchNewSearch`. **To extract the year, use `TRY_CONVERT(DATE, PublicationDate, <style_code>)` or `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>))` and try common SQL Server date style codes (e.g., 101, 103, 106, 120, etc.) to robustly convert the string to a date before extracting the year.** Prioritize `PublicationDate DESC` for recency or filter by `YEAR(TRY_CONVERT(DATE, PublicationDate, <style_code>)) = <year>` for specific years.\n- **For multi-word searches in a title, you MUST separate each keyword with the SQL wildcard character `%`**. For example, if the user asks for \"Harrison principles\", the correct clause is `WHERE Product_Title LIKE '%Harrison%principles%'`, NOT `WHERE Product_Title LIKE '%Harrison principles%'`. This ensures the search isflexible and finds titles with variations like \"Harrison's Principles of Internal Medicine\".\n- **Handle author initials with precision.** If a user searches for an author with initials typed without dots (e.g., \"HC Verma\", \"JRR Tolkien\"), you MUST reformat them by inserting a dot `.` between each initial letter in the `LIKE` clause. For example, a search for \"HC Verma\" should generate a clause like `WHERE AuthorName1 LIKE '%H.C%Verma%'`. This ensures you find authors formatted as 'H.C. Verma' or 'H.C Verma' without incorrectly matching other names. \n\n**Crucial Update for \"New Arrivals/Latest Books\":**\n- **If the user explicitly asks for \"new arrivals\", \"new books\", \"latest books\", or similar phrases emphasizing recent additions, generate the query from `Table_TopBooksData` where `TopBookType` is 'Top New Arrivals' (e.g., `WHERE TopBookType = 'Top New Arrivals'`). For these queries, ensure `Product_ActualPrice` is used for price, `AuthorName1` for author, and construct links using `Product_TitleURl` and `ISBN13`. Do NOT use `Category_Name` and Date_Created for these specific queries.**\n\n**Handling Categories, Topics, and Price Points:**\n- If the user specifies a genre, category, or topic (e.g., \"Indian mythology\", \"science fiction\", \"history\"), prioritize filtering using `Category_Name LIKE '%<category>%'`.\n- **Crucial Rule:** If a user specifies a category AND a related topic (e.g., \"science fiction books about space exploration\"), you MUST combine them with an `OR` to broaden the search. The query should look for books that are either in the category OR match the topic in the title. For example: `WHERE (Category_Name LIKE '%Science Fiction%' OR Product_Title LIKE '%space%exploration%')`. Using `AND` for this is too restrictive and will return poor results.\n- If the user requests books \"under X rupees\" or \"less than X price\", filter using `Product_DiscountedPrice <= X` (e.g., `WHERE Product_DiscountedPrice <= 500`). Use `Product_DiscountedPrice` as the primary price filter.\n\n**Enhanced Rule for Travel and Location-Based Queries:** - **If the user asks for books related to travel, exploration, or a specific geographic location/city (e.g., \"books for Monaco travel\", \"exploring Paris\", \"guide to Rome\"), prioritize `Category_Name LIKE '%Travel%'` or `Category_Name LIKE '%Guides%'` AND `Product_Title LIKE '%<location>%'` or `Product_Title LIKE '%<location> guide%'`. \n**Strict Output Format:**\nReturn ONLY the SQL query. Do NOT include any explanations, comments, or surrounding text (like markdown backticks).\nOptionally, you can include a simple, short loading message at the very end of the response, in this exact format:\n`loading_line: \"Searching for books on [topic]...\"`\nIf no specific topic can be inferred for the loading line, omit it.\n\n**IMPROVED RULES for General and Vague Queries (Semantic Intent & Moods):** \n- **For mood-based or contextual queries (e.g., \"it's been raining heavily, suggest me some books\", \"books for a cozy evening\", \"something to read on a relaxing Sunday\", \"uplifting reads\", \"books to cheer me up\"), infer categories or themes that match the mood.**     \n* **Rainy/Cozy/Relaxing:** Suggest `Category_Name LIKE '%Fiction%' OR Category_Name LIKE '%Mystery%' OR Category_Name LIKE '%Thriller%' OR Category_Name LIKE '%Romance%' OR Category_Name LIKE '%Fantasy%' OR Product_Title LIKE '%cozy%' OR Product_Title LIKE '%comfort%' OR Product_Title LIKE '%relax%'`.     \n* **Uplifting/Cheer me up:** Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Inspiration%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%positivity%' OR Product_Title LIKE '%motivational%'`.     \n* **General recommendations based on broad context (e.g., \"suggest me books\" without specific keywords):** Prioritize bestsellers by `ORDER BY Ranking ASC` or `TOP 15` from common popular categories such as `Fiction`, `Biographies`, `History`, `Self-Help`. If no other filter applies, just use `ORDER BY Ranking ASC`. \n- **For relationship advice/self-improvement queries (e.g., \"how to keep your girl happy\", \"books on communication in relationships\", \"improving my marriage\"), focus on relevant non-fiction categories and keywords.**     \n* Suggest `Category_Name LIKE '%Self-Help%' OR Category_Name LIKE '%Relationships%' OR Category_Name LIKE '%Psychology%' OR Product_Title LIKE '%relationship%' OR Product_Title LIKE '%communication%' OR Product_Title LIKE '%marriage%' OR Product_Title LIKE '%happiness%' OR Product_Title LIKE '%love%'`. \n- **If the query contains seemingly random words or expressions (e.g., \"purple hippos flying\", \"random stuff to read\"), and no logical category or title match can be made, generate a default query for popular fiction:**     \n* `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Category_Name LIKE '%Fiction%' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n* If no categories are mentioned or inferred, default to just `ORDER BY Ranking ASC`.\n\n**NEW RULE for Multiple Publishers and Specific/Default Counts:** \n- **If the user explicitly mentions *multiple* publishers (e.g., \"double 9 and penguin publishers\", \"HarperCollins or Random House\"), generate a single query that combines the publishers using `OR` in the `PublisherName LIKE` clause. Use the *specified quantity* in the `TOP` clause if provided (e.g., \"give me 5 titles\" should result in `TOP 5`). If no quantity is specified, default to `TOP 15` for the combined results. Always include `Language = 'English'`, `AND Availability = 'Available'`, and `ORDER BY Ranking ASC` for publisher queries.**     \n    * **Example with quantity:** `SELECT TOP <quantity> Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%<publisher1>%' OR PublisherName LIKE '%<publisher2>%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`     \n    * **Example without quantity (defaults to TOP 15):** `SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE (PublisherName LIKE '%Double 9 Books%' OR PublisherName LIKE '%Harper Collins%') AND Language = 'English' AND Availability = 'Available' ORDER BY Ranking ASC;`\n \n\nExample valid output:\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%science fiction%' Order By Ranking ASC; loading_line: \"Finding amazing science fiction titles...\"\n\nExample valid output (no loading line):\nSELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_SalePrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE AuthorName1 LIKE '%Agatha Christie%' Order By Ranking ASC;\nWhen printing output do not print loading line even though I asked above\nUser Query: want to read harry potter"}], "temperature": 0.2, "stream": false, "max_tokens": 500}
deepseek1.py:get_sql_from_deepseek:     [SQL Generation] AI call took 6.7203s
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Received raw response from DeepSeek for SQL generation. Response: SELECT TOP 15 Product_Title, AuthorName1, Category_Name, Product_DiscountedPrice, Product_TitleURl, ISBN13 FROM Table_ProductSearchNewSearch WHERE Product_Title LIKE '%Harry%Potter%' AND Availability != 'Out Of Stock' ORDER BY Ranking ASC;, Tokens Used: 2883
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'want to read harry potter'. Current cache size: 1
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 6.7253 seconds.
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Sending book filtering query to DeepSeek. User Query: 'want to read harry potter', Payload: {"model": "deepseek-chat", "messages": [{"role": "user", "content": "The user asked: \"want to read harry potter\" \nBelow is a list of books retrieved from a database. Each book is prefixed with its 1-based number.\nYour task is to act as a helpful librarian and choose the book numbers that are the **most relevant** to what the user is looking for. \n**Key Filtering Rules:** \n- Prioritize books that seem most relevant based on the title, author, and category. \n- Consider semantic relevance and user intent. \n- **It is better to return a few closely related books than to return an empty list.** If there are no perfect matches, select the books that are the next best fit. \n\nBook list (Book Number. Title: ..., Author: ..., Category: ..., Price: ...): \n1. Title: Harry Potter Box Set: The Complete Collection (Children\u00e2\u20ac\u2122s Paperback), Author: J.K.Rowling, Category: Fantasy & magical realism (children\u2019s/ya), Price: \u20b9N/A\n2. Title: Harry Potter and the Philosopher's Stone, Author: J. K. Rowling, Category: Fantasy, Price: \u20b9N/A\n3. Title: Harry Potter and the Chamber of Secrets (Harry Potter, Book 2) (Minalima Edition), Author: J K ROWLING, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A\n4. Title: Harry Potter 1\u20133 Box Set: A Magical Adventure Begins, Author: J. K. Rowling, Category: Modern & contemporary fiction, Price: \u20b9N/A\n5. Title: Samsara: Enter The Valley Of The Gods (\"India'S Answer To Harry Potter\"), Author: NA, Category: General, Price: \u20b9N/A\n6. Title: Harry Potter Box Set: The Complete Collection (Children\u2019s Hardback), Author: J.K.Rowling, Category: Fantasy & magical realism (children\u2019s/ya), Price: \u20b9N/A\n7. Title: Harry Potter Golden Snitch Kit (Revised and Upgraded), Author: Donald Lemke , Category: General, Price: \u20b9N/A\n8. Title: Harry Potter Hardcover Boxed Set: Books 1-7 (Trunk), Author: J K ROWLING, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A\n9. Title: Harry Potter and the Deathly Hallows, Author: J. K. Rowling, Category: Modern & contemporary fiction, Price: \u20b9N/A\n10. Title: Harry Potter and the Chamber of Secrets, Author: J. K. Rowling, Category: Fantasy, Price: \u20b9N/A\n11. Title: Harry Potter Boxed Set: The Complete Collection (Adult Paperback), Author: Au, Category: Fantasy, Price: \u20b9N/A\n12. Title: Harry Potter and the Prisoner of Azkaban, Author: J. K. Rowling, Category: Fantasy, Price: \u20b9N/A\n13. Title: Harry Potter: The Illustrated Collection (Books 1-3 Boxed Set), Author: Jim Kay, Category: Science fiction (children\u2019s/ya), Price: \u20b9N/A\n14. Title: Harry Potter and the Philosopher\u2019s Stone: MinaLima Edition, Author: J. K. Rowling, Category: Modern & contemporary fiction, Price: \u20b9N/A\n15. Title: Harry Potter Owl Post Box Set (Children\u2019s Hardback - The Complete Collection), Author: J.K. Rowling, Category: Modern & contemporary fiction, Price: \u20b9N/A \n\n**Strict Output Format:** \nReturn ONLY the book numbers (e.g., 1, 2, 5) of the most relevant books in a JSON array format like: \n[1, 2, 5] \nIf absolutely no books are even remotely relevant, you can return an empty array: [] \nDo not include any other text, markdown, or comments."}], "temperature": 0.3, "stream": false, "max_tokens": 100}
deepseek1.py:filter_books_with_deepseek:     [AI Filtering] AI call took 5.3469s
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Received raw response from DeepSeek for filtering. Response: [1, 2, 3, 4, 6, 8, 9, 10, 12, 13, 14, 15]
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Filtered Indices (0-based): [0, 1, 2, 3, 5, 7, 8, 9, 11, 12, 13, 14]
2025-07-26 14:32:12,054 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-26 14:32:12,055 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'hey whats up' with keywords: ('hey', 'up', 'whats')
2025-07-26 14:32:12,113 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 92 matching FAQs for query: 'hey whats up' (keywords: ('hey', 'up', 'whats'))
2025-07-26 14:33:10,691 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-26 14:33:10,692 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'what are you doing' with keywords: ('are', 'doing', 'what', 'you')
2025-07-26 14:33:10,753 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 868 matching FAQs for query: 'what are you doing' (keywords: ('are', 'doing', 'what', 'you'))
2025-07-26 16:06:54,736 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-26 16:06:54,737 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'Hi' with keywords: ('hi',)
2025-07-26 16:06:54,769 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 219 matching FAQs for query: 'Hi' (keywords: ('hi',))
2025-07-26 16:33:20,606 - repositories.py:get_db - INFO - Database Connection:get_db: Database connection established.
2025-07-26 16:33:20,607 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Executing query for search: 'my name is' with keywords: ('is', 'my', 'name')
2025-07-26 16:33:20,652 - repositories.py:search_faqs - INFO - FaqRepository:search_faqs: Found 477 matching FAQs for query: 'my name is' (keywords: ('is', 'my', 'name'))
deepseek1.py:get_sql_from_deepseek:     [SQL Generation] AI call took 5.6403s
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Stored query in cache for 'show me new arrivals'. Current cache size: 1
deepseek1.py:get_sql_from_deepseek: DeepSeek:get_sql_from_deepseek: Total SQL generation process time: 5.6433 seconds.
deepseek1.py:filter_books_with_deepseek:     [AI Filtering] Filtering 11 books...
deepseek1.py:filter_books_with_deepseek:     [AI Filtering] AI call took 3.0757s
deepseek1.py:filter_books_with_deepseek: DeepSeek:filter_books_with_deepseek: Received raw response from DeepSeek for filtering. Response: [1, 2, 3, 4, 5, 6]
deepseek1.py:filter_books_with_deepseek:     [AI Filtering] AI selected 6 relevant books.
